<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.12">
<title>Transactions</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700">
<style>
/* Asciidoctor default stylesheet | MIT License | https://asciidoctor.org */
/* Uncomment @import statement to use as custom stylesheet */
/*@import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700";*/
article,aside,details,figcaption,figure,footer,header,hgroup,main,nav,section{display:block}
audio,video{display:inline-block}
audio:not([controls]){display:none;height:0}
html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}
a{background:none}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
abbr[title]{border-bottom:1px dotted}
b,strong{font-weight:bold}
dfn{font-style:italic}
hr{-moz-box-sizing:content-box;box-sizing:content-box;height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type="button"],input[type="reset"],input[type="submit"]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type="checkbox"],input[type="radio"]{box-sizing:border-box;padding:0}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,*::before,*::after{-moz-box-sizing:border-box;-webkit-box-sizing:border-box;box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;font-weight:400;font-style:normal;line-height:1;position:relative;cursor:auto;tab-size:4;word-wrap:anywhere;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
img,object,svg{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:0}
p{font-family:inherit;font-weight:400;font-size:1em;line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #dddddf;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em;height:0}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{font-size:1em;line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0;font-size:1em}
ul.square li ul,ul.circle li ul,ul.disc li ul{list-style:inherit}
ul.square{list-style-type:square}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
abbr,acronym{text-transform:uppercase;font-size:90%;color:rgba(0,0,0,.8);border-bottom:1px dotted #ddd;cursor:help}
abbr{text-transform:none}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote cite{display:block;font-size:.9375em;color:rgba(0,0,0,.6)}
blockquote cite::before{content:"\2014 \0020"}
blockquote cite a,blockquote cite a:visited{color:rgba(0,0,0,.6)}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}
table{background:#fff;margin-bottom:1.25em;border:solid 1px #dedede;word-wrap:normal}
table thead,table tfoot{background:#f7f8f7}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt{background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{line-height:1.6}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.center{margin-left:auto;margin-right:auto}
.stretch{width:100%}
.clearfix::before,.clearfix::after,.float-group::before,.float-group::after{content:" ";display:table}
.clearfix::after,.float-group::after{clear:both}
:not(pre).nobreak{word-wrap:normal}
:not(pre).nowrap{white-space:nowrap}
:not(pre).pre-wrap{white-space:pre-wrap}
:not(pre):not([class^=L])>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background:#f7f7f8;-webkit-border-radius:4px;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed}
pre{color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;line-height:1.45;text-rendering:optimizeSpeed}
pre code,pre pre{color:inherit;font-size:inherit;line-height:inherit}
pre>code{display:block}
pre.nowrap,pre.nowrap pre{white-space:pre;word-wrap:normal}
em em{font-style:normal}
strong strong{font-weight:400}
.keyseq{color:rgba(51,51,51,.8)}
kbd{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;display:inline-block;color:rgba(0,0,0,.8);font-size:.65em;line-height:1.45;background:#f7f7f7;border:1px solid #ccc;-webkit-border-radius:3px;border-radius:3px;-webkit-box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em white inset;box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em #fff inset;margin:0 .15em;padding:.2em .5em;vertical-align:middle;position:relative;top:-.1em;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menuref{color:#000}
.menuseq b:not(.caret),.menuref{font-weight:inherit}
.menuseq{word-spacing:-.02em}
.menuseq b.caret{font-size:1.25em;line-height:.8}
.menuseq i.caret{font-weight:bold;text-align:center;width:.45em}
b.button::before,b.button::after{position:relative;top:-1px;font-weight:400}
b.button::before{content:"[";padding:0 3px 0 2px}
b.button::after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin-left:auto;margin-right:auto;margin-top:0;margin-bottom:0;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header::before,#header::after,#content::before,#content::after,#footnotes::before,#footnotes::after,#footer::before,#footer::after{content:" ";display:table}
#header::after,#content::after,#footnotes::after,#footer::after{clear:both}
#content{margin-top:1.25em}
#content::before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #dddddf}
#header>h1:only-child,body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #dddddf;padding-bottom:8px}
#header .details{border-bottom:1px solid #dddddf;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:-ms-flexbox;display:-webkit-flex;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span::before{content:"\00a0\2013\00a0"}
#header .details br+span.author::before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark::before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber::after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #dddddf;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #e7e7e9;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc li{line-height:1.3334;margin-top:.3334em}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
#toc.toc2{margin-top:0!important;background:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #e7e7e9;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #e7e7e9;left:auto;right:0}}
@media screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}
#content #toc{border-style:solid;border-width:1px;border-color:#e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;-webkit-border-radius:4px;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:none;background:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:rgba(255,255,255,.8);line-height:1.44}
#content{margin-bottom:.625em}
.sect1{padding-bottom:.625em}
@media screen and (min-width:768px){#content{margin-bottom:1.25em}
.sect1{padding-bottom:1.25em}}
.sect1:last-child{padding-bottom:0}
.sect1+.sect1{border-top:1px solid #e7e7e9}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor::before,h2>a.anchor::before,h3>a.anchor::before,#toctitle>a.anchor::before,.sidebarblock>.content>.title>a.anchor::before,h4>a.anchor::before,h5>a.anchor::before,h6>a.anchor::before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
details,.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
details>summary:first-of-type{cursor:pointer;display:list-item;outline:none;margin-bottom:.75em}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock.fit-content>caption.title{white-space:nowrap;width:0}
.paragraph.lead>p,#preamble>.sectionbody>[class="paragraph"]:first-of-type p{font-size:1.21875em;line-height:1.6;color:rgba(0,0,0,.85)}
table.tableblock #preamble>.sectionbody>[class="paragraph"]:first-of-type p{font-size:inherit}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #dddddf;color:rgba(0,0,0,.6);word-wrap:anywhere}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border-style:solid;border-width:1px;border-color:#e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;-webkit-border-radius:4px;border-radius:4px}
.exampleblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child{margin-bottom:0}
.sidebarblock{border-style:solid;border-width:1px;border-color:#dbdbd6;margin-bottom:1.25em;padding:1.25em;background:#f3f3f2;-webkit-border-radius:4px;border-radius:4px}
.sidebarblock>:first-child{margin-top:0}
.sidebarblock>:last-child{margin-bottom:0}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock>.content>pre{-webkit-border-radius:4px;border-radius:4px;overflow-x:auto;padding:1em;font-size:.8125em}
@media screen and (min-width:768px){.literalblock pre,.listingblock>.content>pre{font-size:.90625em}}
@media screen and (min-width:1280px){.literalblock pre,.listingblock>.content>pre{font-size:1em}}
.literalblock pre,.listingblock>.content>pre:not(.highlight),.listingblock>.content>pre[class="highlight"],.listingblock>.content>pre[class^="highlight "]{background:#f7f7f8}
.literalblock.output pre{color:#f7f7f8;background:rgba(0,0,0,.9)}
.listingblock>.content{position:relative}
.listingblock code[data-lang]::before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:inherit;opacity:.5}
.listingblock:hover code[data-lang]::before{display:block}
.listingblock.terminal pre .command::before{content:attr(data-prompt);padding-right:.5em;color:inherit;opacity:.5}
.listingblock.terminal pre .command:not([data-prompt])::before{content:"$"}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;-webkit-border-radius:4px;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.prettyprint{background:#f7f7f8}
pre.prettyprint .linenums{line-height:1.45;margin-left:2em}
pre.prettyprint li{background:none;list-style-type:inherit;padding-left:0}
pre.prettyprint li code[data-lang]::before{opacity:1}
pre.prettyprint li:not(:first-child) code[data-lang]::before{display:none}
table.linenotable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.linenotable td[class]{color:inherit;vertical-align:top;padding:0;line-height:inherit;white-space:normal}
table.linenotable td.code{padding-left:.75em}
table.linenotable td.linenos{border-right:1px solid currentColor;opacity:.35;padding-right:.5em}
pre.pygments .lineno{border-right:1px solid currentColor;opacity:.35;display:inline-block;margin-right:.75em}
pre.pygments .lineno::before{content:"";margin-right:-.125em}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock:not(.excerpt)>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote::before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.75em;margin-right:.5ex;text-align:right}
.verseblock{margin:0 1em 1.25em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.025em;color:rgba(0,0,0,.6)}
.quoteblock.abstract blockquote::before,.quoteblock.excerpt blockquote::before,.quoteblock .quoteblock blockquote::before{display:none}
.quoteblock.abstract blockquote,.quoteblock.abstract p,.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{line-height:1.6;word-spacing:0}
.quoteblock.abstract{margin:0 1em 1.25em;display:block}
.quoteblock.abstract>.title{margin:0 0 .375em;font-size:1.15em;text-align:center}
.quoteblock.excerpt>blockquote,.quoteblock .quoteblock{padding:0 0 .25em 1em;border-left:.25em solid #dddddf}
.quoteblock.excerpt,.quoteblock .quoteblock{margin-left:0}
.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{color:inherit;font-size:1.0625rem}
.quoteblock.excerpt .attribution,.quoteblock .quoteblock .attribution{color:inherit;text-align:left;margin-right:0}
p.tableblock:last-child{margin-bottom:0}
td.tableblock>.content{margin-bottom:1.25em;word-wrap:anywhere}
td.tableblock>.content>:last-child{margin-bottom:-1.25em}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all>*>tr>*{border-width:1px}
table.grid-cols>*>tr>*{border-width:0 1px}
table.grid-rows>*>tr>*{border-width:1px 0}
table.frame-all{border-width:1px}
table.frame-ends{border-width:1px 0}
table.frame-sides{border-width:0 1px}
table.frame-none>colgroup+*>:first-child>*,table.frame-sides>colgroup+*>:first-child>*{border-top-width:0}
table.frame-none>:last-child>:last-child>*,table.frame-sides>:last-child>:last-child>*{border-bottom-width:0}
table.frame-none>*>tr>:first-child,table.frame-ends>*>tr>:first-child{border-left-width:0}
table.frame-none>*>tr>:last-child,table.frame-ends>*>tr>:last-child{border-right-width:0}
table.stripes-all tr,table.stripes-odd tr:nth-of-type(odd),table.stripes-even tr:nth-of-type(even),table.stripes-hover tr:hover{background:#f8f8f7}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
ol>li p,ul>li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.checklist,ul.none,ol.none,ul.no-bullet,ol.no-bullet,ol.unnumbered,ul.unstyled,ol.unstyled{list-style-type:none}
ul.no-bullet,ol.no-bullet,ol.unnumbered{margin-left:.625em}
ul.unstyled,ol.unstyled{margin-left:0}
ul.checklist{margin-left:.625em}
ul.checklist li>p:first-child>.fa-square-o:first-child,ul.checklist li>p:first-child>.fa-check-square-o:first-child{width:1.25em;font-size:.8em;position:relative;bottom:.125em}
ul.checklist li>p:first-child>input[type="checkbox"]:first-child{margin-right:.25em}
ul.inline{display:-ms-flexbox;display:-webkit-box;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap;list-style:none;margin:0 0 .625em -1.25em}
ul.inline>li{margin-left:1.25em}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1,td.hdlist2{vertical-align:top;padding:0 .625em}
td.hdlist1{font-weight:bold;padding-bottom:1.25em}
td.hdlist2{word-wrap:anywhere}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist td:not([class]):first-child{padding:.4em .75em 0;line-height:1;vertical-align:top}
.colist td:not([class]):first-child img{max-width:none}
.colist td:not([class]):last-child{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:solid 4px #fff;-webkit-box-shadow:0 0 0 1px #ddd;box-shadow:0 0 0 1px #ddd}
.imageblock.left{margin:.25em .625em 1.25em 0}
.imageblock.right{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none;display:inline-block}
a.image object{pointer-events:none}
sup.footnote,sup.footnoteref{font-size:.875em;position:static;vertical-align:super}
sup.footnote a,sup.footnoteref a{text-decoration:none}
sup.footnote a:active,sup.footnoteref a:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em;border-width:1px 0 0}
#footnotes .footnote{padding:0 .375em 0 .225em;line-height:1.3334;font-size:.875em;margin-left:1.2em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none;margin-left:-1.05em}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
.gist .file-data>table{border:0;background:#fff;width:100%;margin-bottom:0}
.gist .file-data>table td.line-data{width:99%}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background:#00fafa}
.black{color:#000}
.black-background{background:#000}
.blue{color:#0000bf}
.blue-background{background:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background:#fa00fa}
.gray{color:#606060}
.gray-background{background:#7d7d7d}
.green{color:#006000}
.green-background{background:#007d00}
.lime{color:#00bf00}
.lime-background{background:#00fa00}
.maroon{color:#600000}
.maroon-background{background:#7d0000}
.navy{color:#000060}
.navy-background{background:#00007d}
.olive{color:#606000}
.olive-background{background:#7d7d00}
.purple{color:#600060}
.purple-background{background:#7d007d}
.red{color:#bf0000}
.red-background{background:#fa0000}
.silver{color:#909090}
.silver-background{background:#bcbcbc}
.teal{color:#006060}
.teal-background{background:#007d7d}
.white{color:#bfbfbf}
.white-background{background:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background:#fafa00}
span.icon>.fa{cursor:default}
a span.icon>.fa{cursor:inherit}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note::before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip::before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning::before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution::before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important::before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background:rgba(0,0,0,.8);-webkit-border-radius:50%;border-radius:50%;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]::after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
dt,th.tableblock,td.content,div.footnote{text-rendering:optimizeLegibility}
h1,h2,p,td.content,span.alt{letter-spacing:-.01em}
p strong,td.content strong,div.footnote strong{letter-spacing:-.005em}
p,blockquote,dt,td.content,span.alt{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background:#fffef7;border-color:#e0e0dc;-webkit-box-shadow:0 1px 4px #e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@page{margin:1.25cm .75cm}
@media print{*{-webkit-box-shadow:none!important;box-shadow:none!important;text-shadow:none!important}
html{font-size:80%}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare)::after,a[href^="https:"]:not(.bare)::after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]::after{content:" (" attr(title) ")"}
pre,blockquote,tr,img,object,svg{page-break-inside:avoid}
thead{display:table-header-group}
svg{max-width:100%}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#header,#content,#footnotes,#footer{max-width:none}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #dddddf!important;padding-bottom:0!important}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span::before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]::before{display:block}
#footer{padding:0 .9375em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
@media print,amzn-kf8{#header>h1:first-child{margin-top:1.25rem}
.sect1{padding:0!important}
.sect1+.sect1{border:0}
#footer{background:none}
#footer-text{color:rgba(0,0,0,.6);font-size:.9em}}
@media amzn-kf8{#header,#content,#footnotes,#footer{padding:0}}
</style>
</head>
<body class="article">
<div id="header">
</div>
<div id="content">
<div class="sect1">
<h2 id="chapter_tx_parsing">Transactions</h2>
<div class="sectionbody">
<div class="paragraph lead">
<p>Transactions are at the heart of Bitcoin.
Transactions, simply put, are value transfers from one entity to another.
We&#8217;ll see in <a href="#chapter_script">[chapter_script]</a> how "entities" in this case are really smart contracts—but we&#8217;re getting ahead of ourselves.
Let&#8217;s first look at what transactions in Bitcoin are, what they look like, and how they are parsed.</p>
</div>
<div class="sect2">
<h3 id="_transaction_components">Transaction Components</h3>
<div class="paragraph">
<p>At a high level, a transaction really only has four components.
They are:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Version</p>
</li>
<li>
<p>Inputs</p>
</li>
<li>
<p>Outputs</p>
</li>
<li>
<p>Locktime</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>A general overview of these fields might be helpful.
The version indicates what additional features the transaction uses, inputs define what bitcoins are being spent, outputs define where the bitcoins are going, and locktime defines when this transaction starts being valid.
We&#8217;ll go through each component in depth.</p>
</div>
<div class="paragraph">
<p><a href="#transaction_components_version_inputs_output_locktime">Transaction components: version, inputs, outputs, and locktime</a> shows a hexadecimal dump of a typical transaction that shows which parts are which.</p>
</div>
<div id="transaction_components_version_inputs_output_locktime" class="imageblock">
<div class="content">
<img src="images/prbc_0501.png" alt="Transaction Version Inputs Outputs and Locktime">
</div>
<div class="title">Figure 1. Transaction components: version, inputs, outputs, and locktime</div>
</div>
<div class="paragraph">
<p>The differently highlighted parts represent the version, inputs, outputs, and locktime, respectively.</p>
</div>
<div class="paragraph">
<p>With this in mind, we can start constructing the transaction class, which we&#8217;ll call <code>Tx</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-python" data-lang="python">class Tx:

    def __init__(self, version, tx_ins, tx_outs, locktime, testnet=False):
        self.version = version
        self.tx_ins = tx_ins  # <b class="conum">(1)</b>
        self.tx_outs = tx_outs
        self.locktime = locktime
        self.testnet = testnet  # <b class="conum">(2)</b>

    def __repr__(self):
        tx_ins = ''
        for tx_in in self.tx_ins:
            tx_ins += tx_in.__repr__() + '\n'
        tx_outs = ''
        for tx_out in self.tx_outs:
            tx_outs += tx_out.__repr__() + '\n'
        return 'tx: {}\nversion: {}\ntx_ins:\n{}tx_outs:\n{}locktime: {}'.format(
            self.id(),
            self.version,
            tx_ins,
            tx_outs,
            self.locktime,
        )

    def id(self):  # <b class="conum">(3)</b>
        '''Human-readable hexadecimal of the transaction hash'''
        return self.hash().hex()

    def hash(self):  # <b class="conum">(4)</b>
        '''Binary hash of the legacy serialization'''
        return hash256(self.serialize())[::-1]</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Input and output are very generic terms, so we specify what kind of inputs they are.
We&#8217;ll define the specific object types later.</p>
</li>
<li>
<p>We need to know which network this transaction is on to be able to validate it fully.</p>
</li>
<li>
<p>The <code>id</code> is what block explorers use for looking up transactions.
It&#8217;s the hash256 of the transaction in hexadecimal format.</p>
</li>
<li>
<p>The hash is the hash256 of the serialization in little-endian.
Note we don&#8217;t have the <code>serialize</code> method yet; so until we do, this won&#8217;t work.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>The rest of this chapter will be concerned with parsing transactions.
We could, at this point, write code like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-python" data-lang="python">class Tx:
    ...

    @classmethod  # <b class="conum">(1)</b>
    def parse(cls, serialization):
        version = serialization[0:4]  # <b class="conum">(2)</b>
	...</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>This method has to be a class method as the serialization will return a new instance of a <code>Tx</code> object.</p>
</li>
<li>
<p>We assume here that the variable <code>serialization</code> is a byte array.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>This could definitely work, but the transaction may be very large.
Ideally, we want to be able to parse from a <em>stream</em> instead.
This will allow us to not need the entire serialized transaction before we start parsing, and that allows us to fail early and be more efficient.
Thus, the code for parsing a transaction will look more like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-python" data-lang="python">class Tx:
    ...

    @classmethod
    def parse(cls, stream):
        serialized_version = stream.read(4)  # <b class="conum">(1)</b>
	...</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>The <code>read</code> method will allow us to parse on the fly as we won&#8217;t have to wait on I/O.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>This is advantageous from an engineering perspective as the stream can be a socket connection on the network or a file handle.
We can start parsing the stream right away instead of waiting for the whole thing to be transmitted or read first.
Our method will be able to handle any sort of stream and return the <code>Tx</code> object that we need.</p>
</div>
</div>
<div class="sect2">
<h3 id="_version">Version</h3>
<div class="paragraph">
<p>When you see a version number in something (<a href="#version_chap_five">Version</a> shows an example), it&#8217;s meant to give the receiver information about what the versioned thing is supposed to represent.
If, for example, you are running Windows 3.1, that&#8217;s a version number that&#8217;s very different than Windows 8 or Windows 10.
You could specify just "Windows," but specifying the version number after the operating system helps you know what features it has and what APIs you can program against.</p>
</div>
<div id="version_chap_five" class="imageblock">
<div class="content">
<img src="images/prbc_0502.png" alt="Version">
</div>
<div class="title">Figure 2. Version</div>
</div>
<div class="paragraph">
<p>Similarly, Bitcoin transactions have version numbers.
In Bitcoin&#8217;s case, the transaction version is generally 1, but there are cases where it can be 2 (transactions using an opcode called <code>OP_CHECKSEQUENCEVERIFY</code> as defined in BIP0112 require use of version &gt; 1).</p>
</div>
<div class="paragraph">
<p>You may notice here that the actual value in hexadecimal is <code>01000000</code>, which doesn&#8217;t look like 1.
Interpreted as a little-endian integer, however, this number is actually 1 (recall the discussion from <a href="#chapter_serialization">[chapter_serialization]</a>).</p>
</div>
<div class="sect3">
<h4 id="_exercise_1">Exercise 1</h4>
<div class="paragraph">
<p>Write the version parsing part of the <code>parse</code> method that we&#8217;ve defined. To do this properly, you&#8217;ll have to convert 4 bytes into a little-endian integer.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_inputs">Inputs</h3>
<div class="paragraph">
<p>Each input points to an output of a previous transaction (see <a href="#inputs_chap_five">Inputs</a>).
This fact requires more explanation, as it&#8217;s not intuitively obvious at first.</p>
</div>
<div id="inputs_chap_five" class="imageblock">
<div class="content">
<img src="images/prbc_0503.png" alt="Inputs">
</div>
<div class="title">Figure 3. Inputs</div>
</div>
<div class="paragraph">
<p>Bitcoin&#8217;s inputs are spending outputs of a previous transaction.
That is, you need to have received bitcoins first to spend something.
This makes intuitive sense.
You cannot spend money unless you&#8217;ve received money first.
The inputs refer to bitcoins that belong to you. Each input needs two things:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>A reference to bitcoins you received previously</p>
</li>
<li>
<p>Proof that these are yours to spend</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The second part uses ECDSA (<a href="#chapter_elliptic_curve_cryptography">[chapter_elliptic_curve_cryptography]</a>).
You don&#8217;t want people to be able to forge this, so most inputs contain signatures that only the owner(s) of the private key(s) can produce.</p>
</div>
<div class="paragraph">
<p>The inputs field can contain more than one input.
This is analogous to using either a single $100 bill to pay for a $70 meal, or a $50 and a $20.
The former only requires one input ("bill"); the latter requires two.
There are situations where there could be even more inputs.
In our analogy, we could pay for a $70 meal with 14 $5 bills, or even 7,000 pennies.
This would be analogous to 14 inputs or 7,000 inputs.</p>
</div>
<div class="paragraph">
<p>The number of inputs is the next part of the transaction, as highlighted in <a href="#number_of_inputs">Number of inputs</a>.</p>
</div>
<div id="number_of_inputs" class="imageblock">
<div class="content">
<img src="images/prbc_0504.png" alt="Inputs">
</div>
<div class="title">Figure 4. Number of inputs</div>
</div>
<div class="paragraph">
<p>We can see that the byte is actually <code>01</code>, which means that this transaction has one input.
It may be tempting here to assume that it&#8217;s always a single byte, but it&#8217;s not.
A single byte has 8 bits, so anything over 255 inputs will not be expressible in a single byte.</p>
</div>
<div class="paragraph">
<p>This is where <em>varints</em> come in.
Varint is shorthand for <em>variable integer</em>, which is a way to encode an integer into bytes that range from 0 to 2<sup>64</sup> – 1.
We could, of course, always reserve 8 bytes for the number of inputs, but that would be a lot of wasted space if we expect the number of inputs to be relatively small (say, under 200).
This is the case with the number of inputs in a normal transaction, so using varints helps to save space.
You can see how they work in the following sidebar.</p>
</div>
<div class="sidebarblock pagebreak-before less_space">
<div class="content">
<div class="title">Varints</div>
<div class="paragraph">
<p>Variable integers work by these rules:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>If the number is below 253, encode that number as a single byte (e.g., 100 &#8594; <code>0x64</code>).</p>
</li>
<li>
<p>If the number is between 253 and 2<sup>16</sup> – 1, start with the 253 byte (<code>fd</code>) and then encode the number in 2 bytes in little-endian (e.g., 255 &#8594; <code>0xfdff00</code>, 555 &#8594; <code>0xfd2b02</code>).</p>
</li>
<li>
<p>If the number is between 2<sup>16</sup> and 2<sup>32</sup> – 1, start with the 254 byte (<code>fe</code>) and then encode the number in 4 bytes in little-endian (e.g., 70015 &#8594; <code>0xfe7f110100</code>).</p>
</li>
<li>
<p>If the number is between 2<sup>32</sup> and 2<sup>64</sup> – 1, start with the 255 byte (<code>ff</code>) and then encode the number in 8 bytes in little-endian (e.g., 18005558675309 &#8594; <code>0xff6dc7ed3e60100000</code>).</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Two functions from <em>helper.py</em> will be used to parse and serialize varint fields:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-python" data-lang="python">def read_varint(s):
    '''read_varint reads a variable integer from a stream'''
    i = s.read(1)[0]
    if i == 0xfd:
        # 0xfd means the next two bytes are the number
        return little_endian_to_int(s.read(2))
    elif i == 0xfe:
        # 0xfe means the next four bytes are the number
        return little_endian_to_int(s.read(4))
    elif i == 0xff:
        # 0xff means the next eight bytes are the number
        return little_endian_to_int(s.read(8))
    else:
        # anything else is just the integer
        return i


def encode_varint(i):
    '''encodes an integer as a varint'''
    if i &lt; 0xfd:
        return bytes([i])
    elif i &lt; 0x10000:
        return b'\xfd' + int_to_little_endian(i, 2)
    elif i &lt; 0x100000000:
        return b'\xfe' + int_to_little_endian(i, 4)
    elif i &lt; 0x10000000000000000:
        return b'\xff' + int_to_little_endian(i, 8)
    else:
        raise ValueError('integer too large: {}'.format(i))</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>read_varint</code> will read from a stream and return the integer that was encoded.
<code>encode_varint</code> will do the opposite, which is to take an integer and return the varint byte representation.</p>
</div>
</div>
</div>
<div class="paragraph">
<p>Each input contains four fields.
The first two fields point to the previous transaction output and the last two fields define how the previous transaction output can be spent.
The fields are as follows:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Previous transaction ID</p>
</li>
<li>
<p>Previous transaction index</p>
</li>
<li>
<p>ScriptSig</p>
</li>
<li>
<p>Sequence</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>As just explained, each input has a reference to a previous transaction&#8217;s output.
The previous transaction ID is the hash256 of the previous transaction&#8217;s contents.
This uniquely defines the previous transaction, as the probability of a hash collision is impossibly low.</p>
</div>
<div class="paragraph">
<p>As we&#8217;ll see, each transaction has to have at least one output, but may have many.
Thus, we need to define exactly which output <em>within a transaction</em> we&#8217;re spending, which is captured in the previous transaction index.</p>
</div>
<div class="paragraph">
<p>Note that the previous transaction ID is 32 bytes and that the previous transaction index is 4 bytes.
Both are in little-endian.</p>
</div>
<div class="paragraph">
<p>The ScriptSig has to do with Bitcoin&#8217;s smart contract language, Script, discussed more thoroughly in <a href="#chapter_script">[chapter_script]</a>.
For now, think of the ScriptSig as opening a locked box—something that can only be done by the owner of the transaction output.
The ScriptSig field is a variable-length field, not a fixed-length field like most of what we&#8217;ve seen so far.
A variable-length field requires us to define exactly how long the field will be, which is why the field is preceded by a varint telling us how long it is.</p>
</div>
<div class="paragraph">
<p>The sequence was originally intended as a way to do what Satoshi called "high-frequency trades" with the locktime field (see <a href="#sequence_and_locktime">Sequence and Locktime</a>), but is currently used with Replace-By-Fee (RBF) and <code>OP_CHECKSEQUENCEVERIFY</code>.
The sequence is also in little-endian and takes up 4 bytes.</p>
</div>
<div class="paragraph">
<p>The fields of the input look like <a href="#the_fields_of_an_input_previous_tx_previous_index_scriptsig_and_sequence">The fields of an input: previous transaction ID, previous index, ScriptSig, and sequence</a>.</p>
</div>
<div id="the_fields_of_an_input_previous_tx_previous_index_scriptsig_and_sequence" class="imageblock">
<div class="content">
<img src="images/prbc_0505.png" alt="Input Fields">
</div>
<div class="title">Figure 5. The fields of an input: previous transaction ID, previous index, ScriptSig, and sequence</div>
</div>
<div id="sequence_and_locktime" class="sidebarblock">
<div class="content">
<div class="title">Sequence and Locktime</div>
<div class="paragraph">
<p>Originally, Satoshi wanted the sequence and locktime fields to be used for something called "high-frequency trades."
What Satoshi envisioned was a way to do payments back and forth with another party without making lots of on-chain transactions.
For example, if Alice pays Bob <em>x</em> bitcoins for something and then Bob pays Alice <em>y</em> bitcoins for something else (say, if <em>x</em> &gt; <em>y</em>), then Alice can just pay Bob <em>x</em> – <em>y</em>, instead of there being two separate transactions on-chain.
We could do the same thing if Alice and Bob had 100 transactions between them—that is, compress a bunch of transactions into a single transaction.</p>
</div>
<div class="paragraph">
<p>That&#8217;s the idea that Satoshi had: a continuously updating mini-ledger between the two parties involved that gets settled on-chain.
Satoshi&#8217;s intent was to use the sequence and locktime fields to update the high-frequency trade transaction every time a new payment between the two parties occurred.
The trade transaction would have two inputs (one from Alice and one from Bob) and two outputs (one to Alice and one to Bob).
The trade transaction would start with sequence at 0 and with a far-away locktime (say, 500 blocks from now, so valid in 500 blocks).
This would be the base transaction where Alice and Bob get the same amounts as they put in.</p>
</div>
<div class="paragraph">
<p>After the first transaction, where Alice pays Bob <em>x</em> bitcoins, the sequence of each input would be 1.
After the second transaction, where Bob pays Alice <em>y</em> bitcoins, the sequence of each input would be 2.
Using this method, we could have lots of payments compressed into a single on-chain transaction as long as they happened before the locktime became valid.</p>
</div>
<div class="paragraph">
<p>Unfortunately, as clever as this is, it turns out that it&#8217;s quite easy for a miner to cheat.
In our example, Bob could be a miner; he could ignore the updated trade transaction with sequence number 2 and mine the trade transaction with sequence number 1, cheating Alice out of <em>y</em> bitcoins.</p>
</div>
<div class="paragraph">
<p>A much better design was created later with "payment channels," which is the basis for the Lightning Network.</p>
</div>
</div>
</div>
<div class="paragraph pagebreak-before">
<p>Now that we know what the fields are, we can start creating a <code>TxIn</code> class in Python:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-python" data-lang="python">class TxIn:
    def __init__(self, prev_tx, prev_index, script_sig=None, sequence=0xffffffff):
        self.prev_tx = prev_tx
        self.prev_index = prev_index
        if script_sig is None:  # <b class="conum">(1)</b>
            self.script_sig = Script()
        else:
            self.script_sig = script_sig
        self.sequence = sequence

    def __repr__(self):
        return '{}:{}'.format(
            self.prev_tx.hex(),
            self.prev_index,
        )</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>We default to an empty ScriptSig.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>There are a couple things to note here.
First, the amount of each input is not specified.
We have no idea how much is being spent unless we look it up in the blockchain for the transaction(s) that we&#8217;re spending.
Furthermore, we don&#8217;t even know if the transaction is unlocking the right box, so to speak, without knowing about the previous transaction.
Every node must verify that this transaction unlocks the right box and that it doesn&#8217;t spend nonexistent bitcoins.
How we do that is further discussed in <a href="#chapter_tx">[chapter_tx]</a>.</p>
</div>
<div class="sect3">
<h4 id="_parsing_script">Parsing Script</h4>
<div class="paragraph">
<p>We&#8217;ll delve more deeply into how Script is parsed in <a href="#chapter_script">[chapter_script]</a>, but for now, here&#8217;s how you get a <code>Script</code> object from hexadecimal in Python:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>&gt;&gt;&gt; from io import BytesIO
&gt;&gt;&gt; from script import Script  # <b class="conum">(1)</b>
&gt;&gt;&gt; script_hex = ('6b483045022100ed81ff192e75a3fd2304004dcadb746fa5e24c5031ccf\
cf21320b0277457c98f02207a986d955c6e0cb35d446a89d3f56100f4d7f67801c31967743a9c8\
e10615bed01210349fc4e631e3624a545de3f89f5d8684c7b8138bd94bdd531d2e213bf016b278\
a')
&gt;&gt;&gt; stream = BytesIO(bytes.fromhex(script_hex))
&gt;&gt;&gt; script_sig = Script.parse(stream)
&gt;&gt;&gt; print(script_sig)
3045022100ed81ff192e75a3fd2304004dcadb746fa5e24c5031ccfcf21320b0277457c98f0220\
7a986d955c6e0cb35d446a89d3f56100f4d7f67801c31967743a9c8e10615bed01 0349fc4e631\
e3624a545de3f89f5d8684c7b8138bd94bdd531d2e213bf016b278a</pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>The <code>Script</code> class will be more thoroughly explored in <a href="#chapter_script">[chapter_script]</a>.
For now, please trust that the <code>Script.parse</code> method will create the object that we need.</p>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="_exercise_2">Exercise 2</h4>
<div class="paragraph">
<p>Write the inputs parsing part of the <code>parse</code> method in <code>Tx</code> and the <code>parse</code> method for <code>TxIn</code>.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_outputs">Outputs</h3>
<div class="paragraph">
<p>As hinted in the previous section, outputs define where the bitcoins are going.
Each transaction must have one or more outputs.
Why would anyone have more than one output?
An exchange may batch transactions, for example, and pay out to a lot of people at once instead of generating a single transaction for every single person that requests bitcoins.</p>
</div>
<div class="paragraph">
<p>Like with inputs, output serialization starts with how many outputs there are as a varint, as shown in <a href="#number_of_outputs">Number of outputs</a>.</p>
</div>
<div id="number_of_outputs" class="imageblock">
<div class="content">
<img src="images/prbc_0506.png" alt="Outputs">
</div>
<div class="title">Figure 6. Number of outputs</div>
</div>
<div class="paragraph">
<p>Each output has two fields: amount and ScriptPubKey.
The amount is the amount of bitcoins being assigned and is specified in satoshis, or 1/100,000,000ths of a bitcoin.
This allows us to divide bitcoins very finely, down to 1/300th of a penny in USD terms as of this writing.
The absolute maximum for the amount is the asymptotic limit of 21 million bitcoins in satoshis, which is 2,100,000,000,000,000 (2,100 trillion) satoshis.
This number is greater than 2<sup>32</sup> (4.3 billion or so) and is thus stored in 64 bits, or 8 bytes.
The amount is serialized in little-endian.</p>
</div>
<div class="paragraph">
<p>The ScriptPubKey, like the ScriptSig, has to do with Bitcoin&#8217;s smart contract language, Script.
Think of the ScriptPubKey as the locked box that can only be opened by the holder of the key.
It&#8217;s like a one-way safe that can receive deposits from anyone, but can only be opened by the owner of the safe.
We&#8217;ll explore this in more detail in <a href="#chapter_script">[chapter_script]</a>.
Like ScriptSig, ScriptPubKey is a variable-length field and is preceded by the length of the field in a varint.</p>
</div>
<div class="paragraph">
<p>A complete output looks like <a href="#output_fields_amount_and_scriptpubkey_this_one_is_at_index_0">A complete output field, showing the amount and ScriptPubKey—this one is at index 0</a>.</p>
</div>
<div id="output_fields_amount_and_scriptpubkey_this_one_is_at_index_0" class="imageblock">
<div class="content">
<img src="images/prbc_0507.png" alt="Output Fields">
</div>
<div class="title">Figure 7. A complete output field, showing the amount and ScriptPubKey—this one is at index 0</div>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">UTXO Set</div>
<div class="paragraph">
<p>UTXO stands for <em>unspent transaction output</em>.
The entire set of unspent transaction outputs at any given moment is called the <em>UTXO set</em>.
The reason why UTXOs are important is because at any moment in time, they represent all the bitcoins that are available to be spent.
In other words, these are the bitcoins that are in circulation.
Full nodes on the network must keep track of the UTXO set, and keeping the UTXO set indexed makes validating new transactions much faster.</p>
</div>
<div class="paragraph">
<p>For example, it&#8217;s easy to enforce a no-double-spending rule by looking up the previous transaction output in the UTXO set.
If the input of a new transaction is using a transaction output that&#8217;s not in the UTXO set, that&#8217;s an attempt at a double-spend or a nonexistent output and thus invalid.
Keeping the UTXO set handy is also very useful for validating transactions.
As we&#8217;ll see in <a href="#chapter_script">[chapter_script]</a>, we need to look up the amount and ScriptPubKey from the previous transaction output to validate transactions, so having these UTXOs handy can speed up transaction validation.</p>
</div>
</div>
</div>
<div class="paragraph">
<p>We can now start coding the <code>TxOut</code> class:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-python" data-lang="python">class TxOut:

    def __init__(self, amount, script_pubkey):
        self.amount = amount
        self.script_pubkey = script_pubkey

    def __repr__(self):
        return '{}:{}'.format(self.amount, self.script_pubkey)</code></pre>
</div>
</div>
<div class="sect3">
<h4 id="_exercise_3">Exercise 3</h4>
<div class="paragraph">
<p>Write the outputs parsing part of the <code>parse</code> method in <code>Tx</code> and the <code>parse</code> method for <code>TxOut</code>.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_locktime">Locktime</h3>
<div class="paragraph">
<p>Locktime is a way to time-delay a transaction.
A transaction with a locktime of 600,000 cannot go into the blockchain until block 600,001.
This was originally construed as a way to do high-frequency trades (see <a href="#sequence_and_locktime">Sequence and Locktime</a>), which turned out to be insecure.
If the locktime is greater than or equal to 500,000,000, it&#8217;s a Unix timestamp.
If it&#8217;s less than 500,000,000, it&#8217;s a block number.
This way, transactions can be signed but unspendable until a certain point in Unix time or block height is reached.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">
<div class="title">When Locktime Is Ignored</div>
<div class="paragraph">
<p>Note that locktime is ignored if the sequence numbers for every input are <code>ffffffff</code>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The serialization is in little-endian and 4 bytes (<a href="#locktime">Locktime</a>).</p>
</div>
<div id="locktime" class="imageblock">
<div class="content">
<img src="images/prbc_0508.png" alt="Locktime">
</div>
<div class="title">Figure 8. Locktime</div>
</div>
<div class="paragraph">
<p>The main problem with using locktime is that the recipient of the transaction has no certainty that the transaction will be good when the locktime comes.
This is similar to a postdated bank check, which has the possibility of bouncing.
The sender can spend the inputs prior to the locktime transaction getting into the blockchain, thus invalidating the transaction at locktime.</p>
</div>
<div class="paragraph">
<p>The uses before BIP0065 were limited.
BIP0065 introduced <code>OP_CHECKLOCKTIMEVERIFY</code>, which makes locktime more useful by making an output unspendable until a certain locktime.</p>
</div>
<div class="sect3">
<h4 id="_exercise_4">Exercise 4</h4>
<div class="paragraph">
<p>Write the locktime parsing part of the <code>parse</code> method in <code>Tx</code>.</p>
</div>
</div>
<div class="sect3">
<h4 id="_exercise_5">Exercise 5</h4>
<div class="paragraph">
<p>What are the ScriptSig of the second input, the ScriptPubKey of the first output, and the amount of the second output for this transaction?</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>010000000456919960ac691763688d3d3bcea9ad6ecaf875df5339e148a1fc61c6ed7a069e0100
00006a47304402204585bcdef85e6b1c6af5c2669d4830ff86e42dd205c0e089bc2a821657e951
c002201024a10366077f87d6bce1f7100ad8cfa8a064b39d4e8fe4ea13a7b71aa8180f012102f0
da57e85eec2934a82a585ea337ce2f4998b50ae699dd79f5880e253dafafb7feffffffeb8f51f4
038dc17e6313cf831d4f02281c2a468bde0fafd37f1bf882729e7fd3000000006a473044022078
99531a52d59a6de200179928ca900254a36b8dff8bb75f5f5d71b1cdc26125022008b422690b84
61cb52c3cc30330b23d574351872b7c361e9aae3649071c1a7160121035d5c93d9ac96881f19ba
1f686f15f009ded7c62efe85a872e6a19b43c15a2937feffffff567bf40595119d1bb8a3037c35
6efd56170b64cbcc160fb028fa10704b45d775000000006a47304402204c7c7818424c7f7911da
6cddc59655a70af1cb5eaf17c69dadbfc74ffa0b662f02207599e08bc8023693ad4e9527dc42c3
4210f7a7d1d1ddfc8492b654a11e7620a0012102158b46fbdff65d0172b7989aec8850aa0dae49
abfb84c81ae6e5b251a58ace5cfeffffffd63a5e6c16e620f86f375925b21cabaf736c779f88fd
04dcad51d26690f7f345010000006a47304402200633ea0d3314bea0d95b3cd8dadb2ef79ea833
1ffe1e61f762c0f6daea0fabde022029f23b3e9c30f080446150b23852028751635dcee2be669c
2a1686a4b5edf304012103ffd6f4a67e94aba353a00882e563ff2722eb4cff0ad6006e86ee20df
e7520d55feffffff0251430f00000000001976a914ab0c0b2e98b1ab6dbf67d4750b0a56244948
a87988ac005a6202000000001976a9143c82d7df364eb6c75be8c80df2b3eda8db57397088ac46
430600</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_coding_transactions">Coding Transactions</h3>
<div class="paragraph">
<p>We&#8217;ve parsed the transaction; now we want to do the opposite, which is serializing the transaction.
Let&#8217;s start with <code>TxOut</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-python" data-lang="python">class TxOut:
...
    def serialize(self):  # <b class="conum">(1)</b>
        '''Returns the byte serialization of the transaction output'''
        result = int_to_little_endian(self.amount, 8)
        result += self.script_pubkey.serialize()
        return result</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>We&#8217;re going to serialize the TxOut object to a bunch of bytes.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>We can then proceed to <code>TxIn</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-python" data-lang="python">class TxIn:
...
    def serialize(self):
        '''Returns the byte serialization of the transaction input'''
        result = self.prev_tx[::-1]
        result += int_to_little_endian(self.prev_index, 4)
        result += self.script_sig.serialize()
        result += int_to_little_endian(self.sequence, 4)
        return result</code></pre>
</div>
</div>
<div class="paragraph">
<p>Lastly, we can serialize <code>Tx</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-python" data-lang="python">class Tx:
...
    def serialize(self):
        '''Returns the byte serialization of the transaction'''
        result = int_to_little_endian(self.version, 4)
        result += encode_varint(len(self.tx_ins))
        for tx_in in self.tx_ins:
            result += tx_in.serialize()
        result += encode_varint(len(self.tx_outs))
        for tx_out in self.tx_outs:
            result += tx_out.serialize()
        result += int_to_little_endian(self.locktime, 4)
        return result</code></pre>
</div>
</div>
<div class="paragraph">
<p>We&#8217;ve used the <code>serialize</code> methods of both <code>TxIn</code> and <code>TxOut</code> to serialize <code>Tx</code>.</p>
</div>
<div class="paragraph">
<p>Note that the transaction fee is not specified anywhere!
This is because the fee is an implied amount, as described in the next section.</p>
</div>
</div>
<div class="sect2">
<h3 id="_transaction_fee">Transaction Fee</h3>
<div class="paragraph">
<p>One of the consensus rules of Bitcoin is that for any non-coinbase transactions (more on coinbase transactions in <a href="#chapter_blocks">[chapter_blocks]</a>), the sum of the inputs has to be greater than or equal to the sum of the outputs.
You may be wondering why the inputs and outputs can&#8217;t just be forced to be equal.
This is because if every transaction had zero cost, there wouldn&#8217;t be any incentive for miners to include transactions in blocks (see <a href="#chapter_blocks">[chapter_blocks]</a>).
Fees are a way to incentivize miners to include transactions.
Transactions not in blocks (so-called <em>mempool transactions</em>) are not part of the blockchain and are not final.</p>
</div>
<div class="paragraph">
<p>The transaction fee is simply the sum of the inputs minus the sum of the outputs.
This difference is what the miner gets to keep.
As inputs don&#8217;t have an amount field, we have to look up the amount.
This requires access to the blockchain, specifically the UTXO set.
If you are not running a full node, this can be tricky, as you now need to trust some other entity to provide you with this information.</p>
</div>
<div class="paragraph">
<p>We are creating a new class to handle this, called <code>TxFetcher</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-python" data-lang="python">class TxFetcher:
    cache = {}

    @classmethod
    def get_url(cls, testnet=False):
        if testnet:
            return 'https://blockstream.info/testnet/api/'
        else:
            return 'https://blockstream.info/api/'

    @classmethod
    def fetch(cls, tx_id, testnet=False, fresh=False):
        if fresh or (tx_id not in cls.cache):
            url = '{}/tx/{}/hex'.format(cls.get_url(testnet), tx_id)
            response = requests.get(url)
            try:
                raw = bytes.fromhex(response.text.strip())
            except ValueError:
                raise ValueError('unexpected response: {}'.format(response.text))
            if raw[4] == 0:
                raw = raw[:4] + raw[6:]
                tx = Tx.parse(BytesIO(raw), testnet=testnet)
                tx.locktime = little_endian_to_int(raw[-4:])
            else:
                tx = Tx.parse(BytesIO(raw), testnet=testnet)
            if tx.id() != tx_id:  # <b class="conum">(1)</b>
                raise ValueError('not the same id: {} vs {}'.format(tx.id(), 
                                  tx_id))
            cls.cache[tx_id] = tx
        cls.cache[tx_id].testnet = testnet
        return cls.cache[tx_id]</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>We check that the ID is what we expect it to be.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>You may be wondering why we don&#8217;t get just the specific output for the transaction and instead get the entire transaction.
This is because we don&#8217;t want to be trusting a third party!
By getting the entire transaction, we can verify the transaction ID (the hash256 of its contents) and be sure that we are indeed getting the transaction we asked for.
This is impossible unless we receive the entire transaction.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">
<div class="title">Why We Minimize Trusting Third Parties</div>
<div class="paragraph">
<p>As Nick Szabo eloquently wrote in his seminal essay <a href="https://nakamotoinstitute.org/trusted-third-parties/">"Trusted Third Parties are Security Holes"</a>, trusting third parties to provide correct data is <em>not</em> a good security practice.
The third party may be behaving well now, but you never know when it may get hacked, have an employee go rogue, or start implementing policies that are against your interests.
Part of what makes Bitcoin secure is <em>not</em> trusting, but verifying the data that we&#8217;re given.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>We can now create the appropriate method in <code>TxIn</code> to fetch the previous transaction and methods to get the previous transaction output&#8217;s amount and ScriptPubKey (the latter to be used in <a href="#chapter_script">[chapter_script]</a>):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-python" data-lang="python">class TxIn:
...
    def fetch_tx(self, testnet=False):
        return TxFetcher.fetch(self.prev_tx.hex(), testnet=testnet)

    def value(self, testnet=False):
        '''Get the output value by looking up the tx hash.
        Returns the amount in satoshi.
        '''
        tx = self.fetch_tx(testnet=testnet)
        return tx.tx_outs[self.prev_index].amount

    def script_pubkey(self, testnet=False):
        '''Get the ScriptPubKey by looking up the tx hash.
        Returns a Script object.
        '''
        tx = self.fetch_tx(testnet=testnet)
        return tx.tx_outs[self.prev_index].script_pubkey</code></pre>
</div>
</div>
<div class="sect3">
<h4 id="_calculating_the_fee">Calculating the Fee</h4>
<div class="paragraph">
<p>Now that we have the <code>value</code> method in <code>TxIn</code> that lets us access how many bitcoins are in each transaction input, we can calculate the fee for a transaction.</p>
</div>
</div>
<div class="sect3">
<h4 id="_exercise_6">Exercise 6</h4>
<div class="paragraph">
<p>Write the <code>fee</code> method for the <code>Tx</code> class.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_conclusion">Conclusion</h3>
<div class="paragraph">
<p>We&#8217;ve covered exactly how to parse and serialize transactions and defined what the fields mean.
There are two fields that require more explanation, both related to Bitcoin&#8217;s smart contract language, Script.
To that topic we go in <a href="#chapter_script">[chapter_script]</a>.</p>
</div>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Last updated 2021-11-22 19:07:17 -0600
</div>
</div>
</body>
</html>