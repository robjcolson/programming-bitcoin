<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.12">
<title>Bloom Filters</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700">
<style>
/* Asciidoctor default stylesheet | MIT License | https://asciidoctor.org */
/* Uncomment @import statement to use as custom stylesheet */
/*@import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700";*/
article,aside,details,figcaption,figure,footer,header,hgroup,main,nav,section{display:block}
audio,video{display:inline-block}
audio:not([controls]){display:none;height:0}
html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}
a{background:none}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
abbr[title]{border-bottom:1px dotted}
b,strong{font-weight:bold}
dfn{font-style:italic}
hr{-moz-box-sizing:content-box;box-sizing:content-box;height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type="button"],input[type="reset"],input[type="submit"]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type="checkbox"],input[type="radio"]{box-sizing:border-box;padding:0}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,*::before,*::after{-moz-box-sizing:border-box;-webkit-box-sizing:border-box;box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;font-weight:400;font-style:normal;line-height:1;position:relative;cursor:auto;tab-size:4;word-wrap:anywhere;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
img,object,svg{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:0}
p{font-family:inherit;font-weight:400;font-size:1em;line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #dddddf;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em;height:0}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{font-size:1em;line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0;font-size:1em}
ul.square li ul,ul.circle li ul,ul.disc li ul{list-style:inherit}
ul.square{list-style-type:square}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
abbr,acronym{text-transform:uppercase;font-size:90%;color:rgba(0,0,0,.8);border-bottom:1px dotted #ddd;cursor:help}
abbr{text-transform:none}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote cite{display:block;font-size:.9375em;color:rgba(0,0,0,.6)}
blockquote cite::before{content:"\2014 \0020"}
blockquote cite a,blockquote cite a:visited{color:rgba(0,0,0,.6)}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}
table{background:#fff;margin-bottom:1.25em;border:solid 1px #dedede;word-wrap:normal}
table thead,table tfoot{background:#f7f8f7}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt{background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{line-height:1.6}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.center{margin-left:auto;margin-right:auto}
.stretch{width:100%}
.clearfix::before,.clearfix::after,.float-group::before,.float-group::after{content:" ";display:table}
.clearfix::after,.float-group::after{clear:both}
:not(pre).nobreak{word-wrap:normal}
:not(pre).nowrap{white-space:nowrap}
:not(pre).pre-wrap{white-space:pre-wrap}
:not(pre):not([class^=L])>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background:#f7f7f8;-webkit-border-radius:4px;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed}
pre{color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;line-height:1.45;text-rendering:optimizeSpeed}
pre code,pre pre{color:inherit;font-size:inherit;line-height:inherit}
pre>code{display:block}
pre.nowrap,pre.nowrap pre{white-space:pre;word-wrap:normal}
em em{font-style:normal}
strong strong{font-weight:400}
.keyseq{color:rgba(51,51,51,.8)}
kbd{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;display:inline-block;color:rgba(0,0,0,.8);font-size:.65em;line-height:1.45;background:#f7f7f7;border:1px solid #ccc;-webkit-border-radius:3px;border-radius:3px;-webkit-box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em white inset;box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em #fff inset;margin:0 .15em;padding:.2em .5em;vertical-align:middle;position:relative;top:-.1em;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menuref{color:#000}
.menuseq b:not(.caret),.menuref{font-weight:inherit}
.menuseq{word-spacing:-.02em}
.menuseq b.caret{font-size:1.25em;line-height:.8}
.menuseq i.caret{font-weight:bold;text-align:center;width:.45em}
b.button::before,b.button::after{position:relative;top:-1px;font-weight:400}
b.button::before{content:"[";padding:0 3px 0 2px}
b.button::after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin-left:auto;margin-right:auto;margin-top:0;margin-bottom:0;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header::before,#header::after,#content::before,#content::after,#footnotes::before,#footnotes::after,#footer::before,#footer::after{content:" ";display:table}
#header::after,#content::after,#footnotes::after,#footer::after{clear:both}
#content{margin-top:1.25em}
#content::before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #dddddf}
#header>h1:only-child,body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #dddddf;padding-bottom:8px}
#header .details{border-bottom:1px solid #dddddf;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:-ms-flexbox;display:-webkit-flex;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span::before{content:"\00a0\2013\00a0"}
#header .details br+span.author::before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark::before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber::after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #dddddf;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #e7e7e9;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc li{line-height:1.3334;margin-top:.3334em}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
#toc.toc2{margin-top:0!important;background:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #e7e7e9;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #e7e7e9;left:auto;right:0}}
@media screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}
#content #toc{border-style:solid;border-width:1px;border-color:#e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;-webkit-border-radius:4px;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:none;background:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:rgba(255,255,255,.8);line-height:1.44}
#content{margin-bottom:.625em}
.sect1{padding-bottom:.625em}
@media screen and (min-width:768px){#content{margin-bottom:1.25em}
.sect1{padding-bottom:1.25em}}
.sect1:last-child{padding-bottom:0}
.sect1+.sect1{border-top:1px solid #e7e7e9}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor::before,h2>a.anchor::before,h3>a.anchor::before,#toctitle>a.anchor::before,.sidebarblock>.content>.title>a.anchor::before,h4>a.anchor::before,h5>a.anchor::before,h6>a.anchor::before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
details,.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
details>summary:first-of-type{cursor:pointer;display:list-item;outline:none;margin-bottom:.75em}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock.fit-content>caption.title{white-space:nowrap;width:0}
.paragraph.lead>p,#preamble>.sectionbody>[class="paragraph"]:first-of-type p{font-size:1.21875em;line-height:1.6;color:rgba(0,0,0,.85)}
table.tableblock #preamble>.sectionbody>[class="paragraph"]:first-of-type p{font-size:inherit}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #dddddf;color:rgba(0,0,0,.6);word-wrap:anywhere}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border-style:solid;border-width:1px;border-color:#e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;-webkit-border-radius:4px;border-radius:4px}
.exampleblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child{margin-bottom:0}
.sidebarblock{border-style:solid;border-width:1px;border-color:#dbdbd6;margin-bottom:1.25em;padding:1.25em;background:#f3f3f2;-webkit-border-radius:4px;border-radius:4px}
.sidebarblock>:first-child{margin-top:0}
.sidebarblock>:last-child{margin-bottom:0}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock>.content>pre{-webkit-border-radius:4px;border-radius:4px;overflow-x:auto;padding:1em;font-size:.8125em}
@media screen and (min-width:768px){.literalblock pre,.listingblock>.content>pre{font-size:.90625em}}
@media screen and (min-width:1280px){.literalblock pre,.listingblock>.content>pre{font-size:1em}}
.literalblock pre,.listingblock>.content>pre:not(.highlight),.listingblock>.content>pre[class="highlight"],.listingblock>.content>pre[class^="highlight "]{background:#f7f7f8}
.literalblock.output pre{color:#f7f7f8;background:rgba(0,0,0,.9)}
.listingblock>.content{position:relative}
.listingblock code[data-lang]::before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:inherit;opacity:.5}
.listingblock:hover code[data-lang]::before{display:block}
.listingblock.terminal pre .command::before{content:attr(data-prompt);padding-right:.5em;color:inherit;opacity:.5}
.listingblock.terminal pre .command:not([data-prompt])::before{content:"$"}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;-webkit-border-radius:4px;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.prettyprint{background:#f7f7f8}
pre.prettyprint .linenums{line-height:1.45;margin-left:2em}
pre.prettyprint li{background:none;list-style-type:inherit;padding-left:0}
pre.prettyprint li code[data-lang]::before{opacity:1}
pre.prettyprint li:not(:first-child) code[data-lang]::before{display:none}
table.linenotable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.linenotable td[class]{color:inherit;vertical-align:top;padding:0;line-height:inherit;white-space:normal}
table.linenotable td.code{padding-left:.75em}
table.linenotable td.linenos{border-right:1px solid currentColor;opacity:.35;padding-right:.5em}
pre.pygments .lineno{border-right:1px solid currentColor;opacity:.35;display:inline-block;margin-right:.75em}
pre.pygments .lineno::before{content:"";margin-right:-.125em}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock:not(.excerpt)>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote::before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.75em;margin-right:.5ex;text-align:right}
.verseblock{margin:0 1em 1.25em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.025em;color:rgba(0,0,0,.6)}
.quoteblock.abstract blockquote::before,.quoteblock.excerpt blockquote::before,.quoteblock .quoteblock blockquote::before{display:none}
.quoteblock.abstract blockquote,.quoteblock.abstract p,.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{line-height:1.6;word-spacing:0}
.quoteblock.abstract{margin:0 1em 1.25em;display:block}
.quoteblock.abstract>.title{margin:0 0 .375em;font-size:1.15em;text-align:center}
.quoteblock.excerpt>blockquote,.quoteblock .quoteblock{padding:0 0 .25em 1em;border-left:.25em solid #dddddf}
.quoteblock.excerpt,.quoteblock .quoteblock{margin-left:0}
.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{color:inherit;font-size:1.0625rem}
.quoteblock.excerpt .attribution,.quoteblock .quoteblock .attribution{color:inherit;text-align:left;margin-right:0}
p.tableblock:last-child{margin-bottom:0}
td.tableblock>.content{margin-bottom:1.25em;word-wrap:anywhere}
td.tableblock>.content>:last-child{margin-bottom:-1.25em}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all>*>tr>*{border-width:1px}
table.grid-cols>*>tr>*{border-width:0 1px}
table.grid-rows>*>tr>*{border-width:1px 0}
table.frame-all{border-width:1px}
table.frame-ends{border-width:1px 0}
table.frame-sides{border-width:0 1px}
table.frame-none>colgroup+*>:first-child>*,table.frame-sides>colgroup+*>:first-child>*{border-top-width:0}
table.frame-none>:last-child>:last-child>*,table.frame-sides>:last-child>:last-child>*{border-bottom-width:0}
table.frame-none>*>tr>:first-child,table.frame-ends>*>tr>:first-child{border-left-width:0}
table.frame-none>*>tr>:last-child,table.frame-ends>*>tr>:last-child{border-right-width:0}
table.stripes-all tr,table.stripes-odd tr:nth-of-type(odd),table.stripes-even tr:nth-of-type(even),table.stripes-hover tr:hover{background:#f8f8f7}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
ol>li p,ul>li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.checklist,ul.none,ol.none,ul.no-bullet,ol.no-bullet,ol.unnumbered,ul.unstyled,ol.unstyled{list-style-type:none}
ul.no-bullet,ol.no-bullet,ol.unnumbered{margin-left:.625em}
ul.unstyled,ol.unstyled{margin-left:0}
ul.checklist{margin-left:.625em}
ul.checklist li>p:first-child>.fa-square-o:first-child,ul.checklist li>p:first-child>.fa-check-square-o:first-child{width:1.25em;font-size:.8em;position:relative;bottom:.125em}
ul.checklist li>p:first-child>input[type="checkbox"]:first-child{margin-right:.25em}
ul.inline{display:-ms-flexbox;display:-webkit-box;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap;list-style:none;margin:0 0 .625em -1.25em}
ul.inline>li{margin-left:1.25em}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1,td.hdlist2{vertical-align:top;padding:0 .625em}
td.hdlist1{font-weight:bold;padding-bottom:1.25em}
td.hdlist2{word-wrap:anywhere}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist td:not([class]):first-child{padding:.4em .75em 0;line-height:1;vertical-align:top}
.colist td:not([class]):first-child img{max-width:none}
.colist td:not([class]):last-child{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:solid 4px #fff;-webkit-box-shadow:0 0 0 1px #ddd;box-shadow:0 0 0 1px #ddd}
.imageblock.left{margin:.25em .625em 1.25em 0}
.imageblock.right{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none;display:inline-block}
a.image object{pointer-events:none}
sup.footnote,sup.footnoteref{font-size:.875em;position:static;vertical-align:super}
sup.footnote a,sup.footnoteref a{text-decoration:none}
sup.footnote a:active,sup.footnoteref a:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em;border-width:1px 0 0}
#footnotes .footnote{padding:0 .375em 0 .225em;line-height:1.3334;font-size:.875em;margin-left:1.2em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none;margin-left:-1.05em}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
.gist .file-data>table{border:0;background:#fff;width:100%;margin-bottom:0}
.gist .file-data>table td.line-data{width:99%}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background:#00fafa}
.black{color:#000}
.black-background{background:#000}
.blue{color:#0000bf}
.blue-background{background:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background:#fa00fa}
.gray{color:#606060}
.gray-background{background:#7d7d7d}
.green{color:#006000}
.green-background{background:#007d00}
.lime{color:#00bf00}
.lime-background{background:#00fa00}
.maroon{color:#600000}
.maroon-background{background:#7d0000}
.navy{color:#000060}
.navy-background{background:#00007d}
.olive{color:#606000}
.olive-background{background:#7d7d00}
.purple{color:#600060}
.purple-background{background:#7d007d}
.red{color:#bf0000}
.red-background{background:#fa0000}
.silver{color:#909090}
.silver-background{background:#bcbcbc}
.teal{color:#006060}
.teal-background{background:#007d7d}
.white{color:#bfbfbf}
.white-background{background:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background:#fafa00}
span.icon>.fa{cursor:default}
a span.icon>.fa{cursor:inherit}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note::before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip::before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning::before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution::before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important::before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background:rgba(0,0,0,.8);-webkit-border-radius:50%;border-radius:50%;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]::after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
dt,th.tableblock,td.content,div.footnote{text-rendering:optimizeLegibility}
h1,h2,p,td.content,span.alt{letter-spacing:-.01em}
p strong,td.content strong,div.footnote strong{letter-spacing:-.005em}
p,blockquote,dt,td.content,span.alt{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background:#fffef7;border-color:#e0e0dc;-webkit-box-shadow:0 1px 4px #e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@page{margin:1.25cm .75cm}
@media print{*{-webkit-box-shadow:none!important;box-shadow:none!important;text-shadow:none!important}
html{font-size:80%}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare)::after,a[href^="https:"]:not(.bare)::after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]::after{content:" (" attr(title) ")"}
pre,blockquote,tr,img,object,svg{page-break-inside:avoid}
thead{display:table-header-group}
svg{max-width:100%}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#header,#content,#footnotes,#footer{max-width:none}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #dddddf!important;padding-bottom:0!important}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span::before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]::before{display:block}
#footer{padding:0 .9375em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
@media print,amzn-kf8{#header>h1:first-child{margin-top:1.25rem}
.sect1{padding:0!important}
.sect1+.sect1{border:0}
#footer{background:none}
#footer-text{color:rgba(0,0,0,.6);font-size:.9em}}
@media amzn-kf8{#header,#content,#footnotes,#footer{padding:0}}
</style>
</head>
<body class="article">
<div id="header">
</div>
<div id="content">
<div class="sect1">
<h2 id="chapter_bloom_filters">Bloom Filters</h2>
<div class="sectionbody">
<div class="paragraph lead">
<p>In <a href="#chapter_spv">[chapter_spv]</a> we learned how to validate a Merkle block.
A full node can provide a proof of inclusion for transactions of interest through the <code>merkleblock</code> command.
But how does the full node know which transactions are of interest?</p>
</div>
<div class="paragraph">
<p>A light client could tell the full node its addresses (or ScriptPubKeys).
The full node can check for transactions that are relevant to these addresses, but that would be compromising the light client&#8217;s privacy.
A light client wouldn&#8217;t want to reveal, for example, that it has 1,000 BTC to a full node.
Privacy leaks are security leaks, and in Bitcoin, it&#8217;s generally a good idea to not leak any privacy whenever possible.</p>
</div>
<div class="paragraph">
<p>One solution is for the light client to tell the full node enough information to create a <em>superset</em> of all transactions of interest.
To create this superset, we use what&#8217;s called a <em>Bloom filter</em>.</p>
</div>
<div class="sect2">
<h3 id="_what_is_a_bloom_filter">What Is a Bloom Filter?</h3>
<div class="paragraph">
<p>A Bloom filter is a filter for all possible transactions.
Full nodes run transactions through a Bloom filter and send <code>merkleblock</code> commands for transactions that make it through.</p>
</div>
<div class="paragraph">
<p>Suppose there are 50 total transactions.
There is one transaction a light client is interested in.
The light client wants to "hide" the transaction among a group of five transactions.
This requires a function that groups the 50 transactions into 10 different buckets, and the full node can then send a single bucket of transactions, in a manner of speaking.
This grouping would have to be <em>deterministic</em>â€”that is, be the same each time.
How can this be accomplished?</p>
</div>
<div class="paragraph">
<p>The solution is to use a hash function to get a deterministic number and modulo to organize transactions into buckets.</p>
</div>
<div class="paragraph">
<p>A Bloom filter is a computer science structure that can be used on any data in a set, so suppose that we have one item, "hello world", that we want to create a Bloom filter for.
We need a hash function, so we&#8217;ll use one we already have: hash256.
The process of figuring out what bucket our item goes into looks like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-python" data-lang="python">&gt;&gt;&gt; from helper import hash256
&gt;&gt;&gt; bit_field_size = 10  # <b class="conum">(1)</b>
&gt;&gt;&gt; bit_field = [0] * bit_field_size
&gt;&gt;&gt; h = hash256(b'hello world')  # <b class="conum">(2)</b>
&gt;&gt;&gt; bit = int.from_bytes(h, 'big') % bit_field_size  # <b class="conum">(3)</b>
&gt;&gt;&gt; bit_field[bit] = 1  # <b class="conum">(4)</b>
&gt;&gt;&gt; print(bit_field)
[0, 0, 0, 0, 0, 0, 0, 0, 0, 1]</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Our <code>bit_field</code> is the list of "buckets," and we want there to be 10.</p>
</li>
<li>
<p>We hash the item with hash256.</p>
</li>
<li>
<p>We interpret this as a big-endian integer and modulo by 10 to determine the bucket this item belongs to.</p>
</li>
<li>
<p>We indicate the bucket we want in the Bloom filter.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Conceptually, what we just did looks like <a href="#ten_bit_bloom_filter_with_1_element">10-bit Bloom filter with one element</a>.</p>
</div>
<div id="ten_bit_bloom_filter_with_1_element" class="imageblock">
<div class="content">
<img src="images/prbc_1201.png" alt="Simple Bloom filter">
</div>
<div class="title">Figure 1. 10-bit Bloom filter with one element</div>
</div>
<div class="paragraph">
<p>Our Bloom filter consists of:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>The size of the bit field</p>
</li>
<li>
<p>The hash function used (and how we converted that to a number)</p>
</li>
<li>
<p>The bit field, which indicates the bucket we&#8217;re interested in</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>This works great for a single item, so it would work for a single address/ScriptPubKey/transaction ID of interest.
What do we do when we&#8217;re interested in more than one item?</p>
</div>
<div class="paragraph">
<p>We can run a second item through the same filter and set that bit to 1 as well.
The full node can then send multiple buckets of transactions instead of a single bucket.
Let&#8217;s create a Bloom filter with two items, "hello world" and "goodbye", using the following code:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-python" data-lang="python">&gt;&gt;&gt; from helper import hash256
&gt;&gt;&gt; bit_field_size = 10
&gt;&gt;&gt; bit_field = [0] * bit_field_size
&gt;&gt;&gt; for item in (b'hello world', b'goodbye'):  # <b class="conum">(1)</b>
...     h = hash256(item)
...     bit = int.from_bytes(h, 'big') % bit_field_size
...     bit_field[bit] = 1
&gt;&gt;&gt; print(bit_field)
[0, 0, 1, 0, 0, 0, 0, 0, 0, 1]</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>We are creating a filter for two items here, but this can be extended to many more.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p><a href="#ten_bit_bloom_filter_with_two_elements">10-bit Bloom filter with two elements</a> shows what this looks like conceptually.</p>
</div>
<div id="ten_bit_bloom_filter_with_two_elements" class="imageblock">
<div class="content">
<img src="images/prbc_1202.png" alt="Two Item Bloom filter">
</div>
<div class="title">Figure 2. 10-bit Bloom filter with two elements</div>
</div>
<div class="paragraph">
<p>If the space of all possible items is 50, 10 items on average will make it through this filter instead of the 5 when we only had 1 item of interest, because 2 buckets are returned, not 1.</p>
</div>
<div class="sect3">
<h4 id="_exercise_1">Exercise 1</h4>
<div class="paragraph">
<p>Calculate the Bloom Filter for "hello world" and "goodbye" using the hash160 hash function over a bit field of 10.</p>
</div>
</div>
<div class="sect3">
<h4 id="_going_a_step_further">Going a Step Further</h4>
<div class="paragraph">
<p>Suppose that the space of all items is 1 million and we want bucket sizes to still be 5. We would need a Bloom filter that&#8217;s 1,000,000 / 5 = 200,000 bits long.
Each bucket would have on average 5 items and we would get 5 times the number of items we&#8217;re interested in, 20% of which would be items of interest.
200,000 bits is 25,000 bytes and is a lot to transmit.
Can we do better?</p>
</div>
<div class="paragraph">
<p>A Bloom filter using multiple hash functions can shorten the bit field considerably.
If we use 5 hash functions over a bit field of 32, we have 32!/(27!5!) ~ 200,000 possible 5-bit combinations in that 32-bit field.
Of 1 million possible items, 5 items on average should have that 5-bit combination.
Instead of transmitting 25K bytes, we can transmit just 32 bits, or 4 bytes!</p>
</div>
<div class="paragraph">
<p>Here&#8217;s what that would look like.
For simplicity, we stick to the same 10-bit field but still have two items of interest:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-python" data-lang="python">&gt;&gt;&gt; from helper import hash256, hash160
&gt;&gt;&gt; bit_field_size = 10
&gt;&gt;&gt; bit_field = [0] * bit_field_size
&gt;&gt;&gt; for item in (b'hello world', b'goodbye'):
...     for hash_function in (hash256, hash160):  # <b class="conum">(1)</b>
...         h = hash_function(item)
...         bit = int.from_bytes(h, 'big') % bit_field_size
...         bit_field[bit] = 1
&gt;&gt;&gt; print(bit_field)
[1, 1, 1, 0, 0, 0, 0, 0, 0, 1]</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>We iterate over two different hash functions (hash256 and hash160), but we could just as easily have more.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Conceptually, <a href="#ten_bit_bloom_filter_with_two_elements_and_two_hash_functions">10-bit Bloom filter with two elements and two hash functions</a> shows what the preceding code does.</p>
</div>
<div id="ten_bit_bloom_filter_with_two_elements_and_two_hash_functions" class="imageblock">
<div class="content">
<img src="images/prbc_1203.png" alt="Multiple Hash Functions">
</div>
<div class="title">Figure 3. 10-bit Bloom filter with two elements and two hash functions</div>
</div>
<div class="paragraph">
<p>A Bloom filter can be optimized by changing the number of hash functions and bit field size to get a desirable false-positive rate.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_bip0037_bloom_filters">BIP0037 Bloom Filters</h3>
<div class="paragraph">
<p>BIP0037 specifies Bloom filters in network communication. The information contained in a Bloom filter is:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>The size of the bit field, or how many buckets there are.
The size is specified in bytes (8 bits per byte) and rounded up if necessary.</p>
</li>
<li>
<p>The number of hash functions.</p>
</li>
<li>
<p>A "tweak" to be able to change the Bloom filter slightly if it hits too many items.</p>
</li>
<li>
<p>The bit field that results from running the Bloom filter over the items of interest.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>While we could define lots of hash functions (sha512, keccak384, ripemd160, blake256, etc.), in practice, we use a single hash function with a different seed.
This allows the implementation to be simpler.</p>
</div>
<div class="paragraph">
<p>The hash function we use is called <em>murmur3</em>.
Unlike sha256, murmur3 is not cryptographically secure, but it is much faster.
The task of filtering and getting a deterministic, evenly distributed modulo does not require cryptographic security but benefits from speed, so murmur3 is the appropriate tool for the job.
The seed formula is defined this way:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-python" data-lang="python">i*0xfba4c795 + tweak</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>fba4c795</code> is a constant for Bitcoin Bloom filters.
<code>i</code> is 0 for the first hash function, 1 for the second, 2 for the third, and so on.
The <code>tweak</code> is a bit of entropy that can be added if the results of of one tweak are not satisfactory.
The hash functions and the size of the bit field are used to calculate the bit field, which then gets transmitted:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-python" data-lang="python">&gt;&gt;&gt; from helper import murmur3  # <b class="conum">(1)</b>
&gt;&gt;&gt; from bloomfilter import BIP37_CONSTANT  # <b class="conum">(2)</b>
&gt;&gt;&gt; field_size = 2
&gt;&gt;&gt; num_functions = 2
&gt;&gt;&gt; tweak = 42
&gt;&gt;&gt; bit_field_size = field_size * 8
&gt;&gt;&gt; bit_field = [0] * bit_field_size
&gt;&gt;&gt; for phrase in (b'hello world', b'goodbye'):  # <b class="conum">(3)</b>
...     for i in range(num_functions):  # <b class="conum">(4)</b>
...         seed = i * BIP37_CONSTANT + tweak  # <b class="conum">(5)</b>
...         h = murmur3(phrase, seed=seed)  # <b class="conum">(6)</b>
...         bit = h % bit_field_size
...         bit_field[bit] = 1
&gt;&gt;&gt; print(bit_field)
[0, 0, 0, 0, 0, 1, 1, 0, 0, 1, 1, 0, 0, 0, 0, 0]</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p><code>murmur3</code> is implemented in pure Python in <em>helper.py</em>.</p>
</li>
<li>
<p><code>BIP37_CONSTANT</code> is the <code>fba4c795</code> number specified in BIP0037.</p>
</li>
<li>
<p>We iterate over some items of interest.</p>
</li>
<li>
<p>We use two hash functions.</p>
</li>
<li>
<p>This is the seed formula.</p>
</li>
<li>
<p>murmur3 returns a number, so we don&#8217;t have to do a conversion to an integer.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>This 2-byte Bloom filter has 4 bits set to 1 out of 16, so the probability of any random item passing through this filter is 1/4 &#215; 1/4 = 1/16.
If the space of all items numbers 160, a client will receive 10 items on average, 2 of which will be interesting.</p>
</div>
<div class="paragraph">
<p>We can start coding a <code>BloomFilter</code> class now:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-python" data-lang="python">class BloomFilter:

    def __init__(self, size, function_count, tweak):
        self.size = size
        self.bit_field = [0] * (size * 8)
        self.function_count = function_count
        self.tweak = tweak</code></pre>
</div>
</div>
<div class="sect3">
<h4 id="_exercise_2">Exercise 2</h4>
<div class="paragraph">
<p>Given a Bloom Filter with <code>size=10</code>, <code>function_count=5</code>, <code>tweak=99</code>, what are the bytes that are set after adding these items? (Use <code>bit_field_to_bytes</code> to convert to bytes.)</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>b&#8217;Hello World'</code></p>
</li>
<li>
<p><code>b&#8217;Goodbye!'</code></p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_exercise_3">Exercise 3</h4>
<div class="paragraph">
<p>Write the <code>add</code> method for <code>BloomFilter</code>.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_loading_a_bloom_filter">Loading a Bloom Filter</h3>
<div class="paragraph">
<p>Once a light client has created a Bloom filter, it needs to let the full node know the details of the filter so the full node can send proofs of inclusion.
The first thing a light client must do is set the optional relay flag in the version message (see <a href="#chapter_networking">[chapter_networking]</a>) to 0.
This tells the full node not to send transaction messages unless they match a Bloom filter or they have been specifically requested.
After the relay flag, a light client then communicates to the full node the Bloom filter itself.
The command to set the Bloom filter is called <code>filterload</code>.
The payload looks like <a href="#parsed_filterload">Parsed filterload</a>.</p>
</div>
<div id="parsed_filterload" class="imageblock">
<div class="content">
<img src="images/prbc_1204.png" alt="filterload Command">
</div>
<div class="title">Figure 4. Parsed filterload</div>
</div>
<div class="paragraph">
<p>The elements of a Bloom filter are encoded into bytes. The bit field, hash function count, and tweak are encoded in this message.
The last field, matched item flag, is a way of asking the full node to add any matched transactions to the Bloom filter.</p>
</div>
<div class="sect3">
<h4 id="_exercise_4">Exercise 4</h4>
<div class="paragraph">
<p>Write the  <code>filterload</code> method for the <code>BloomFilter</code> class.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_getting_merkle_blocks">Getting Merkle Blocks</h3>
<div class="paragraph">
<p>There is one more command that a light client needs: Merkle block information about transactions of interest from the full node.
The <code>getdata</code> command is what communicates blocks and transactions.
The specific type of data that a light client will want from a full node is something called a <em>filtered block</em>.
A filtered block is asking for transactions that pass through the Bloom filter in the form of Merkle blocks.
In other words, the light client can ask for Merkle blocks whose transactions of interest match the Bloom filter.</p>
</div>
<div class="paragraph">
<p><a href="#parsed_getdata">Parsed getdata</a> depicts the payload for <code>getdata</code>.</p>
</div>
<div id="parsed_getdata" class="imageblock">
<div class="content">
<img src="images/prbc_1205.png" alt="getdata Command">
</div>
<div class="title">Figure 5. Parsed getdata</div>
</div>
<div class="paragraph">
<p>The number of items as a varint specifies how many items we want.
Each item has a type.
A type value of 1 is a transaction (<a href="#chapter_tx_parsing">[chapter_tx_parsing]</a>), 2 is a normal block (<a href="#chapter_blocks">[chapter_blocks]</a>), 3 is a Merkle block (<a href="#chapter_spv">[chapter_spv]</a>), and 4 is a compact block (not covered in this book).</p>
</div>
<div class="paragraph">
<p>We can create this message in <em>network.py</em>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-python" data-lang="python">class GetDataMessage:
    command = b'getdata'

    def __init__(self):
        self.data = []  # <b class="conum">(1)</b>

    def add_data(self, data_type, identifier):
        self.data.append((data_type, identifier))  # <b class="conum">(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>We store the items we want.</p>
</li>
<li>
<p>We add items to the message using the <code>add_data</code> method.</p>
</li>
</ol>
</div>
<div class="sect3">
<h4 id="_exercise_5">Exercise 5</h4>
<div class="paragraph">
<p>Write the <code>serialize</code> method for the <code>GetDataMessage</code> class.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_getting_transactions_of_interest">Getting Transactions of Interest</h3>
<div class="paragraph">
<p>A light client that loads a Bloom filter with a full node will get all the information needed to prove that transactions of interest are included in particular blocks:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-python" data-lang="python">&gt;&gt;&gt; from bloomfilter import BloomFilter
&gt;&gt;&gt; from helper import decode_base58
&gt;&gt;&gt; from merkleblock import MerkleBlock
&gt;&gt;&gt; from network import FILTERED_BLOCK_DATA_TYPE, GetHeadersMessage, GetDataMe\
ssage, HeadersMessage, SimpleNode
&gt;&gt;&gt; from tx import Tx
&gt;&gt;&gt; last_block_hex = '00000000000538d5c2246336644f9a4956551afb44ba47278759ec55\
ea912e19'
&gt;&gt;&gt; address = 'mwJn1YPMq7y5F8J3LkC5Hxg9PHyZ5K4cFv'
&gt;&gt;&gt; h160 = decode_base58(address)
&gt;&gt;&gt; node = SimpleNode('testnet.programmingbitcoin.com', testnet=True, logging=\
False)
&gt;&gt;&gt; bf = BloomFilter(size=30, function_count=5, tweak=90210)  # <b class="conum">(1)</b>
&gt;&gt;&gt; bf.add(h160)  # <b class="conum">(2)</b>
&gt;&gt;&gt; node.handshake()
&gt;&gt;&gt; node.send(bf.filterload())  # <b class="conum">(3)</b>
&gt;&gt;&gt; start_block = bytes.fromhex(last_block_hex)
&gt;&gt;&gt; getheaders = GetHeadersMessage(start_block=start_block)
&gt;&gt;&gt; node.send(getheaders)  # <b class="conum">(4)</b>
&gt;&gt;&gt; headers = node.wait_for(HeadersMessage)
&gt;&gt;&gt; getdata = GetDataMessage()  # <b class="conum">(5)</b>
&gt;&gt;&gt; for b in headers.blocks:
...     if not b.check_pow():
...         raise RuntimeError('proof of work is invalid')
...     getdata.add_data(FILTERED_BLOCK_DATA_TYPE, b.hash())  # <b class="conum">(6)</b>
&gt;&gt;&gt; node.send(getdata)  # <b class="conum">(7)</b>
&gt;&gt;&gt; found = False
&gt;&gt;&gt; while not found:
...     message = node.wait_for(MerkleBlock, Tx)  # <b class="conum">(8)</b>
...     if message.command == b'merkleblock':
...         if not message.is_valid():  # <b class="conum">(9)</b>
...             raise RuntimeError('invalid merkle proof')
...     else:
...         for i, tx_out in enumerate(message.tx_outs):
...             if tx_out.script_pubkey.address(testnet=True) == address:  # <b class="conum">(10)</b>
...                 print('found: {}:{}'.format(message.id(), i))
...                 found = True
...                 break
found: e3930e1e566ca9b75d53b0eb9acb7607f547e1182d1d22bd4b661cfe18dcddf1:0</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>We are creating a Bloom filter that&#8217;s 30 bytes and uses 5 hash functions and a particularly popular '90s tweak.</p>
</li>
<li>
<p>We filter for the address above.</p>
</li>
<li>
<p>We send the <code>filterload</code> command from the Bloom filter we made.</p>
</li>
<li>
<p>We get the block headers after <code>last_block_hex</code>.</p>
</li>
<li>
<p>We create a getdata message for Merkle blocks that may have transactions of interest.</p>
</li>
<li>
<p>We request a Merkle block proving transactions of interest to us are included.
Most blocks will probably be complete misses.</p>
</li>
<li>
<p>The getdata message asks for 2,000 Merkle blocks after the block defined by <code>last_block_hex</code>.</p>
</li>
<li>
<p>We wait for the <code>merkleblock</code> command, which proves inclusion, and the <code>tx</code> command, which gives us the transaction of interest.</p>
</li>
<li>
<p>We check that the Merkle block proves transaction inclusion.</p>
</li>
<li>
<p>We&#8217;re looking for UTXOs for <code>address</code>, and we print to screen if we find one.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>What we&#8217;ve done is look at 2,000 blocks after a particular block for UTXOs corresponding to a particular address.
This is without the use of any block explorer, which preserves, to some degree, our privacy.</p>
</div>
<div class="sect3">
<h4 id="_exercise_6">Exercise 6</h4>
<div class="paragraph">
<p>Get the current testnet block ID, send yourself some testnet coins, find the UTXO corresponding to the testnet coins <em>without using a block explorer</em>, create a transaction using that UTXO as an input, and broadcast the tx message on the  testnet network.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_conclusion">Conclusion</h3>
<div class="paragraph">
<p>In this chapter, we created everything necessary to connect peer to peer as a light client and ask for and receive the UTXOs necessary to construct a transaction, all while preserving some privacy by using a Bloom filter.</p>
</div>
<div class="paragraph">
<p>We now turn to Segwit, which is a new type of transaction that was activated in 2017.</p>
</div>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Last updated 2021-11-22 19:07:17 -0600
</div>
</div>
</body>
</html>