<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.12">
<title>Pay-to-Script Hash</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700">
<style>
/* Asciidoctor default stylesheet | MIT License | https://asciidoctor.org */
/* Uncomment @import statement to use as custom stylesheet */
/*@import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700";*/
article,aside,details,figcaption,figure,footer,header,hgroup,main,nav,section{display:block}
audio,video{display:inline-block}
audio:not([controls]){display:none;height:0}
html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}
a{background:none}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
abbr[title]{border-bottom:1px dotted}
b,strong{font-weight:bold}
dfn{font-style:italic}
hr{-moz-box-sizing:content-box;box-sizing:content-box;height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type="button"],input[type="reset"],input[type="submit"]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type="checkbox"],input[type="radio"]{box-sizing:border-box;padding:0}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,*::before,*::after{-moz-box-sizing:border-box;-webkit-box-sizing:border-box;box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;font-weight:400;font-style:normal;line-height:1;position:relative;cursor:auto;tab-size:4;word-wrap:anywhere;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
img,object,svg{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:0}
p{font-family:inherit;font-weight:400;font-size:1em;line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #dddddf;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em;height:0}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{font-size:1em;line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0;font-size:1em}
ul.square li ul,ul.circle li ul,ul.disc li ul{list-style:inherit}
ul.square{list-style-type:square}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
abbr,acronym{text-transform:uppercase;font-size:90%;color:rgba(0,0,0,.8);border-bottom:1px dotted #ddd;cursor:help}
abbr{text-transform:none}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote cite{display:block;font-size:.9375em;color:rgba(0,0,0,.6)}
blockquote cite::before{content:"\2014 \0020"}
blockquote cite a,blockquote cite a:visited{color:rgba(0,0,0,.6)}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}
table{background:#fff;margin-bottom:1.25em;border:solid 1px #dedede;word-wrap:normal}
table thead,table tfoot{background:#f7f8f7}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt{background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{line-height:1.6}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.center{margin-left:auto;margin-right:auto}
.stretch{width:100%}
.clearfix::before,.clearfix::after,.float-group::before,.float-group::after{content:" ";display:table}
.clearfix::after,.float-group::after{clear:both}
:not(pre).nobreak{word-wrap:normal}
:not(pre).nowrap{white-space:nowrap}
:not(pre).pre-wrap{white-space:pre-wrap}
:not(pre):not([class^=L])>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background:#f7f7f8;-webkit-border-radius:4px;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed}
pre{color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;line-height:1.45;text-rendering:optimizeSpeed}
pre code,pre pre{color:inherit;font-size:inherit;line-height:inherit}
pre>code{display:block}
pre.nowrap,pre.nowrap pre{white-space:pre;word-wrap:normal}
em em{font-style:normal}
strong strong{font-weight:400}
.keyseq{color:rgba(51,51,51,.8)}
kbd{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;display:inline-block;color:rgba(0,0,0,.8);font-size:.65em;line-height:1.45;background:#f7f7f7;border:1px solid #ccc;-webkit-border-radius:3px;border-radius:3px;-webkit-box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em white inset;box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em #fff inset;margin:0 .15em;padding:.2em .5em;vertical-align:middle;position:relative;top:-.1em;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menuref{color:#000}
.menuseq b:not(.caret),.menuref{font-weight:inherit}
.menuseq{word-spacing:-.02em}
.menuseq b.caret{font-size:1.25em;line-height:.8}
.menuseq i.caret{font-weight:bold;text-align:center;width:.45em}
b.button::before,b.button::after{position:relative;top:-1px;font-weight:400}
b.button::before{content:"[";padding:0 3px 0 2px}
b.button::after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin-left:auto;margin-right:auto;margin-top:0;margin-bottom:0;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header::before,#header::after,#content::before,#content::after,#footnotes::before,#footnotes::after,#footer::before,#footer::after{content:" ";display:table}
#header::after,#content::after,#footnotes::after,#footer::after{clear:both}
#content{margin-top:1.25em}
#content::before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #dddddf}
#header>h1:only-child,body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #dddddf;padding-bottom:8px}
#header .details{border-bottom:1px solid #dddddf;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:-ms-flexbox;display:-webkit-flex;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span::before{content:"\00a0\2013\00a0"}
#header .details br+span.author::before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark::before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber::after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #dddddf;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #e7e7e9;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc li{line-height:1.3334;margin-top:.3334em}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
#toc.toc2{margin-top:0!important;background:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #e7e7e9;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #e7e7e9;left:auto;right:0}}
@media screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}
#content #toc{border-style:solid;border-width:1px;border-color:#e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;-webkit-border-radius:4px;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:none;background:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:rgba(255,255,255,.8);line-height:1.44}
#content{margin-bottom:.625em}
.sect1{padding-bottom:.625em}
@media screen and (min-width:768px){#content{margin-bottom:1.25em}
.sect1{padding-bottom:1.25em}}
.sect1:last-child{padding-bottom:0}
.sect1+.sect1{border-top:1px solid #e7e7e9}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor::before,h2>a.anchor::before,h3>a.anchor::before,#toctitle>a.anchor::before,.sidebarblock>.content>.title>a.anchor::before,h4>a.anchor::before,h5>a.anchor::before,h6>a.anchor::before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
details,.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
details>summary:first-of-type{cursor:pointer;display:list-item;outline:none;margin-bottom:.75em}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock.fit-content>caption.title{white-space:nowrap;width:0}
.paragraph.lead>p,#preamble>.sectionbody>[class="paragraph"]:first-of-type p{font-size:1.21875em;line-height:1.6;color:rgba(0,0,0,.85)}
table.tableblock #preamble>.sectionbody>[class="paragraph"]:first-of-type p{font-size:inherit}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #dddddf;color:rgba(0,0,0,.6);word-wrap:anywhere}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border-style:solid;border-width:1px;border-color:#e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;-webkit-border-radius:4px;border-radius:4px}
.exampleblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child{margin-bottom:0}
.sidebarblock{border-style:solid;border-width:1px;border-color:#dbdbd6;margin-bottom:1.25em;padding:1.25em;background:#f3f3f2;-webkit-border-radius:4px;border-radius:4px}
.sidebarblock>:first-child{margin-top:0}
.sidebarblock>:last-child{margin-bottom:0}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock>.content>pre{-webkit-border-radius:4px;border-radius:4px;overflow-x:auto;padding:1em;font-size:.8125em}
@media screen and (min-width:768px){.literalblock pre,.listingblock>.content>pre{font-size:.90625em}}
@media screen and (min-width:1280px){.literalblock pre,.listingblock>.content>pre{font-size:1em}}
.literalblock pre,.listingblock>.content>pre:not(.highlight),.listingblock>.content>pre[class="highlight"],.listingblock>.content>pre[class^="highlight "]{background:#f7f7f8}
.literalblock.output pre{color:#f7f7f8;background:rgba(0,0,0,.9)}
.listingblock>.content{position:relative}
.listingblock code[data-lang]::before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:inherit;opacity:.5}
.listingblock:hover code[data-lang]::before{display:block}
.listingblock.terminal pre .command::before{content:attr(data-prompt);padding-right:.5em;color:inherit;opacity:.5}
.listingblock.terminal pre .command:not([data-prompt])::before{content:"$"}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;-webkit-border-radius:4px;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.prettyprint{background:#f7f7f8}
pre.prettyprint .linenums{line-height:1.45;margin-left:2em}
pre.prettyprint li{background:none;list-style-type:inherit;padding-left:0}
pre.prettyprint li code[data-lang]::before{opacity:1}
pre.prettyprint li:not(:first-child) code[data-lang]::before{display:none}
table.linenotable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.linenotable td[class]{color:inherit;vertical-align:top;padding:0;line-height:inherit;white-space:normal}
table.linenotable td.code{padding-left:.75em}
table.linenotable td.linenos{border-right:1px solid currentColor;opacity:.35;padding-right:.5em}
pre.pygments .lineno{border-right:1px solid currentColor;opacity:.35;display:inline-block;margin-right:.75em}
pre.pygments .lineno::before{content:"";margin-right:-.125em}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock:not(.excerpt)>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote::before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.75em;margin-right:.5ex;text-align:right}
.verseblock{margin:0 1em 1.25em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.025em;color:rgba(0,0,0,.6)}
.quoteblock.abstract blockquote::before,.quoteblock.excerpt blockquote::before,.quoteblock .quoteblock blockquote::before{display:none}
.quoteblock.abstract blockquote,.quoteblock.abstract p,.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{line-height:1.6;word-spacing:0}
.quoteblock.abstract{margin:0 1em 1.25em;display:block}
.quoteblock.abstract>.title{margin:0 0 .375em;font-size:1.15em;text-align:center}
.quoteblock.excerpt>blockquote,.quoteblock .quoteblock{padding:0 0 .25em 1em;border-left:.25em solid #dddddf}
.quoteblock.excerpt,.quoteblock .quoteblock{margin-left:0}
.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{color:inherit;font-size:1.0625rem}
.quoteblock.excerpt .attribution,.quoteblock .quoteblock .attribution{color:inherit;text-align:left;margin-right:0}
p.tableblock:last-child{margin-bottom:0}
td.tableblock>.content{margin-bottom:1.25em;word-wrap:anywhere}
td.tableblock>.content>:last-child{margin-bottom:-1.25em}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all>*>tr>*{border-width:1px}
table.grid-cols>*>tr>*{border-width:0 1px}
table.grid-rows>*>tr>*{border-width:1px 0}
table.frame-all{border-width:1px}
table.frame-ends{border-width:1px 0}
table.frame-sides{border-width:0 1px}
table.frame-none>colgroup+*>:first-child>*,table.frame-sides>colgroup+*>:first-child>*{border-top-width:0}
table.frame-none>:last-child>:last-child>*,table.frame-sides>:last-child>:last-child>*{border-bottom-width:0}
table.frame-none>*>tr>:first-child,table.frame-ends>*>tr>:first-child{border-left-width:0}
table.frame-none>*>tr>:last-child,table.frame-ends>*>tr>:last-child{border-right-width:0}
table.stripes-all tr,table.stripes-odd tr:nth-of-type(odd),table.stripes-even tr:nth-of-type(even),table.stripes-hover tr:hover{background:#f8f8f7}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
ol>li p,ul>li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.checklist,ul.none,ol.none,ul.no-bullet,ol.no-bullet,ol.unnumbered,ul.unstyled,ol.unstyled{list-style-type:none}
ul.no-bullet,ol.no-bullet,ol.unnumbered{margin-left:.625em}
ul.unstyled,ol.unstyled{margin-left:0}
ul.checklist{margin-left:.625em}
ul.checklist li>p:first-child>.fa-square-o:first-child,ul.checklist li>p:first-child>.fa-check-square-o:first-child{width:1.25em;font-size:.8em;position:relative;bottom:.125em}
ul.checklist li>p:first-child>input[type="checkbox"]:first-child{margin-right:.25em}
ul.inline{display:-ms-flexbox;display:-webkit-box;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap;list-style:none;margin:0 0 .625em -1.25em}
ul.inline>li{margin-left:1.25em}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1,td.hdlist2{vertical-align:top;padding:0 .625em}
td.hdlist1{font-weight:bold;padding-bottom:1.25em}
td.hdlist2{word-wrap:anywhere}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist td:not([class]):first-child{padding:.4em .75em 0;line-height:1;vertical-align:top}
.colist td:not([class]):first-child img{max-width:none}
.colist td:not([class]):last-child{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:solid 4px #fff;-webkit-box-shadow:0 0 0 1px #ddd;box-shadow:0 0 0 1px #ddd}
.imageblock.left{margin:.25em .625em 1.25em 0}
.imageblock.right{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none;display:inline-block}
a.image object{pointer-events:none}
sup.footnote,sup.footnoteref{font-size:.875em;position:static;vertical-align:super}
sup.footnote a,sup.footnoteref a{text-decoration:none}
sup.footnote a:active,sup.footnoteref a:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em;border-width:1px 0 0}
#footnotes .footnote{padding:0 .375em 0 .225em;line-height:1.3334;font-size:.875em;margin-left:1.2em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none;margin-left:-1.05em}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
.gist .file-data>table{border:0;background:#fff;width:100%;margin-bottom:0}
.gist .file-data>table td.line-data{width:99%}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background:#00fafa}
.black{color:#000}
.black-background{background:#000}
.blue{color:#0000bf}
.blue-background{background:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background:#fa00fa}
.gray{color:#606060}
.gray-background{background:#7d7d7d}
.green{color:#006000}
.green-background{background:#007d00}
.lime{color:#00bf00}
.lime-background{background:#00fa00}
.maroon{color:#600000}
.maroon-background{background:#7d0000}
.navy{color:#000060}
.navy-background{background:#00007d}
.olive{color:#606000}
.olive-background{background:#7d7d00}
.purple{color:#600060}
.purple-background{background:#7d007d}
.red{color:#bf0000}
.red-background{background:#fa0000}
.silver{color:#909090}
.silver-background{background:#bcbcbc}
.teal{color:#006060}
.teal-background{background:#007d7d}
.white{color:#bfbfbf}
.white-background{background:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background:#fafa00}
span.icon>.fa{cursor:default}
a span.icon>.fa{cursor:inherit}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note::before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip::before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning::before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution::before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important::before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background:rgba(0,0,0,.8);-webkit-border-radius:50%;border-radius:50%;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]::after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
dt,th.tableblock,td.content,div.footnote{text-rendering:optimizeLegibility}
h1,h2,p,td.content,span.alt{letter-spacing:-.01em}
p strong,td.content strong,div.footnote strong{letter-spacing:-.005em}
p,blockquote,dt,td.content,span.alt{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background:#fffef7;border-color:#e0e0dc;-webkit-box-shadow:0 1px 4px #e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@page{margin:1.25cm .75cm}
@media print{*{-webkit-box-shadow:none!important;box-shadow:none!important;text-shadow:none!important}
html{font-size:80%}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare)::after,a[href^="https:"]:not(.bare)::after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]::after{content:" (" attr(title) ")"}
pre,blockquote,tr,img,object,svg{page-break-inside:avoid}
thead{display:table-header-group}
svg{max-width:100%}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#header,#content,#footnotes,#footer{max-width:none}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #dddddf!important;padding-bottom:0!important}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span::before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]::before{display:block}
#footer{padding:0 .9375em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
@media print,amzn-kf8{#header>h1:first-child{margin-top:1.25rem}
.sect1{padding:0!important}
.sect1+.sect1{border:0}
#footer{background:none}
#footer-text{color:rgba(0,0,0,.6);font-size:.9em}}
@media amzn-kf8{#header,#content,#footnotes,#footer{padding:0}}
</style>
</head>
<body class="article">
<div id="header">
</div>
<div id="content">
<div class="sect1">
<h2 id="chapter_p2sh">Pay-to-Script Hash</h2>
<div class="sectionbody">
<div class="paragraph lead">
<p>Up to this point in the book, we&#8217;ve been doing single-key transactions, or transactions with only a single private key per input.
What if we wanted something a little more complicated?
A company that has $100 million in bitcoin might not want the funds locked to a single private key: if that single key were lost or stolen, all funds would then be lost.
What can we do to reduce the risk of this single point of failure?</p>
</div>
<div class="paragraph">
<p>The solution is <em>multisig</em>, or multiple signatures.
This was built into Bitcoin from the beginning, but was clunky at first and so wasn&#8217;t used.
As we&#8217;ll discover later in this chapter, Satoshi probably didn&#8217;t test multisig, as it has an off-by-one error (see <a href="#off-by-one">OP_CHECKMULTISIG Off-by-One Bug</a>).
The bug has had to stay in the protocol because fixing it would require a hard fork.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="title">Multiple Private Keys to a Single Aggregated Public Key</div>
<div class="paragraph">
<p>It is possible to "split" a single private key into multiple private keys and use an interactive method to aggregate signatures without ever reconstructing the private key, but this is not a common practice.
Schnorr signatures will make aggregating signatures easier and perhaps more common in the future.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="_bare_multisig">Bare Multisig</h3>
<div class="paragraph">
<p>Bare multisig was the first attempt at creating transaction outputs that require signatures from multiple parties.
The idea is to change from a single point of failure to something a little more resilient to hacks.
To understand bare multisig, one must first understand the <code>OP_CHECKMULTISIG</code> opcode.
As discussed in <a href="#chapter_script">[chapter_script]</a>, Script has a lot of different opcodes.
<code>OP_CHECKMULTISIG</code> is one of them, at <code>0xae</code>.
The opcode <span class="keep-together">consumes</span> a lot of elements from the stack and returns whether or not the required number of signatures are valid for a transaction input.</p>
</div>
<div class="paragraph">
<p>The transaction output is called "bare" multisig because it&#8217;s a long ScriptPubKey.
<a href="#bare_multisig_scriptpubkey">Bare multisig ScriptPubKey</a> shows what a ScriptPubKey for a 1-of-2 multisig looks like.</p>
</div>
<div id="bare_multisig_scriptpubkey" class="imageblock">
<div class="content">
<img src="images/prbc_0801.png" alt="Bare multisig ScriptPubKey">
</div>
<div class="title">Figure 1. Bare multisig ScriptPubKey</div>
</div>
<div class="paragraph">
<p>Among bare multisig ScriptPubKeys, this one is on the small end, and we can already see that it&#8217;s long.
The ScriptPubKey for p2pkh is only 25 bytes, whereas this bare multisig is 101 bytes (though obviously, compressed SEC format would reduce it some), and this is a 1-of-2!
<a href="#bare_multisig_scriptsig">Bare multisig ScriptSig</a> shows what the ScriptSig looks like.</p>
</div>
<div id="bare_multisig_scriptsig" class="imageblock">
<div class="content">
<img src="images/prbc_0802.png" alt="Bare multisig ScriptSig">
</div>
<div class="title">Figure 2. Bare multisig ScriptSig</div>
</div>
<div class="paragraph">
<p>We only need 1 signature for this 1-of-2 multisig, so this is relatively short; something like a 5-of-7 would require 5 DER signatures and would be a lot longer (360 bytes or so).
<a href="#bare_multisig_combined_script">Bare multisig combined script</a> shows how the ScriptSig and ScriptPubKey combine.</p>
</div>
<div id="bare_multisig_combined_script" class="imageblock">
<div class="content">
<img src="images/prbc_0803.png" alt="Bare multisig combined script">
</div>
<div class="title">Figure 3. Bare multisig combined script</div>
</div>
<div class="paragraph">
<p>I&#8217;ve generalized here to show what an <em>m</em>-of-<em>n</em> bare multisig would look like (<em>m</em> and <em>n</em> can be anything from 1 to 20 inclusive, though the numerical opcodes only go up to <code>OP_16</code>; values of 17 to 20 would require <code>0112</code> to push a number like 18 to the stack).
The starting state looks like <a href="#bare_multisig_start">Bare multisig start</a>.</p>
</div>
<div id="bare_multisig_start" class="imageblock">
<div class="content">
<img src="images/prbc_0804.png" alt="Bare multisig start">
</div>
<div class="title">Figure 4. Bare multisig start</div>
</div>
<div class="paragraph">
<p><code>OP_0</code> will push the number 0 to the stack (<a href="#bare_multisig_step_1">Bare multisig step 1</a>).</p>
</div>
<div id="bare_multisig_step_1" class="imageblock">
<div class="content">
<img src="images/prbc_0805.png" alt="Bare multisig step 1">
</div>
<div class="title">Figure 5. Bare multisig step 1</div>
</div>
<div class="paragraph">
<p>The signatures are elements, so they&#8217;ll be pushed directly to the stack (<a href="#bare_multisig_step_2">Bare multisig step 2</a>).</p>
</div>
<div id="bare_multisig_step_2" class="imageblock">
<div class="content">
<img src="images/prbc_0806.png" alt="Bare multisig step 2">
</div>
<div class="title">Figure 6. Bare multisig step 2</div>
</div>
<div class="paragraph">
<p><code>OP_m</code> will push the number <em>m</em> to the stack, the public keys will be pushed to the stack, and <code>OP_n</code> will push the number <em>n</em> to the stack (<a href="#bare_multisig_step_3">Bare multisig step 3</a>).</p>
</div>
<div id="bare_multisig_step_3" class="imageblock">
<div class="content">
<img src="images/prbc_0807.png" alt="Bare multisig step 3">
</div>
<div class="title">Figure 7. Bare multisig step 3</div>
</div>
<div class="paragraph">
<p>At this point, <code>OP_CHECKMULTISIG</code> will consume <em>m</em> + <em>n</em> + 3 elements (see <a href="#off-by-one">OP_CHECKMULTISIG Off-by-One Bug</a>) and push a 1 to the stack if <em>m</em> of the signatures are valid for <em>m</em> distinct public keys from the list of <em>n</em> public keys; otherwise, it pushes a 0.
Assuming that the signatures are valid, the stack has a single 1, which validates the combined script (<a href="#bare_multisig_end">Bare multisig end</a>).</p>
</div>
<div id="bare_multisig_end" class="imageblock">
<div class="content">
<img src="images/prbc_0808.png" alt="Bare multisig end">
</div>
<div class="title">Figure 8. Bare multisig end</div>
</div>
<div id="off-by-one" class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="title">OP_CHECKMULTISIG Off-by-One Bug</div>
<div class="paragraph">
<p>The stack elements consumed by <code>OP_CHECKMULTISIG</code> are supposed to be <em>m</em>, <em>m</em> different signatures, <em>n</em> and <em>n</em> different pubkeys. The number of elements consumed should be 2 (<em>m</em> and <em>n</em> themselves) + <em>m</em> (signatures) + <em>n</em> (pubkeys).
Unfortunately, the opcode consumes one more element than the <em>m</em> + <em>n</em> + 2 elements that it&#8217;s supposed to.
<code>OP_CHECKMULTISIG</code> consumes <em>m</em> + <em>n</em> + 3 elements, so an extra element is added (<code>OP_0</code> in our example) so as to not cause a failure.</p>
</div>
<div class="paragraph">
<p>The opcode does nothing with that extra element, and that extra element can be anything. As a way to combat malleability, however, most nodes on the Bitcoin network will not relay the transaction unless the extra element is <code>OP_0</code>.
Note that if we had <em>m</em> + <em>n</em> + 2 elements, <code>OP_CHECKMULTISIG</code> would fail as there are not enough elements to be consumed and the combined script would fail, causing the transaction to be invalid.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_coding_op_checkmultisig">Coding OP_CHECKMULTISIG</h3>
<div class="paragraph">
<p>In an <em>m</em>-of-<em>n</em> bare multisig, the stack contains <em>n</em> as the top element, then <em>n</em> pubkeys, then <em>m</em>, then <em>m</em> signatures, and finally a filler item due to the off-by-one bug.
The code for <code>OP_CHECKMULTISIG</code> in <em>op.py</em> is mostly written here:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-python" data-lang="python">def op_checkmultisig(stack, z):
    if len(stack) &lt; 1:
        return False
    n = decode_num(stack.pop())
    if len(stack) &lt; n + 1:
        return False
    sec_pubkeys = []
    for _ in range(n):
        sec_pubkeys.append(stack.pop())
    m = decode_num(stack.pop())
    if len(stack) &lt; m + 1:
        return False
    der_signatures = []
    for _ in range(m):
        der_signatures.append(stack.pop()[:-1])  # <b class="conum">(1)</b>
    stack.pop()  # <b class="conum">(2)</b>
    try:
        raise NotImplementedError  # <b class="conum">(3)</b>
    except (ValueError, SyntaxError):
        return False
    return True</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Each DER signature is assumed to be signed with <code>SIGHASH_ALL</code>.</p>
</li>
<li>
<p>We take care of the off-by-one error by consuming the only remaining element of the stack and not doing anything with the element.</p>
</li>
<li>
<p>This is the part that you will need to code for the next exercise.</p>
</li>
</ol>
</div>
<div class="sect3">
<h4 id="_exercise_1">Exercise 1</h4>
<div class="paragraph">
<p>Write the <code>op_checkmultisig</code> function of <em>op.py</em>.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_problems_with_bare_multisig">Problems with Bare Multisig</h3>
<div class="paragraph">
<p>Bare multisig is a bit ugly, but it is functional.
It avoids the single point of failure by requiring <em>m</em> of <em>n</em> signatures to unlock a UTXO.
There is plenty of utility in making outputs multisig, especially if you&#8217;re a business.
However, bare multisig suffers from a few problems:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>A bare multisig ScriptPubKey has many different public keys, and that makes the ScriptPubKey long.
Unlike p2pkh or even p2pk ScriptPubKeys, these are not easily communicated using voice or even text messages.</p>
</li>
<li>
<p>Because the output is so long—5 to 20 times larger than a normal p2pkh output—it requires more resources for node software.
Nodes keep track of the UTXO set, and a big ScriptPubKey is more expensive to keep track of.
A large output is more expensive to keep in fast-access storage (like RAM).</p>
</li>
<li>
<p>Because the ScriptPubKey can be so big, bare multisig can and has been abused.
The entire PDF of Satoshi&#8217;s original whitepaper is encoded in this transaction in block 230009:</p>
<div class="listingblock">
<div class="content">
<pre>54e48e5f5c656b26c3bca14a8c95aa583d07ebe84dde3b7dd4a78f4e4186e713</pre>
</div>
</div>
<div class="paragraph">
<p>The creator of this transaction split up the whitepaper PDF into 64-byte chunks, which were then made into invalid uncompressed public keys.
The whitepaper was encoded into 947 1-of-3 bare multisig outputs.
These outputs are not spendable but have to be indexed in the UTXO sets of full nodes.
This is a tax every full node has to pay and is in that sense abusive.</p>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>To mitigate these problems, pay-to-script-hash (p2sh) was born.</p>
</div>
</div>
<div class="sect2">
<h3 id="_pay_to_script_hash_p2sh">Pay-to-Script-Hash (p2sh)</h3>
<div class="paragraph">
<p>Pay-to-script-hash (p2sh) is a general solution to the long address/ScriptPubKey problem.
More complicated ScriptPubKeys than bare multisig can easily be made, and they have the same problems as bare multisig.</p>
</div>
<div class="paragraph">
<p>The solution that p2sh implements is to take the hash of some Script commands and then reveal the preimage Script commands later.
Pay-to-script-hash was introduced in 2011 to a lot of controversy.
There were multiple proposals, but as we&#8217;ll see, p2sh is kludgy but works.</p>
</div>
<div class="paragraph">
<p>In p2sh, a special rule gets executed only when the pattern shown in <a href="#pay_to_script_hash_pattern_that_executes_the_special_rule">Pay-to-script-hash pattern (p2sh) that executes the special rule</a> is encountered.</p>
</div>
<div id="pay_to_script_hash_pattern_that_executes_the_special_rule" class="imageblock">
<div class="content">
<img src="images/prbc_0809.png" alt="p2sh Pattern">
</div>
<div class="title">Figure 9. Pay-to-script-hash pattern (p2sh) that executes the special rule</div>
</div>
<div class="paragraph">
<p>If this exact command set ends with a 1 on the stack, then the RedeemScript (the top item in <a href="#pay_to_script_hash_pattern_that_executes_the_special_rule">Pay-to-script-hash pattern (p2sh) that executes the special rule</a>) is parsed and then added to the Script command set.
This special pattern was introduced in BIP0016, and Bitcoin software that implements BIP0016 (anything post 2011) checks for the pattern.
The RedeemScript does not add new Script commands for processing unless this <em>exact</em> sequence is encountered and ends with a 1.</p>
</div>
<div class="paragraph">
<p>If this sounds hacky, it is.
But before we get to that, let&#8217;s look a little more closely at exactly how this plays out.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s say we have a 2-of-2 multisig ScriptPubKey (<a href="#pay_to_script_hash_p2sh_redeemscript">Pay-to-script-hash (p2sh) RedeemScript</a>).</p>
</div>
<div id="pay_to_script_hash_p2sh_redeemscript" class="imageblock">
<div class="content">
<img src="images/prbc_0810.png" alt="p2sh RedeemScript">
</div>
<div class="title">Figure 10. Pay-to-script-hash (p2sh) RedeemScript</div>
</div>
<div class="paragraph">
<p>This is a ScriptPubKey for a bare multisig.
What we need to do to convert this to p2sh is to take a hash of this script and keep the script handy for when we want to redeem it.
We call this the RedeemScript, because the script is only revealed during redemption.
We put the hash of the RedeemScript as the ScriptPubKey (<a href="#pay_to_script_hash_p2sh_scriptpubkey">Pay-to-script-hash (p2sh) ScriptPubKey</a>).</p>
</div>
<div id="pay_to_script_hash_p2sh_scriptpubkey" class="imageblock">
<div class="content">
<img src="images/prbc_0811.png" alt="p2sh ScriptPubKey">
</div>
<div class="title">Figure 11. Pay-to-script-hash (p2sh) ScriptPubKey</div>
</div>
<div class="paragraph">
<p>The hash digest here is the hash160 of the RedeemScript, or what was previously the ScriptPubKey.
We&#8217;re locking the funds to the <em>hash</em> of the RedeemScript, which needs to be revealed at unlock time.</p>
</div>
<div class="paragraph">
<p>Creating the ScriptSig for a p2sh script involves not only revealing the RedeemScript, but also unlocking the RedeemScript.
At this point, you might be wondering where the RedeemScript is stored. It&#8217;s not on the blockchain until actual redemption, so it must be stored by the creator of the p2sh address.
If the RedeemScript is lost and cannot be reconstructed, the funds are lost, so it&#8217;s very important to keep track of it!</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">
<div class="title">Importance of Keeping the RedeemScript</div>
<div class="paragraph">
<p>If you are receiving to a p2sh address, be sure to store and back up the RedeemScript!
Better yet, make it easy to reconstruct!</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The ScriptSig for the 2-of-2 multisig looks like <a href="#pay_to_script_has_p2sh_scriptsig">Pay-to-script-hash (p2sh) ScriptSig</a>.</p>
</div>
<div id="pay_to_script_has_p2sh_scriptsig" class="imageblock">
<div class="content">
<img src="images/prbc_0812.png" alt="p2sh ScriptSig">
</div>
<div class="title">Figure 12. Pay-to-script-hash (p2sh) ScriptSig</div>
</div>
<div class="paragraph">
<p>This produces the combined script in <a href="#p2sh_combined">p2sh combined script</a>.</p>
</div>
<div id="p2sh_combined" class="imageblock">
<div class="content">
<img src="images/prbc_0813.png" alt="p2sh Combined script">
</div>
<div class="title">Figure 13. p2sh combined script</div>
</div>
<div class="paragraph">
<p>As before, <code>OP_0</code> is there because of the <code>OP_CHECKMULTISIG</code> bug.
The key to understanding p2sh is the execution of the exact sequence shown in <a href="#p2sh_pattern_that_executes_the_special_rule">p2sh pattern that executes the special rule</a>.</p>
</div>
<div id="p2sh_pattern_that_executes_the_special_rule" class="imageblock">
<div class="content">
<img src="images/prbc_0814.png" alt="p2sh Pattern">
</div>
<div class="title">Figure 14. p2sh pattern that executes the special rule</div>
</div>
<div class="paragraph">
<p>Upon execution of this sequence, if the stack is left with a 1, the RedeemScript is inserted into the Script command set.
In other words, if we reveal a RedeemScript whose hash160 is the same as the hash160 in the ScriptPubKey, that RedeemScript acts like the ScriptPubKey instead.
We hash the script that locks the funds and put that into the blockchain instead of the script itself.
This is why we call this ScriptPubKey pay-to-script-<em>hash</em>.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s go through exactly how this works.
We start with the Script commands (<a href="#p2sh_start">p2sh start</a>).</p>
</div>
<div id="p2sh_start" class="imageblock">
<div class="content">
<img src="images/prbc_0815.png" alt="p2sh start">
</div>
<div class="title">Figure 15. p2sh start</div>
</div>
<div class="paragraph">
<p><code>OP_0</code> will push a 0 to the stack, and the two signatures and the RedeemScript will be pushed to the stack directly, leading to <a href="#p2sh_step_1">p2sh step 1</a>.</p>
</div>
<div id="p2sh_step_1" class="imageblock">
<div class="content">
<img src="images/prbc_0816.png" alt="p2sh step 1">
</div>
<div class="title">Figure 16. p2sh step 1</div>
</div>
<div class="paragraph">
<p><code>OP_HASH160</code> will hash the RedeemScript, which will make the stack look like <a href="#p2sh_step_2">p2sh step 2</a>.</p>
</div>
<div id="p2sh_step_2" class="imageblock">
<div class="content">
<img src="images/prbc_0817.png" alt="p2sh step 2">
</div>
<div class="title">Figure 17. p2sh step 2</div>
</div>
<div class="paragraph">
<p>The 20-byte hash will be pushed to the stack (<a href="#p2sh_step_3">p2sh step 3</a>).</p>
</div>
<div id="p2sh_step_3" class="imageblock">
<div class="content">
<img src="images/prbc_0818.png" alt="p2sh step 3">
</div>
<div class="title">Figure 18. p2sh step 3</div>
</div>
<div class="paragraph">
<p>And finally, <code>OP_EQUAL</code> will compare the top two elements.
If the software checking this transaction is pre-BIP0016, we will end up with <a href="#p2sh_end_if_evaluating_with_pre_bip0016_software">p2sh end if evaluating with pre-BIP0016 software</a>.</p>
</div>
<div id="p2sh_end_if_evaluating_with_pre_bip0016_software" class="imageblock">
<div class="content">
<img src="images/prbc_0819.png" alt="p2sh pre-BIP0016 End">
</div>
<div class="title">Figure 19. p2sh end if evaluating with pre-BIP0016 software</div>
</div>
<div class="paragraph">
<p>This would end evaluation for pre-BIP0016 nodes and the result would be valid, assuming the hashes are equal.</p>
</div>
<div class="paragraph">
<p>On the other hand, BIP0016 nodes, which as of this writing are the vast majority, will parse the RedeemScript as Script commands (<a href="#p2sh_redeemscript">p2sh RedeemScript</a>).</p>
</div>
<div id="p2sh_redeemscript" class="imageblock">
<div class="content">
<img src="images/prbc_0820.png" alt="p2sh RedeemScript">
</div>
<div class="title">Figure 20. p2sh RedeemScript</div>
</div>
<div class="paragraph">
<p>These go into the Script column as commands (<a href="#p2sh_step_4">p2sh step 4</a>).</p>
</div>
<div id="p2sh_step_4" class="imageblock">
<div class="content">
<img src="images/prbc_0821.png" alt="p2sh step 4">
</div>
<div class="title">Figure 21. p2sh step 4</div>
</div>
<div class="paragraph">
<p><code>OP_2</code> pushes a 2 to the stack, the pubkeys are also pushed, and a final <code>OP_2</code> pushes another 2 to the stack (<a href="#p2sh_step_5">p2sh step 5</a>).</p>
</div>
<div id="p2sh_step_5" class="imageblock">
<div class="content">
<img src="images/prbc_0822.png" alt="p2sh step 5">
</div>
<div class="title">Figure 22. p2sh step 5</div>
</div>
<div class="paragraph">
<p><code>OP_CHECKMULTISIG</code> consumes <em>m</em> + <em>n</em> + 3 elements, which is the entire stack, and we end the same way we did for bare multisig (<a href="#p2sh_end_for_post_bip_0016_software">p2sh end for post-BIP0016 software</a>).</p>
</div>
<div id="p2sh_end_for_post_bip_0016_software" class="imageblock">
<div class="content">
<img src="images/prbc_0823.png" alt="p2sh End">
</div>
<div class="title">Figure 23. p2sh end for post-BIP0016 software</div>
</div>
<div class="paragraph">
<p>The RedeemScript substitution is a bit hacky, and there&#8217;s special-cased code in Bitcoin software to handle this.
Why wasn&#8217;t something a lot less hacky and more intuitive chosen?
BIP0012 was a competing proposal at the time that used <code>OP_EVAL</code> and was considered more elegant.
A ScriptPubKey like <a href="#op_eval_would_have_been_an_command_which_adds_additional_commands_based_on_the_top_element">OP_EVAL would have been a command that adds additional commands based on the top element</a> would have worked with BIP0012.</p>
</div>
<div id="op_eval_would_have_been_an_command_which_adds_additional_commands_based_on_the_top_element" class="imageblock">
<div class="content">
<img src="images/prbc_0824.png" alt="`OP_EVAL`">
</div>
<div class="title">Figure 24. OP_EVAL would have been a command that adds additional commands based on the top element</div>
</div>
<div class="paragraph">
<p><code>OP_EVAL</code> would have consumed the top element of the stack and interpreted that as Script commands to be put into the Script column.</p>
</div>
<div class="paragraph">
<p>Unfortunately, this more elegant solution comes with an unwanted side effect, namely Turing completeness.
Turing completeness is undesirable as it makes the security of a smart contract much harder to guarantee (see <a href="#chapter_script">[chapter_script]</a>).
Thus, the more hacky but more secure option of special-casing was chosen in BIP0016.
BIP0016 (or p2sh) was implemented in 2011 and continues to be a part of the network today.</p>
</div>
</div>
<div class="sect2">
<h3 id="_coding_p2sh">Coding p2sh</h3>
<div class="paragraph">
<p>The special pattern of RedeemScript, <code>OP_HASH160</code>, hash160, and <code>OP_EQUAL</code> needs handling.
The <code>evaluate</code> method in <em>script.py</em> is where we handle the special case:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-python" data-lang="python">class Script:
...
    def evaluate(self, z):
...
        while len(commands) &gt; 0:
            command = commands.pop(0)
            if type(command) == int:
...
            else:
                stack.append(cmd)
                if len(cmds) == 3 and cmds[0] == 0xa9 \
                    and type(cmds[1]) == bytes and len(cmds[1]) == 20 \
                    and cmds[2] == 0x87:  # <b class="conum">(1)</b>
                    cmds.pop()  # <b class="conum">(2)</b>
                    h160 = cmds.pop()
                    cmds.pop()
                    if not op_hash160(stack):  # <b class="conum">(3)</b>
                        return False
                    stack.append(h160)
                    if not op_equal(stack):
                        return False
                    if not op_verify(stack):  # <b class="conum">(4)</b>
                        LOGGER.info('bad p2sh h160')
                        return False
                    redeem_script = encode_varint(len(cmd)) + cmd  # <b class="conum">(5)</b>
                    stream = BytesIO(redeem_script)
                    cmds.extend(Script.parse(stream).cmds)  # <b class="conum">(6)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p><code>0xa9</code> is <code>OP_HASH160</code>, <code>0x87</code> is <code>OP_EQUAL</code>.
We&#8217;re checking that the next three commands conform to the BIP0016 special pattern.</p>
</li>
<li>
<p>We know that this is <code>OP_HASH160</code>, so we just pop it off.
Similarly, we know the next command is the 20-byte hash value and the third command is <code>OP_EQUAL</code>, which is what we tested for in the <code>if</code> statement above it.</p>
</li>
<li>
<p>We run the <code>OP_HASH160</code>, 20-byte hash push to the stack, and <code>OP_EQUAL</code> as normal.</p>
</li>
<li>
<p>There should be a 1 remaining, which is what <code>op_verify</code> checks for (<code>OP_VERIFY</code> consumes one element and does not put anything back).</p>
</li>
<li>
<p>Because we want to parse the RedeemScript, we need to prepend the length.</p>
</li>
<li>
<p>We extend the command set with the parsed commands from the RedeemScript.</p>
</li>
</ol>
</div>
<div class="sect3">
<h4 id="_more_complicated_scripts">More Complicated Scripts</h4>
<div class="paragraph">
<p>The nice thing about p2sh is that the RedeemScript can be as long as the largest single element from <code>OP_PUSHDATA2</code>, which is 520 bytes.
Multisig is just one possibility.
You can have scripts that define more complicated logic, like "2 of 3 of these keys or 5 of 7 of these other keys."
The main feature of p2sh is that it&#8217;s flexible and at the same time reduces the UTXO set size by pushing the burden of storing part of the script back to the user.</p>
</div>
<div class="paragraph">
<p>In <a href="#chapter_segwit">[chapter_segwit]</a>, p2sh is also used to make Segwit backward compatible.</p>
</div>
</div>
<div class="sect3">
<h4 id="_addresses">Addresses</h4>
<div class="paragraph">
<p>To compute p2sh addresses, we use a process similar to how we compute p2pkh addresses.
The hash160 is prepended with a prefix byte and appended with a checksum.</p>
</div>
<div class="paragraph">
<p>Mainnet p2sh uses the <code>0x05</code> byte, which causes addresses to start with a <code>3</code> in Base58, while testnet p2sh uses the <code>0xc4</code> byte to cause addresses to start with a <code>2</code>.
We can calculate the address using the <code>encode_base58_checksum</code> function from <em>helper.py</em>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-pycon" data-lang="pycon">&gt;&gt;&gt; from helper import encode_base58_checksum
&gt;&gt;&gt; h160 = bytes.fromhex('74d691da1574e6b3c192ecfb52cc8984ee7b6c56')
&gt;&gt;&gt; print(encode_base58_checksum(b'\x05' + h160))
3CLoMMyuoDQTPRD3XYZtCvgvkadrAdvdXh</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_exercise_2">Exercise 2</h4>
<div class="paragraph">
<p>Write the <code>h160_to_p2pkh_address</code> function that converts a 20-byte hash160 into a p2pkh address.</p>
</div>
</div>
<div class="sect3">
<h4 id="_exercise_3">Exercise 3</h4>
<div class="paragraph">
<p>Write the <code>h160_to_p2sh_address</code> function that converts a 20-byte hash160 into a p2sh address.</p>
</div>
</div>
<div class="sect3">
<h4 id="_p2sh_signature_verification">p2sh Signature Verification</h4>
<div class="paragraph">
<p>As with p2pkh, one of the tricky aspects of p2sh is verifying the signatures. p2sh signature verification is different from the p2pkh process covered in <a href="#chapter_tx">[chapter_tx]</a>.</p>
</div>
<div class="paragraph">
<p>Unlike with p2pkh, where there&#8217;s only one signature and one public key, we have some number of pubkeys (in SEC format in the RedeemScript) and some equal or smaller number of signatures (in DER format in the ScriptSig).
Thankfully, the signatures have to be in the same order as the pubkeys or the signatures are not considered valid.</p>
</div>
<div class="paragraph">
<p>Once we have a particular signature and public key, we only need the signature hash, or <em>z</em>, to figure out whether the signature is valid (<a href="#validation_of_p2sh_inputs">Validation of p2sh inputs</a>).</p>
</div>
<div id="validation_of_p2sh_inputs" class="imageblock">
<div class="content">
<img src="images/prbc_0825.png" alt="Validation Start">
</div>
<div class="title">Figure 25. Validation of p2sh inputs</div>
</div>
<div class="paragraph">
<p>As with p2pkh, finding the signature hash is the most difficult part of the p2sh signature validation process. We&#8217;ll now proceed to cover this in detail.</p>
</div>
<div class="sect4">
<h5 id="_step_1_empty_all_the_scriptsigs">Step 1: Empty all the ScriptSigs</h5>
<div class="paragraph">
<p>The first step is to empty all the ScriptSigs when checking the signature (<a href="#empty_each_inputs_scriptsig">Empty each input&#8217;s ScriptSig</a>).
The same procedure is used for creating the signature.</p>
</div>
<div id="empty_each_inputs_scriptsig" class="imageblock">
<div class="content">
<img src="images/prbc_0826.png" alt="Validation Step 1">
</div>
<div class="title">Figure 26. Empty each input&#8217;s ScriptSig</div>
</div>
</div>
<div class="sect4">
<h5 id="_step_2_replace_the_scriptsig_of_the_p2sh_input_being_signed_with_the_redeemscript">Step 2: Replace the ScriptSig of the p2sh input being signed with the RedeemScript</h5>
<div class="paragraph">
<p>Each p2sh input has a RedeemScript.
We take the RedeemScript and put that in place of the empty ScriptSig (<a href="#replace_the_scriptsig_of_the_input_were_checking_with_the_redeemscript">Replace the ScriptSig of the input we&#8217;re checking with the RedeemScript</a>).
This is different from p2pkh in that it&#8217;s not the ScriptPubKey.</p>
</div>
<div id="replace_the_scriptsig_of_the_input_were_checking_with_the_redeemscript" class="imageblock">
<div class="content">
<img src="images/prbc_0827.png" alt="Validation Step 2">
</div>
<div class="title">Figure 27. Replace the ScriptSig of the input we&#8217;re checking with the RedeemScript</div>
</div>
</div>
<div class="sect4">
<h5 id="_step_3_append_the_hash_type">Step 3: Append the hash type</h5>
<div class="paragraph">
<p>Last, we add a 4-byte hash type to the end.
This is the same as in p2pkh. The integer corresponding to <code>SIGHASH_ALL</code> is 1 and this has to be encoded in little-endian over 4 bytes, which makes the transaction look like <a href="#append_the_hash_type_sighash_all_or_the_blue_part_at_the_end">Append the hash type (SIGHASH_ALL), 01000000</a>.</p>
</div>
<div id="append_the_hash_type_sighash_all_or_the_blue_part_at_the_end" class="imageblock">
<div class="content">
<img src="images/prbc_0828.png" alt="Validation Step 3">
</div>
<div class="title">Figure 28. Append the hash type (SIGHASH_ALL), 01000000</div>
</div>
<div class="paragraph">
<p>The hash256 of this interpreted as a big-endian integer is our <em>z</em>.
The code for getting our signature hash looks like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-python" data-lang="python">&gt;&gt;&gt; from helper import hash256
&gt;&gt;&gt; modified_tx = bytes.fromhex('0100000001868278ed6ddfb6c1ed3ad5f8181eb0c7a38\
5aa0836f01d5e4789e6bd304d87221a000000475221022626e955ea6ea6d98850c994f9107b036\
b1334f18ca8830bfff1295d21cfdb702103b287eaf122eea69030a0e9feed096bed8045c8b98be\
c453e1ffac7fbdbd4bb7152aeffffffff04d3b11400000000001976a914904a49878c0adfc3aa0\
5de7afad2cc15f483a56a88ac7f400900000000001976a914418327e3f3dda4cf5b9089325a4b9\
5abdfa0334088ac722c0c00000000001976a914ba35042cfe9fc66fd35ac2224eebdafd1028ad2\
788acdc4ace020000000017a91474d691da1574e6b3c192ecfb52cc8984ee7b6c5687000000000\
1000000')
&gt;&gt;&gt; s256 = hash256(modified_tx)
&gt;&gt;&gt; z = int.from_bytes(s256, 'big')
&gt;&gt;&gt; print(hex(z))
0xe71bfa115715d6fd33796948126f40a8cdd39f187e4afb03896795189fe1423c</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now that we have our <em>z</em>, we can grab the SEC public key and DER signature from the ScriptSig and RedeemScript  (<a href="#der_and_sec_within_the_p2sh_scriptsig_and_redeemscript">DER signature and SEC pubkey within the p2sh ScriptSig and RedeemScript</a>).</p>
</div>
<div id="der_and_sec_within_the_p2sh_scriptsig_and_redeemscript" class="imageblock">
<div class="content">
<img src="images/prbc_0829.png" alt="DER and SEC">
</div>
<div class="title">Figure 29. DER signature and SEC pubkey within the p2sh ScriptSig and RedeemScript</div>
</div>
<div class="paragraph">
<p>We can now validate the signature:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-python" data-lang="python">&gt;&gt;&gt; from ecc import S256Point, Signature
&gt;&gt;&gt; from helper import hash256
&gt;&gt;&gt; modified_tx = bytes.fromhex('0100000001868278ed6ddfb6c1ed3ad5f8181eb0c7a38\
5aa0836f01d5e4789e6bd304d87221a000000475221022626e955ea6ea6d98850c994f9107b036\
b1334f18ca8830bfff1295d21cfdb702103b287eaf122eea69030a0e9feed096bed8045c8b98be\
c453e1ffac7fbdbd4bb7152aeffffffff04d3b11400000000001976a914904a49878c0adfc3aa0\
5de7afad2cc15f483a56a88ac7f400900000000001976a914418327e3f3dda4cf5b9089325a4b9\
5abdfa0334088ac722c0c00000000001976a914ba35042cfe9fc66fd35ac2224eebdafd1028ad2\
788acdc4ace020000000017a91474d691da1574e6b3c192ecfb52cc8984ee7b6c5687000000000\
1000000')
&gt;&gt;&gt; h256 = hash256(modified_tx)
&gt;&gt;&gt; z = int.from_bytes(h256, 'big')  # <b class="conum">(1)</b>
&gt;&gt;&gt; sec = bytes.fromhex('022626e955ea6ea6d98850c994f9107b036b1334f18ca8830bfff\
1295d21cfdb70')
&gt;&gt;&gt; der = bytes.fromhex('3045022100dc92655fe37036f47756db8102e0d7d5e28b3beb83a\
8fef4f5dc0559bddfb94e02205a36d4e4e6c7fcd16658c50783e00c341609977aed3ad00937bf4\
ee942a89937')
&gt;&gt;&gt; point = S256Point.parse(sec)
&gt;&gt;&gt; sig = Signature.parse(der)
&gt;&gt;&gt; print(point.verify(z, sig))
True</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p><code>z</code> is from the code on page 185.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>We&#8217;ve verified one of the two signatures that are required to unlock this p2sh <span class="keep-together">multisig</span>.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_exercise_4">Exercise 4</h4>
<div class="paragraph">
<p>Validate the second signature from the preceding transaction.</p>
</div>
</div>
<div class="sect3">
<h4 id="_exercise_5">Exercise 5</h4>
<div class="paragraph">
<p>Modify the <code>sig_hash</code> and <code>verify_input</code> methods to be able to verify p2sh <span class="keep-together">transactions</span>.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_conclusion">Conclusion</h3>
<div class="paragraph">
<p>In this chapter we learned how p2sh ScriptPubKeys are created and how they&#8217;re redeemed.
We&#8217;ve covered transactions for the last four chapters; we now turn to how they are grouped in blocks.</p>
</div>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Last updated 2021-11-22 19:07:17 -0600
</div>
</div>
</body>
</html>