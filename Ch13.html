<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.12">
<title>Segwit</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700">
<style>
/* Asciidoctor default stylesheet | MIT License | https://asciidoctor.org */
/* Uncomment @import statement to use as custom stylesheet */
/*@import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700";*/
article,aside,details,figcaption,figure,footer,header,hgroup,main,nav,section{display:block}
audio,video{display:inline-block}
audio:not([controls]){display:none;height:0}
html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}
a{background:none}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
abbr[title]{border-bottom:1px dotted}
b,strong{font-weight:bold}
dfn{font-style:italic}
hr{-moz-box-sizing:content-box;box-sizing:content-box;height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type="button"],input[type="reset"],input[type="submit"]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type="checkbox"],input[type="radio"]{box-sizing:border-box;padding:0}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,*::before,*::after{-moz-box-sizing:border-box;-webkit-box-sizing:border-box;box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;font-weight:400;font-style:normal;line-height:1;position:relative;cursor:auto;tab-size:4;word-wrap:anywhere;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
img,object,svg{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:0}
p{font-family:inherit;font-weight:400;font-size:1em;line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #dddddf;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em;height:0}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{font-size:1em;line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0;font-size:1em}
ul.square li ul,ul.circle li ul,ul.disc li ul{list-style:inherit}
ul.square{list-style-type:square}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
abbr,acronym{text-transform:uppercase;font-size:90%;color:rgba(0,0,0,.8);border-bottom:1px dotted #ddd;cursor:help}
abbr{text-transform:none}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote cite{display:block;font-size:.9375em;color:rgba(0,0,0,.6)}
blockquote cite::before{content:"\2014 \0020"}
blockquote cite a,blockquote cite a:visited{color:rgba(0,0,0,.6)}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}
table{background:#fff;margin-bottom:1.25em;border:solid 1px #dedede;word-wrap:normal}
table thead,table tfoot{background:#f7f8f7}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt{background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{line-height:1.6}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.center{margin-left:auto;margin-right:auto}
.stretch{width:100%}
.clearfix::before,.clearfix::after,.float-group::before,.float-group::after{content:" ";display:table}
.clearfix::after,.float-group::after{clear:both}
:not(pre).nobreak{word-wrap:normal}
:not(pre).nowrap{white-space:nowrap}
:not(pre).pre-wrap{white-space:pre-wrap}
:not(pre):not([class^=L])>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background:#f7f7f8;-webkit-border-radius:4px;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed}
pre{color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;line-height:1.45;text-rendering:optimizeSpeed}
pre code,pre pre{color:inherit;font-size:inherit;line-height:inherit}
pre>code{display:block}
pre.nowrap,pre.nowrap pre{white-space:pre;word-wrap:normal}
em em{font-style:normal}
strong strong{font-weight:400}
.keyseq{color:rgba(51,51,51,.8)}
kbd{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;display:inline-block;color:rgba(0,0,0,.8);font-size:.65em;line-height:1.45;background:#f7f7f7;border:1px solid #ccc;-webkit-border-radius:3px;border-radius:3px;-webkit-box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em white inset;box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em #fff inset;margin:0 .15em;padding:.2em .5em;vertical-align:middle;position:relative;top:-.1em;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menuref{color:#000}
.menuseq b:not(.caret),.menuref{font-weight:inherit}
.menuseq{word-spacing:-.02em}
.menuseq b.caret{font-size:1.25em;line-height:.8}
.menuseq i.caret{font-weight:bold;text-align:center;width:.45em}
b.button::before,b.button::after{position:relative;top:-1px;font-weight:400}
b.button::before{content:"[";padding:0 3px 0 2px}
b.button::after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin-left:auto;margin-right:auto;margin-top:0;margin-bottom:0;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header::before,#header::after,#content::before,#content::after,#footnotes::before,#footnotes::after,#footer::before,#footer::after{content:" ";display:table}
#header::after,#content::after,#footnotes::after,#footer::after{clear:both}
#content{margin-top:1.25em}
#content::before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #dddddf}
#header>h1:only-child,body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #dddddf;padding-bottom:8px}
#header .details{border-bottom:1px solid #dddddf;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:-ms-flexbox;display:-webkit-flex;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span::before{content:"\00a0\2013\00a0"}
#header .details br+span.author::before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark::before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber::after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #dddddf;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #e7e7e9;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc li{line-height:1.3334;margin-top:.3334em}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
#toc.toc2{margin-top:0!important;background:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #e7e7e9;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #e7e7e9;left:auto;right:0}}
@media screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}
#content #toc{border-style:solid;border-width:1px;border-color:#e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;-webkit-border-radius:4px;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:none;background:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:rgba(255,255,255,.8);line-height:1.44}
#content{margin-bottom:.625em}
.sect1{padding-bottom:.625em}
@media screen and (min-width:768px){#content{margin-bottom:1.25em}
.sect1{padding-bottom:1.25em}}
.sect1:last-child{padding-bottom:0}
.sect1+.sect1{border-top:1px solid #e7e7e9}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor::before,h2>a.anchor::before,h3>a.anchor::before,#toctitle>a.anchor::before,.sidebarblock>.content>.title>a.anchor::before,h4>a.anchor::before,h5>a.anchor::before,h6>a.anchor::before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
details,.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
details>summary:first-of-type{cursor:pointer;display:list-item;outline:none;margin-bottom:.75em}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock.fit-content>caption.title{white-space:nowrap;width:0}
.paragraph.lead>p,#preamble>.sectionbody>[class="paragraph"]:first-of-type p{font-size:1.21875em;line-height:1.6;color:rgba(0,0,0,.85)}
table.tableblock #preamble>.sectionbody>[class="paragraph"]:first-of-type p{font-size:inherit}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #dddddf;color:rgba(0,0,0,.6);word-wrap:anywhere}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border-style:solid;border-width:1px;border-color:#e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;-webkit-border-radius:4px;border-radius:4px}
.exampleblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child{margin-bottom:0}
.sidebarblock{border-style:solid;border-width:1px;border-color:#dbdbd6;margin-bottom:1.25em;padding:1.25em;background:#f3f3f2;-webkit-border-radius:4px;border-radius:4px}
.sidebarblock>:first-child{margin-top:0}
.sidebarblock>:last-child{margin-bottom:0}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock>.content>pre{-webkit-border-radius:4px;border-radius:4px;overflow-x:auto;padding:1em;font-size:.8125em}
@media screen and (min-width:768px){.literalblock pre,.listingblock>.content>pre{font-size:.90625em}}
@media screen and (min-width:1280px){.literalblock pre,.listingblock>.content>pre{font-size:1em}}
.literalblock pre,.listingblock>.content>pre:not(.highlight),.listingblock>.content>pre[class="highlight"],.listingblock>.content>pre[class^="highlight "]{background:#f7f7f8}
.literalblock.output pre{color:#f7f7f8;background:rgba(0,0,0,.9)}
.listingblock>.content{position:relative}
.listingblock code[data-lang]::before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:inherit;opacity:.5}
.listingblock:hover code[data-lang]::before{display:block}
.listingblock.terminal pre .command::before{content:attr(data-prompt);padding-right:.5em;color:inherit;opacity:.5}
.listingblock.terminal pre .command:not([data-prompt])::before{content:"$"}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;-webkit-border-radius:4px;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.prettyprint{background:#f7f7f8}
pre.prettyprint .linenums{line-height:1.45;margin-left:2em}
pre.prettyprint li{background:none;list-style-type:inherit;padding-left:0}
pre.prettyprint li code[data-lang]::before{opacity:1}
pre.prettyprint li:not(:first-child) code[data-lang]::before{display:none}
table.linenotable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.linenotable td[class]{color:inherit;vertical-align:top;padding:0;line-height:inherit;white-space:normal}
table.linenotable td.code{padding-left:.75em}
table.linenotable td.linenos{border-right:1px solid currentColor;opacity:.35;padding-right:.5em}
pre.pygments .lineno{border-right:1px solid currentColor;opacity:.35;display:inline-block;margin-right:.75em}
pre.pygments .lineno::before{content:"";margin-right:-.125em}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock:not(.excerpt)>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote::before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.75em;margin-right:.5ex;text-align:right}
.verseblock{margin:0 1em 1.25em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.025em;color:rgba(0,0,0,.6)}
.quoteblock.abstract blockquote::before,.quoteblock.excerpt blockquote::before,.quoteblock .quoteblock blockquote::before{display:none}
.quoteblock.abstract blockquote,.quoteblock.abstract p,.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{line-height:1.6;word-spacing:0}
.quoteblock.abstract{margin:0 1em 1.25em;display:block}
.quoteblock.abstract>.title{margin:0 0 .375em;font-size:1.15em;text-align:center}
.quoteblock.excerpt>blockquote,.quoteblock .quoteblock{padding:0 0 .25em 1em;border-left:.25em solid #dddddf}
.quoteblock.excerpt,.quoteblock .quoteblock{margin-left:0}
.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{color:inherit;font-size:1.0625rem}
.quoteblock.excerpt .attribution,.quoteblock .quoteblock .attribution{color:inherit;text-align:left;margin-right:0}
p.tableblock:last-child{margin-bottom:0}
td.tableblock>.content{margin-bottom:1.25em;word-wrap:anywhere}
td.tableblock>.content>:last-child{margin-bottom:-1.25em}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all>*>tr>*{border-width:1px}
table.grid-cols>*>tr>*{border-width:0 1px}
table.grid-rows>*>tr>*{border-width:1px 0}
table.frame-all{border-width:1px}
table.frame-ends{border-width:1px 0}
table.frame-sides{border-width:0 1px}
table.frame-none>colgroup+*>:first-child>*,table.frame-sides>colgroup+*>:first-child>*{border-top-width:0}
table.frame-none>:last-child>:last-child>*,table.frame-sides>:last-child>:last-child>*{border-bottom-width:0}
table.frame-none>*>tr>:first-child,table.frame-ends>*>tr>:first-child{border-left-width:0}
table.frame-none>*>tr>:last-child,table.frame-ends>*>tr>:last-child{border-right-width:0}
table.stripes-all tr,table.stripes-odd tr:nth-of-type(odd),table.stripes-even tr:nth-of-type(even),table.stripes-hover tr:hover{background:#f8f8f7}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
ol>li p,ul>li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.checklist,ul.none,ol.none,ul.no-bullet,ol.no-bullet,ol.unnumbered,ul.unstyled,ol.unstyled{list-style-type:none}
ul.no-bullet,ol.no-bullet,ol.unnumbered{margin-left:.625em}
ul.unstyled,ol.unstyled{margin-left:0}
ul.checklist{margin-left:.625em}
ul.checklist li>p:first-child>.fa-square-o:first-child,ul.checklist li>p:first-child>.fa-check-square-o:first-child{width:1.25em;font-size:.8em;position:relative;bottom:.125em}
ul.checklist li>p:first-child>input[type="checkbox"]:first-child{margin-right:.25em}
ul.inline{display:-ms-flexbox;display:-webkit-box;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap;list-style:none;margin:0 0 .625em -1.25em}
ul.inline>li{margin-left:1.25em}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1,td.hdlist2{vertical-align:top;padding:0 .625em}
td.hdlist1{font-weight:bold;padding-bottom:1.25em}
td.hdlist2{word-wrap:anywhere}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist td:not([class]):first-child{padding:.4em .75em 0;line-height:1;vertical-align:top}
.colist td:not([class]):first-child img{max-width:none}
.colist td:not([class]):last-child{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:solid 4px #fff;-webkit-box-shadow:0 0 0 1px #ddd;box-shadow:0 0 0 1px #ddd}
.imageblock.left{margin:.25em .625em 1.25em 0}
.imageblock.right{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none;display:inline-block}
a.image object{pointer-events:none}
sup.footnote,sup.footnoteref{font-size:.875em;position:static;vertical-align:super}
sup.footnote a,sup.footnoteref a{text-decoration:none}
sup.footnote a:active,sup.footnoteref a:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em;border-width:1px 0 0}
#footnotes .footnote{padding:0 .375em 0 .225em;line-height:1.3334;font-size:.875em;margin-left:1.2em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none;margin-left:-1.05em}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
.gist .file-data>table{border:0;background:#fff;width:100%;margin-bottom:0}
.gist .file-data>table td.line-data{width:99%}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background:#00fafa}
.black{color:#000}
.black-background{background:#000}
.blue{color:#0000bf}
.blue-background{background:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background:#fa00fa}
.gray{color:#606060}
.gray-background{background:#7d7d7d}
.green{color:#006000}
.green-background{background:#007d00}
.lime{color:#00bf00}
.lime-background{background:#00fa00}
.maroon{color:#600000}
.maroon-background{background:#7d0000}
.navy{color:#000060}
.navy-background{background:#00007d}
.olive{color:#606000}
.olive-background{background:#7d7d00}
.purple{color:#600060}
.purple-background{background:#7d007d}
.red{color:#bf0000}
.red-background{background:#fa0000}
.silver{color:#909090}
.silver-background{background:#bcbcbc}
.teal{color:#006060}
.teal-background{background:#007d7d}
.white{color:#bfbfbf}
.white-background{background:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background:#fafa00}
span.icon>.fa{cursor:default}
a span.icon>.fa{cursor:inherit}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note::before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip::before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning::before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution::before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important::before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background:rgba(0,0,0,.8);-webkit-border-radius:50%;border-radius:50%;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]::after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
dt,th.tableblock,td.content,div.footnote{text-rendering:optimizeLegibility}
h1,h2,p,td.content,span.alt{letter-spacing:-.01em}
p strong,td.content strong,div.footnote strong{letter-spacing:-.005em}
p,blockquote,dt,td.content,span.alt{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background:#fffef7;border-color:#e0e0dc;-webkit-box-shadow:0 1px 4px #e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@page{margin:1.25cm .75cm}
@media print{*{-webkit-box-shadow:none!important;box-shadow:none!important;text-shadow:none!important}
html{font-size:80%}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare)::after,a[href^="https:"]:not(.bare)::after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]::after{content:" (" attr(title) ")"}
pre,blockquote,tr,img,object,svg{page-break-inside:avoid}
thead{display:table-header-group}
svg{max-width:100%}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#header,#content,#footnotes,#footer{max-width:none}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #dddddf!important;padding-bottom:0!important}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span::before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]::before{display:block}
#footer{padding:0 .9375em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
@media print,amzn-kf8{#header>h1:first-child{margin-top:1.25rem}
.sect1{padding:0!important}
.sect1+.sect1{border:0}
#footer{background:none}
#footer-text{color:rgba(0,0,0,.6);font-size:.9em}}
@media amzn-kf8{#header,#content,#footnotes,#footer{padding:0}}
</style>
</head>
<body class="article">
<div id="header">
</div>
<div id="content">
<div class="sect1">
<h2 id="chapter_segwit">Segwit</h2>
<div class="sectionbody">
<div class="paragraph lead">
<p><em>Segwit</em> stands for "segregated witness" and is a backward-compatible upgrade or "soft fork" that activated on the Bitcoin network in August 2017.
While the activation was controversial, the features of this technology require some explanation.
In this chapter, we&#8217;ll explore how Segwit works, why it&#8217;s backward compatible, and what Segwit enables.</p>
</div>
<div class="paragraph">
<p>As a brief overview, Segwit incorporated a multitude of changes:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Block size increase</p>
</li>
<li>
<p>Transaction malleability fix</p>
</li>
<li>
<p>Segwit versioning for clear upgrade paths</p>
</li>
<li>
<p>Quadratic hashing fix</p>
</li>
<li>
<p>Offline wallet fee calculation security</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>It&#8217;s not entirely obvious what Segwit is without looking at how it&#8217;s implemented.
We&#8217;ll start by examining the most basic type of Segwit transaction, pay-to-witness-pubkey-hash.</p>
</div>
<div class="sect2">
<h3 id="_pay_to_witness_pubkey_hash_p2wpkh">Pay-to-Witness-Pubkey-Hash (p2wpkh)</h3>
<div class="paragraph">
<p>Pay-to-witness-pubkey-hash (p2wpkh) is one of four types of scripts defined by Segwit in BIP0141 and BIP0143.
This is a smart contract that acts a lot like pay-to-pubkey-hash and is named similarly for that reason.
The main change from p2pkh is that the data for the ScriptSig is now in the witness field.
The rearrangement is to fix transaction malleability.</p>
</div>
<div class="sect3">
<h4 id="_transaction_malleability">Transaction Malleability</h4>
<div class="paragraph">
<p><em>Transaction malleability</em> is the ability to change the transaction&#8217;s ID without altering the transaction&#8217;s meaning.
Mt. Gox CEO Mark Karpeles cited transaction malleability as the reason why his exchange was not allowing withdrawals back in 2013.</p>
</div>
<div class="paragraph">
<p>Malleability of the ID is an important consideration when creating payment channels, which are the atomic unit of the Lightning Network.
A malleable transaction ID makes the safe creation of payment channel transactions much more difficult.</p>
</div>
<div class="paragraph">
<p>The reason why transaction malleability is a problem at all is because the transaction ID is calculated from the entire transaction.
The ID of the transaction is the hash256 of the transaction.
Most of the fields in a transaction cannot be changed without invalidating the transaction&#8217;s signature (and thus the transaction itself), so from a malleability standpoint, these fields are not a problem.</p>
</div>
<div class="paragraph">
<p>The one field that does allow for some manipulation without invalidating the signature is the ScriptSig field on each input.
The ScriptSig is emptied before creating the signature hash (see <a href="#chapter_tx">[chapter_tx]</a>), so it&#8217;s possible to change the ScriptSig without invalidating the signature.
Also, as we learned in <a href="#chapter_elliptic_curve_cryptography">[chapter_elliptic_curve_cryptography]</a>, signatures contain a random component.
This means that two different ScriptSigs can essentially mean the same thing but be different byte-wise.</p>
</div>
<div class="paragraph">
<p>This makes the ScriptSig field <em>malleable</em>—that is, able to be changed without changing the meaning—and means that the entire transaction, and the transaction ID, are malleable.
A malleable transaction ID means that any <em>dependent</em> transactions (that is, any transaction spending one of the malleable transaction&#8217;s outputs) cannot be constructed in such a way as to guarantee validity.
The previous transaction hash is uncertain, so the dependent transaction&#8217;s transaction input field cannot be guaranteed to be valid.</p>
</div>
<div class="paragraph">
<p>This is not usually a problem as once a transaction enters the blockchain, the transaction ID is fixed and no longer malleable (at least without finding a proof-of-work!).
However, with payment channels, there are dependent transactions created <em>before</em> the funding transaction is added to the blockchain.</p>
</div>
</div>
<div class="sect3">
<h4 id="_fixing_malleability">Fixing Malleability</h4>
<div class="paragraph">
<p>Transaction malleability is fixed by emptying the ScriptSig field and putting the data in another field that&#8217;s not used for ID calculation.
For p2wpkh, the signature and pubkey are the items from ScriptSig, so those get moved to the witness field, which is not used for ID calculation.
This way, the transaction ID stays stable as the malleability vector disappears.
The witness field, and the whole Segwit serialization of a transaction, is only sent to nodes that ask for it.
In other words, old nodes that haven&#8217;t upgraded to Segwit don&#8217;t receive the witness field and don&#8217;t verify the pubkey and signature.</p>
</div>
<div class="paragraph">
<p>If this sounds familiar, it should.
This is similar to how p2sh works (<a href="#chapter_p2sh">[chapter_p2sh]</a>) in that newer nodes do additional validation that older nodes do not, and is the basis for why Segwit is a soft fork (backward-compatible upgrade) and not a hard fork (backward-incompatible upgrade).</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_p2wpkh_transactions">p2wpkh Transactions</h3>
<div class="paragraph">
<p>To understand Segwit, it helps to look at what a transaction looks like when sent to an old node (<a href="#pay_to_witness_pubkey_hash_as_seen_by_pre_bip0141_software">Pay-to-witness-pubkey-hash (p2wpkh) as seen by pre-BIP0141 software</a>) versus a new node (<a href="#pay_to_witness_pubkey_hash_as_seen_by_post_bip0141_software">Pay-to-witness-pubkey-hash (p2wpkh) as seen by post-BIP0141 software</a>).</p>
</div>
<div id="pay_to_witness_pubkey_hash_as_seen_by_pre_bip0141_software" class="imageblock">
<div class="content">
<img src="images/prbc_1301.png" alt="p2wpkh to old nodes">
</div>
<div class="title">Figure 1. Pay-to-witness-pubkey-hash (p2wpkh) as seen by pre-BIP0141 software</div>
</div>
<div id="pay_to_witness_pubkey_hash_as_seen_by_post_bip0141_software" class="imageblock">
<div class="content">
<img src="images/prbc_1302.png" alt="p2wpkh to new nodes">
</div>
<div class="title">Figure 2. Pay-to-witness-pubkey-hash (p2wpkh) as seen by post-BIP0141 software</div>
</div>
<div class="paragraph">
<p>The difference between these two serializations is that the latter transaction (Segwit serialization) has the marker, flag, and witness fields.
Otherwise, the two transactions look similar.
The reason the transaction ID is not malleable is because the first serialization is used for calculating the transaction ID.</p>
</div>
<div class="paragraph">
<p>The witness field in p2wpkh has the signature and pubkey as its two elements.
These will be used for validation for upgraded nodes only.</p>
</div>
<div class="paragraph">
<p>The ScriptPubKey for p2wpkh is <code>OP_0</code> <em>&lt;20-byte hash&gt;</em>.
The ScriptSig, as seen in both serializations, is empty.
The combined script is shown in <a href="#pay_to_witness_pubkey_hash_p2wpkh_scriptpubkey">Pay-to-witness-pubkey-hash (p2wpkh) ScriptPubKey</a>.</p>
</div>
<div id="pay_to_witness_pubkey_hash_p2wpkh_scriptpubkey" class="imageblock">
<div class="content">
<img src="images/prbc_1303.png" alt="p2wpkh ScriptPubKey">
</div>
<div class="title">Figure 3. Pay-to-witness-pubkey-hash (p2wpkh) ScriptPubKey</div>
</div>
<div class="paragraph">
<p>The processing of the combined script starts like <a href="#p2wpkh_start">p2wpkh start</a>.</p>
</div>
<div id="p2wpkh_start" class="imageblock">
<div class="content">
<img src="images/prbc_1304.png" alt="p2wpkh start">
</div>
<div class="title">Figure 4. p2wpkh start</div>
</div>
<div class="paragraph">
<p><code>OP_0</code> pushes a 0 to the stack (<a href="#p2wpkh_step_1">p2wpkh step 1</a>).</p>
</div>
<div id="p2wpkh_step_1" class="imageblock">
<div class="content">
<img src="images/prbc_1305.png" alt="p2wpkh step 1">
</div>
<div class="title">Figure 5. p2wpkh step 1</div>
</div>
<div class="paragraph">
<p>The 20-byte hash is an element, so it&#8217;s pushed to the stack (<a href="#p2wpkh_step_2">p2wpkh step 2</a>).</p>
</div>
<div id="p2wpkh_step_2" class="imageblock">
<div class="content">
<img src="images/prbc_1306.png" alt="p2wpkh step 2">
</div>
<div class="title">Figure 6. p2wpkh step 2</div>
</div>
<div class="paragraph">
<p>At this point, older nodes will stop as there are no more Script commands to be processed.
Since the top element is nonzero, this will be counted as a valid script.
This is very similar to p2sh (<a href="#chapter_p2sh">[chapter_p2sh]</a>) in that older nodes cannot validate further.
Newer nodes, however, have a special Segwit rule much like the special rule for p2sh (see <a href="#chapter_p2sh">[chapter_p2sh]</a>).
Recall that with p2sh, the exact script sequence of <em>&lt;RedeemScript&gt;</em> <code>OP_HASH160</code> <em>&lt;hash&gt;</em> <code>OP_EQUAL</code> triggers a special rule.</p>
</div>
<div class="paragraph">
<p>In the case of p2wpkh, the script sequence is <code>OP_0</code> <em>&lt;20-byte hash&gt;</em>.
When that script sequence is encountered, the pubkey and signature from the witness field and the 20-byte hash are added to the command set in exactly the same sequence as with p2pkh, namely <em>&lt;signature&gt;</em> <em>&lt;pubkey&gt;</em> <code>OP_DUP OP_HASH160</code> <em>&lt;20-byte hash&gt;</em> <code>OP_EQUALVERIFY OP_CHECKSIG</code>.
<a href="#p2wpkh_step_3">p2wpkh step 3</a> shows the state that is encountered next.</p>
</div>
<div id="p2wpkh_step_3" class="imageblock">
<div class="content">
<img src="images/prbc_1307.png" alt="p2wpkh step 3">
</div>
<div class="title">Figure 7. p2wpkh step 3</div>
</div>
<div class="paragraph">
<p>The rest of the processing of p2wpkh is the same as the processing of p2pkh, as seen in <a href="#chapter_script">[chapter_script]</a>.
The end state is a single 1 on the stack if and only if the 20-byte hash is the hash160 of the pubkey and the signature is valid (<a href="#p2wpkh_step_4">p2wpkh step 4</a>).</p>
</div>
<div id="p2wpkh_step_4" class="imageblock">
<div class="content">
<img src="images/prbc_1308.png" alt="p2wpkh step 4">
</div>
<div class="title">Figure 8. p2wpkh step 4</div>
</div>
<div class="paragraph">
<p>For an older node, processing stops at <em>&lt;20-byte hash&gt;</em> 0, as older nodes don&#8217;t know the special Segwit rule.
Only upgraded nodes do the rest of the validation, much like with p2sh.
Note that less data is sent over the network to older nodes.
Also, nodes are given the option of not having to download (and hence not verify) transactions that are <em>x</em> blocks old if they don&#8217;t want to.
In a sense, the signature has been witnessed by a bunch of people and a node can choose to trust that this is valid instead of validating directly if it so chooses.</p>
</div>
<div class="paragraph">
<p>Note also that this is a special rule for Segwit version 0.
Segwit version 1 can have a completely different processing path.
<em>&lt;20-byte hash&gt;</em> <code>1</code> could be the special script sequence that triggers a different rule.
Upgrades of Segwit can introduce Schnorr signatures, Graftroot, or even a different scripting system altogether, like Simplicity.
Segwit gives us a clear upgrade path.
Software that understands how to validate Segwit version X will validate such transactions, but software that isn&#8217;t aware of Segwit version X simply processes only up to the point of the special rule.</p>
</div>
</div>
<div class="sect2">
<h3 id="_p2sh_p2wpkh">p2sh-p2wpkh</h3>
<div class="paragraph">
<p>p2wpkh is great, but unfortunately, this is a new type of script and older wallets cannot send bitcoins to p2wpkh ScriptPubKeys.
p2wpkh uses a new address format called Bech32, defined in BIP0173, whose ScriptPubKeys older wallets don&#8217;t know how to create.</p>
</div>
<div class="paragraph">
<p>The Segwit authors found an ingenious way to make Segwit backward compatible by "wrapping" p2wpkh inside p2sh.
This is called "nested" Segwit as the Segwit script is nested in a p2sh RedeemScript.</p>
</div>
<div class="paragraph">
<p>A p2sh-p2wpkh address is a normal p2sh address, but the RedeemScript is <code>OP_0</code> <em>&lt;20-byte hash&gt;</em>, or the ScriptPubKey of p2wpkh.
As with p2wpkh, different transactions are sent to older nodes (<a href="#p2sh_p2wpkh_to_pre_bip0141_software">Pay-to-script-hash-pay-to-witness-pubkey-hash (p2sh-p2wpkh) to pre-BIP0141 software</a>) versus newer nodes (<a href="#p2sh_p2wpkh_to_post_bip0141_software">p2sh-p2wpkh to post-BIP0141 software</a>).</p>
</div>
<div id="p2sh_p2wpkh_to_pre_bip0141_software" class="imageblock">
<div class="content">
<img src="images/prbc_1309.png" alt="p2sh-p2wpkh to Old Nodes">
</div>
<div class="title">Figure 9. Pay-to-script-hash-pay-to-witness-pubkey-hash (p2sh-p2wpkh) to pre-BIP0141 software</div>
</div>
<div id="p2sh_p2wpkh_to_post_bip0141_software" class="imageblock">
<div class="content">
<img src="images/prbc_1310.png" alt="p2sh-p2wpkh to New Nodes">
</div>
<div class="title">Figure 10. p2sh-p2wpkh to post-BIP0141 software</div>
</div>
<div class="paragraph">
<p>The difference from p2wpkh is that the ScriptSig is no longer empty.
The ScriptSig has a RedeemScript, which is equal to the ScriptPubkey in p2wpkh.
As this is a p2sh script, the ScriptPubKey is the same as in any other p2sh script.
The combined script looks like <a href="#p2sh_p2wpkh_scriptpubkey_is_the_same_as_a_normal_p2sh_scriptpubkey">p2sh-p2wpkh ScriptPubKey is the same as a normal p2sh ScriptPubKey</a>.</p>
</div>
<div id="p2sh_p2wpkh_scriptpubkey_is_the_same_as_a_normal_p2sh_scriptpubkey" class="imageblock">
<div class="content">
<img src="images/prbc_1311.png" alt="p2sh-p2wpkh ScriptPubKey">
</div>
<div class="title">Figure 11. p2sh-p2wpkh ScriptPubKey is the same as a normal p2sh ScriptPubKey</div>
</div>
<div class="paragraph">
<p>We start the script evaluation like in <a href="#p2sh_p2wpkh_start">p2sh-p2wpkh start</a>.</p>
</div>
<div id="p2sh_p2wpkh_start" class="imageblock">
<div class="content">
<img src="images/prbc_1312.png" alt="p2sh-p2wpkh start">
</div>
<div class="title">Figure 12. p2sh-p2wpkh start</div>
</div>
<div class="paragraph">
<p>Notice that the commands to be processed are exactly what triggers the p2sh special rule.
The RedeemScript goes on the stack (<a href="#p2sh_p2wpkh_step_1">p2sh-p2wpkh step 1</a>).</p>
</div>
<div id="p2sh_p2wpkh_step_1" class="imageblock">
<div class="content">
<img src="images/prbc_1313.png" alt="p2sh-p2wpkh step 1">
</div>
<div class="title">Figure 13. p2sh-p2wpkh step 1</div>
</div>
<div class="paragraph">
<p>The <code>OP_HASH160</code> will return the RedeemScript&#8217;s hash (<a href="#p2sh_p2wpkh_step_2">p2sh-p2wpkh step 2</a>).</p>
</div>
<div id="p2sh_p2wpkh_step_2" class="imageblock">
<div class="content">
<img src="images/prbc_1314.png" alt="p2sh-p2wpkh step 2">
</div>
<div class="title">Figure 14. p2sh-p2wpkh step 2</div>
</div>
<div class="paragraph">
<p>The hash will go on the stack, and we then get to <code>OP_EQUAL</code> (<a href="#p2sh_p2wpkh_step_3">p2sh-p2wpkh step 3</a>).</p>
</div>
<div id="p2sh_p2wpkh_step_3" class="imageblock">
<div class="content">
<img src="images/prbc_1315.png" alt="p2sh-p2wpkh step 3">
</div>
<div class="title">Figure 15. p2sh-p2wpkh step 3</div>
</div>
<div class="paragraph">
<p>At this point, if the hashes are equal, pre-BIP0016 nodes will simply mark the input as valid, as they are unaware of the p2sh validation rules.
However, post-BIP0016 nodes recognize the special script sequence for p2sh, so the RedeemScript will then be evaluated as Script commands.
The RedeemScript is <code>OP_0</code> <em>&lt;20-byte hash&gt;</em>, which is the same as the ScriptPubKey for p2wpkh.
This makes the script state look like <a href="#p2sh_p2wpkh_step_4">p2sh-p2wpkh step 4</a>.</p>
</div>
<div id="p2sh_p2wpkh_step_4" class="imageblock">
<div class="content">
<img src="images/prbc_1316.png" alt="p2sh-p2wpkh step 4">
</div>
<div class="title">Figure 16. p2sh-p2wpkh step 4</div>
</div>
<div class="paragraph">
<p>This should look familiar, as this is the state that p2wpkh starts with.
After <code>OP_0</code> and the 20-byte hash we are left with <a href="#p2sh_p2wpkh_step_5">p2sh-p2wpkh step 5</a>.</p>
</div>
<div id="p2sh_p2wpkh_step_5" class="imageblock">
<div class="content">
<img src="images/prbc_1317.png" alt="p2sh-p2wpkh step 5">
</div>
<div class="title">Figure 17. p2sh-p2wpkh step 5</div>
</div>
<div class="paragraph">
<p>At this point, pre-Segwit nodes will mark this input as valid as they are unaware of the Segwit validation rules.
However, post-Segwit nodes will recognize the special script sequence for p2wpkh.
The signature and pubkey from the witness field along with the 20-byte hash will add the p2pkh commands (<a href="#p2sh_p2wpkh_step_6">p2sh-p2wpkh step 6</a>).</p>
</div>
<div id="p2sh_p2wpkh_step_6" class="imageblock">
<div class="content">
<img src="images/prbc_1318.png" alt="p2sh-p2wpkh step 6">
</div>
<div class="title">Figure 18. p2sh-p2wpkh step 6</div>
</div>
<div class="paragraph">
<p>The rest of the processing is the same as p2pkh (<a href="#chapter_script">[chapter_script]</a>).
Assuming the signature and pubkey are valid, we are left with <a href="#p2sh_p2wpkh_end">p2sh-p2wpkh end</a>.</p>
</div>
<div id="p2sh_p2wpkh_end" class="imageblock">
<div class="content">
<img src="images/prbc_1319.png" alt="p2sh-p2wpkh end">
</div>
<div class="title">Figure 19. p2sh-p2wpkh end</div>
</div>
<div class="paragraph">
<p>As you can see, a p2sh-p2wpkh transaction is backward compatible all the way to before BIP0016.
A pre-BIP0016 node would consider the script valid once the RedeemScripts were equal, and a post-BIP0016, pre-Segwit node would consider the script valid at the 20-byte hash.
Both would not do the full validation and would accept the transaction.
A post-Segwit node would do the complete validation, including checking the signature and pubkey.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="title">Can Anyone Spend Segwit Outputs?</div>
<div class="paragraph">
<p>Detractors of Segwit have referred to Segwit outputs as "anyone-can-spend."
This would have been true if the Bitcoin community had rejected Segwit.
In other words, if an economically significant part of the Bitcoin community had refused to do the Segwit validation and actively split from the network by accepting transactions that were not Segwit-valid, the outputs would have been anyone-can-spend.
However, due to a variety of economic incentives, Segwit was activated on the network, there was no network split, a lot of bitcoins are now locked in Segwit outputs, and Segwit transactions are validated per the soft-fork rules by the vast economic majority of nodes.
We can now say confidently that the detractors were wrong.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_coding_p2wpkh_and_p2sh_p2wpkh">Coding p2wpkh and p2sh-p2wpkh</h3>
<div class="paragraph">
<p>The first change we&#8217;re going to make is to the <code>Tx</code> class, where we need to mark whether the transaction is Segwit or not:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-python" data-lang="python">class Tx:
    command = b'tx'

    def __init__(self, version, tx_ins, tx_outs, 
        locktime, testnet=False, segwit=False):
        self.version = version
        self.tx_ins = tx_ins
        self.tx_outs = tx_outs
        self.locktime = locktime
        self.testnet = testnet
        self.segwit = segwit
        self._hash_prevouts = None
        self._hash_sequence = None
        self._hash_outputs = None</code></pre>
</div>
</div>
<div class="paragraph">
<p>Next, we change the <code>parse</code> method depending on the serialization we receive:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-python" data-lang="python">class Tx:
...
    @classmethod
    def parse(cls, s, testnet=False):
        s.read(4)  # <b class="conum">(1)</b>
        if s.read(1) == b'\x00':  # <b class="conum">(2)</b>
            parse_method = cls.parse_segwit
        else:
            parse_method = cls.parse_legacy
        s.seek(-5, 1)  # <b class="conum">(3)</b>
        return parse_method(s, testnet=testnet)

    @classmethod
    def parse_legacy(cls, s, testnet=False):
        version = little_endian_to_int(s.read(4))   # <b class="conum">(4)</b>
        num_inputs = read_varint(s)
        inputs = []
        for _ in range(num_inputs):
            inputs.append(TxIn.parse(s))
        num_outputs = read_varint(s)
        outputs = []
        for _ in range(num_outputs):
            outputs.append(TxOut.parse(s))
        locktime = little_endian_to_int(s.read(4))
        return cls(version, inputs, outputs, locktime, 
                   testnet=testnet, segwit=False)</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>To determine whether we have a Segwit transaction or not, we look at the fifth byte.
The first four are the version, the fifth is the Segwit marker.</p>
</li>
<li>
<p>The fifth byte being 0 is how we tell that this transaction is Segwit (this is not foolproof, but it&#8217;s what we&#8217;re going to use).
We use different parsers depending on whether it&#8217;s Segwit.</p>
</li>
<li>
<p>We put the stream back to the position before we examined the first 5 bytes.</p>
</li>
<li>
<p>We&#8217;ve moved the old <code>parse</code> method to <code>parse_legacy</code>.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Here&#8217;s a parser for the Segwit serialization:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-python" data-lang="python">class Tx:
...
    @classmethod
    def parse_segwit(cls, s, testnet=False):
        version = little_endian_to_int(s.read(4))
        marker = s.read(2)
        if marker != b'\x00\x01':  # <b class="conum">(1)</b>
            raise RuntimeError('Not a segwit transaction {}'.format(marker))
        num_inputs = read_varint(s)
        inputs = []
        for _ in range(num_inputs):
            inputs.append(TxIn.parse(s))
        num_outputs = read_varint(s)
        outputs = []
        for _ in range(num_outputs):
            outputs.append(TxOut.parse(s))
        for tx_in in inputs:  # <b class="conum">(2)</b>
            num_items = read_varint(s)
            items = []
            for _ in range(num_items):
                item_len = read_varint(s)
                if item_len == 0:
                    items.append(0)
                else:
                    items.append(s.read(item_len))
            tx_in.witness = items
        locktime = little_endian_to_int(s.read(4))
        return cls(version, inputs, outputs, locktime, 
                   testnet=testnet, segwit=True)</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>There are two new fields; one of them is the Segwit marker.</p>
</li>
<li>
<p>The second new field is witness, which contains items for each input.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>We now code the corresponding changes to the serialization methods:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-python" data-lang="python">class Tx:
...
    def serialize(self):
        if self.segwit:
            return self.serialize_segwit()
        else:
            return self.serialize_legacy()

    def serialize_legacy(self):  # <b class="conum">(1)</b>
        result = int_to_little_endian(self.version, 4)
        result += encode_varint(len(self.tx_ins))
        for tx_in in self.tx_ins:
            result += tx_in.serialize()
        result += encode_varint(len(self.tx_outs))
        for tx_out in self.tx_outs:
            result += tx_out.serialize()
        result += int_to_little_endian(self.locktime, 4)
        return result

    def serialize_segwit(self):
        result = int_to_little_endian(self.version, 4)
        result += b'\x00\x01'  # <b class="conum">(2)</b>
        result += encode_varint(len(self.tx_ins))
        for tx_in in self.tx_ins:
            result += tx_in.serialize()
        result += encode_varint(len(self.tx_outs))
        for tx_out in self.tx_outs:
            result += tx_out.serialize()
        for tx_in in self.tx_ins:  # <b class="conum">(3)</b>
            result += int_to_little_endian(len(tx_in.witness), 1)
            for item in tx_in.witness:
                if type(item) == int:
                    result += int_to_little_endian(item, 1)
                else:
                    result += encode_varint(len(item)) + item
        result += int_to_little_endian(self.locktime, 4)
        return result</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>What used to be called <code>serialize</code> is now <code>serialize_legacy</code>.</p>
</li>
<li>
<p>The Segwit serialization adds the markers.</p>
</li>
<li>
<p>The witness is serialized at the end.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>We also have to change the <code>hash</code> method to use the legacy serialization, even for Segwit transactions, as that will keep the transaction ID stable:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-python" data-lang="python">class Tx:
...
    def hash(self):
        '''Binary hash of the legacy serialization'''
        return hash256(self.serialize_legacy())[::-1]</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>verify_input</code> method requires a different <code>z</code> for Segwit transactions.
The Segwit transaction signature hash calculation is specified in BIP0143.
In addition, the witness field is passed through to the script evaluation engine:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-python" data-lang="python">class Tx:
...
    def verify_input(self, input_index):
        tx_in = self.tx_ins[input_index]
        script_pubkey = tx_in.script_pubkey(testnet=self.testnet)
        if script_pubkey.is_p2sh_script_pubkey():
            command = tx_in.script_sig.commands[-1]
            raw_redeem = int_to_little_endian(len(command), 1) + command
            redeem_script = Script.parse(BytesIO(raw_redeem))
            if redeem_script.is_p2wpkh_script_pubkey():  # <b class="conum">(1)</b>
                z = self.sig_hash_bip143(input_index, redeem_script)  # <b class="conum">(2)</b>
                witness = tx_in.witness
            else:
                z = self.sig_hash(input_index, redeem_script)
                witness = None
        else:
            if script_pubkey.is_p2wpkh_script_pubkey():  # <b class="conum">(3)</b>
                z = self.sig_hash_bip143(input_index)  # <b class="conum">(2)</b>
                witness = tx_in.witness
            else:
                z = self.sig_hash(input_index)
                witness = None
        combined_script = tx_in.script_sig + tx_in.script_pubkey(self.testnet)
        return combined_script.evaluate(z, witness)  # <b class="conum">(4)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>This handles the p2sh-p2wpkh case.</p>
</li>
<li>
<p>The BIP0143 signature hash generation code is in <em>tx.py</em> of this chapter&#8217;s code.</p>
</li>
<li>
<p>This handles the p2wpkh case.</p>
</li>
<li>
<p>The witness passes through to the evaluation engine so that p2wpkh can construct the right commands.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>We also define what a p2wpkh script looks like in <em>script.py</em>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-python" data-lang="python">def p2wpkh_script(h160):
    '''Takes a hash160 and returns the p2wpkh ScriptPubKey'''
    return Script([0x00, h160])  # <b class="conum">(1)</b>
...
    def is_p2wpkh_script_pubkey(self):  # <b class="conum">(2)</b>
        return len(self.cmds) == 2 and self.cmds[0] == 0x00 \
            and type(self.cmds[1]) == bytes and len(self.cmds[1]) == 20</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>This is OP_0 <em>&lt;20-byte-hash&gt;</em>.</p>
</li>
<li>
<p>This checks if the current script is a p2wpkh ScriptPubKey.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Last, we need to implement the special rule in the <code>evaluate</code> method.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-python" data-lang="python">class Script:
...
    def evaluate(self, z, witness):
    ...
        while len(commands) &gt; 0:
        ...
            else:
                stack.append(command)
		...
                if len(stack) == 2 and stack[0] == b'' and len(stack[1]) == 20:  # <b class="conum">(1)</b>
                    h160 = stack.pop()
                    stack.pop()
                    cmds.extend(witness)
                    cmds.extend(p2pkh_script(h160).cmds)</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>This is where we execute witness program version 0 for p2wpkh.
We make a p2pkh combined script from the 20-byte hash, signature, and pubkey and evaluate.</p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_pay_to_witness_script_hash_p2wsh">Pay-to-Witness-Script-Hash (p2wsh)</h3>
<div class="paragraph">
<p>While p2wpkh takes care of a major use case, we need something more flexible if we want more complicated (e.g., multisig) scripts.
This is where pay-to-witness-script-hash (p2wsh) comes in. p2wsh is like p2sh, but with all the ScriptSig data in the witness field instead.</p>
</div>
<div class="paragraph">
<p>As with p2wpkh, we send different data to pre-BIP0141 software (<a href="#p2wsh_as_seen_by_pre_bip0141_software">Pay-to-witness-script-hash as seen by pre-BIP0141 software</a>) versus post-BIP0141 software (<a href="#p2wsh_as_seen_by_post_bip0141_software">Pay-to-witness-script-hash as seen by post-BIP0141 software</a>).</p>
</div>
<div id="p2wsh_as_seen_by_pre_bip0141_software" class="imageblock">
<div class="content">
<img src="images/prbc_1320.png" alt="p2wsh to old nodes">
</div>
<div class="title">Figure 20. Pay-to-witness-script-hash as seen by pre-BIP0141 software</div>
</div>
<div id="p2wsh_as_seen_by_post_bip0141_software" class="imageblock">
<div class="content">
<img src="images/prbc_1321.png" alt="p2wsh to new nodes">
</div>
<div class="title">Figure 21. Pay-to-witness-script-hash as seen by post-BIP0141 software</div>
</div>
<div class="paragraph">
<p>The ScriptPubKey for p2wsh script is <code>OP_0</code> <em>&lt;32-byte hash&gt;</em>.
This sequence triggers another special rule.
The ScriptSig, as with p2wpkh, is empty.
When p2wsh outputs are being spent, the combined script looks like <a href="#p2wsh_scriptpubkey">Pay-to-witness-script-hash (p2wsh) ScriptPubKey</a>.</p>
</div>
<div id="p2wsh_scriptpubkey" class="imageblock">
<div class="content">
<img src="images/prbc_1322.png" alt="p2wsh ScriptPubKey">
</div>
<div class="title">Figure 22. Pay-to-witness-script-hash (p2wsh) ScriptPubKey</div>
</div>
<div class="paragraph">
<p>The processing of this script starts similarly to p2wpkh (Figures <a data-type="xref" data-xrefstyle="select:labelnumber" href="#p2wsh_start">#p2wsh_start</a> and <a data-type="xref" data-xrefstyle="select:labelnumber" href="#p2wsh_step_1">#p2wsh_step_1</a>).</p>
</div>
<div id="p2wsh_start" class="imageblock">
<div class="content">
<img src="images/prbc_1323.png" alt="p2wsh start">
</div>
<div class="title">Figure 23. p2sh start</div>
</div>
<div id="p2wsh_step_1" class="imageblock">
<div class="content">
<img src="images/prbc_1324.png" alt="p2wsh step 1">
</div>
<div class="title">Figure 24. p2wsh step 1</div>
</div>
<div class="paragraph">
<p>The 32-byte hash is an element, so it is pushed to the stack (<a href="#p2wsh_step_2">p2wsh step 2</a>).</p>
</div>
<div id="p2wsh_step_2" class="imageblock">
<div class="content">
<img src="images/prbc_1325.png" alt="p2wsh step 2">
</div>
<div class="title">Figure 25. p2wsh step 2</div>
</div>
<div class="paragraph">
<p>As with p2wpkh, older nodes will stop here because there are no more Script commands to be processed.
Newer nodes will recognize the special sequence and do additional validation by looking at the witness field.</p>
</div>
<div class="paragraph">
<p>The witness field for p2wsh in our case is a 2-of-3 multisig (<a href="#p2wsh_witness">p2wsh witness</a>).</p>
</div>
<div id="p2wsh_witness" class="imageblock">
<div class="content">
<img src="images/prbc_1326.png" alt="p2wsh witness">
</div>
<div class="title">Figure 26. p2wsh witness</div>
</div>
<div class="paragraph">
<p>The last item of the witness is called the <em>WitnessScript</em> and must sha256 to the 32-byte hash from the ScriptPubKey.
Note this is sha256, not hash256.
Once the WitnessScript is validated by having the same hash value, it is interpreted as script commands and put into the command set.
The WitnessScript looks like <a href="#p2wsh_witness_script">p2wsh WitnessScript</a>.</p>
</div>
<div id="p2wsh_witness_script" class="imageblock">
<div class="content">
<img src="images/prbc_1327.png" alt="p2wsh WitnessScript">
</div>
<div class="title">Figure 27. p2wsh WitnessScript</div>
</div>
<div class="paragraph">
<p>The rest of the witness field is put on top to produce the command set in <a href="#p2wsh_step_3">p2wsh step 3</a>.</p>
</div>
<div id="p2wsh_step_3" class="imageblock">
<div class="content">
<img src="images/prbc_1328.png" alt="p2wsh step 3">
</div>
<div class="title">Figure 28. p2wsh step 3</div>
</div>
<div class="paragraph">
<p>As you can see, this is a 2-of-3 multisig much like what was explored in <a href="#chapter_p2sh">[chapter_p2sh]</a> (<a href="#p2wsh_step_4">p2wsh step 4</a>).</p>
</div>
<div id="p2wsh_step_4" class="imageblock">
<div class="content">
<img src="images/prbc_1329.png" alt="p2wsh step 4">
</div>
<div class="title">Figure 29. p2wsh step 4</div>
</div>
<div class="paragraph">
<p>If the signatures are valid, we end like <a href="#p2wsh_step_5">p2wsh step 5</a>.</p>
</div>
<div id="p2wsh_step_5" class="imageblock">
<div class="content">
<img src="images/prbc_1330.png" alt="p2wsh step 5">
</div>
<div class="title">Figure 30. p2wsh step 5</div>
</div>
<div class="paragraph">
<p>The WitnessScript is very similar to the RedeemScript in that the sha256 of the serialization is addressed in the ScriptPubKey, but only revealed when the output is being spent.
Once the sha256 of the WitnessScript is found to be the same as the 32-byte hash, the WitnessScript is interpreted as script commands and added to the command set.
The rest of the witness field is then added to the command set as well, producing the final set of commands to be evaluated.
p2wsh is particularly important, as unmalleable multisig transactions are required for creating bidirectional payment channels for the Lightning Network.</p>
</div>
</div>
<div class="sect2">
<h3 id="_p2sh_p2wsh">p2sh-p2wsh</h3>
<div class="paragraph">
<p>Like p2sh-p2wpkh, p2sh-p2wsh is a way to make p2wsh backward compatible.
Again, different transactions are sent to older nodes (<a href="#p2sh_p2wsh_to_pre_bip0141_software">Pay-to-script-hash-pay-to-witness-script-hash (p2sh-p2wsh) to pre-BIP0141 software</a>) versus newer nodes (<a href="#p2sh_p2wsh_to_post_bip0141_software">p2sh-p2wsh to post-BIP0141 software</a>).</p>
</div>
<div id="p2sh_p2wsh_to_pre_bip0141_software" class="imageblock">
<div class="content">
<img src="images/prbc_1331.png" alt="p2sh-p2wsh to Old Nodes">
</div>
<div class="title">Figure 31. Pay-to-script-hash-pay-to-witness-script-hash (p2sh-p2wsh) to pre-BIP0141 software</div>
</div>
<div id="p2sh_p2wsh_to_post_bip0141_software" class="imageblock">
<div class="content">
<img src="images/prbc_1332.png" alt="p2sh-p2wsh to New Nodes">
</div>
<div class="title">Figure 32. p2sh-p2wsh to post-BIP0141 software</div>
</div>
<div class="paragraph pagebreak-before">
<p>As with p2sh-p2wpkh, the ScriptPubKey is indistinguishable from any other p2sh address and the ScriptSig is only the RedeemScript (<a href="#p2sh_p2wsh_scriptpubkey">p2sh-p2wsh ScriptPubKey</a>).</p>
</div>
<div id="p2sh_p2wsh_scriptpubkey" class="imageblock">
<div class="content">
<img src="images/prbc_1311.png" alt="p2sh-p2wsh ScriptPubKey">
</div>
<div class="title">Figure 33. p2sh-p2wsh ScriptPubKey</div>
</div>
<div class="paragraph">
<p>We start the p2sh-p2wsh script evaluation in exactly the same way that p2sh-p2wpkh script evaluation starts (<a href="#p2sh_p2wsh_start">p2sh-p2wsh start</a>).</p>
</div>
<div id="p2sh_p2wsh_start" class="imageblock">
<div class="content">
<img src="images/prbc_1312.png" alt="p2sh-p2wsh start">
</div>
<div class="title">Figure 34. p2sh-p2wsh start</div>
</div>
<div class="paragraph">
<p>The RedeemScript is pushed to the stack (<a href="#p2sh_p2wsh_step_1">p2sh-p2wsh step 1</a>).</p>
</div>
<div id="p2sh_p2wsh_step_1" class="imageblock">
<div class="content">
<img src="images/prbc_1313.png" alt="p2sh-p2wsh step 1">
</div>
<div class="title">Figure 35. p2sh-p2wsh step 1</div>
</div>
<div class="paragraph">
<p>The <code>OP_HASH160</code> will return the RedeemScript&#8217;s hash (<a href="#p2sh_p2wsh_step_2">p2sh-p2wsh step 2</a>).</p>
</div>
<div id="p2sh_p2wsh_step_2" class="imageblock">
<div class="content">
<img src="images/prbc_1314.png" alt="p2sh-p2wsh step 2">
</div>
<div class="title">Figure 36. p2sh-p2wsh step 2</div>
</div>
<div class="paragraph">
<p>The hash is pushed to the stack, and we then get to <code>OP_EQUAL</code> (<a href="#p2sh_p2wsh_step_3">p2sh-p2wsh step 3</a>).</p>
</div>
<div id="p2sh_p2wsh_step_3" class="imageblock">
<div class="content">
<img src="images/prbc_1315.png" alt="p2sh-p2wsh step 3">
</div>
<div class="title">Figure 37. p2sh-p2wsh step 3</div>
</div>
<div class="paragraph">
<p>As with p2sh-p2wpkh, if the hashes are equal, pre-BIP0016 nodes will mark the input as valid as they are unaware of the p2sh validation rules.
However, post-BIP0016 nodes will recognize the special script sequence for p2sh, so the RedeemScript will be interpreted as new script commands.
The RedeemScript is <code>OP_0</code> <em>32-byte hash</em>, which is the same as the ScriptPubKey for p2wsh (<a href="#p2sh_p2wsh_redeemscript">p2sh-p2wsh RedeemScript</a>).</p>
</div>
<div id="p2sh_p2wsh_redeemscript" class="imageblock">
<div class="content">
<img src="images/prbc_1338.png" alt="p2sh-p2wsh RedeemScript">
</div>
<div class="title">Figure 38. p2sh-p2wsh RedeemScript</div>
</div>
<div class="paragraph">
<p>This makes the script state look like <a href="#p2sh_p2wsh_step_4">p2sh-p2wsh step 4</a>.</p>
</div>
<div id="p2sh_p2wsh_step_4" class="imageblock">
<div class="content">
<img src="images/prbc_1323.png" alt="p2sh-p2wsh step 4">
</div>
<div class="title">Figure 39. p2sh-p2wsh step 4</div>
</div>
<div class="paragraph">
<p>Of course, this is the exact same starting state as for p2wsh (<a href="#p2sh_p2wsh_step_5">p2sh-p2wsh step 5</a>).</p>
</div>
<div id="p2sh_p2wsh_step_5" class="imageblock">
<div class="content">
<img src="images/prbc_1324.png" alt="p2sh-p2wsh step 5">
</div>
<div class="title">Figure 40. p2sh-p2wsh step 5</div>
</div>
<div class="paragraph">
<p>The 32-byte hash is an element, so it is pushed to the stack (<a href="#p2sh_p2wsh_step_6">p2sh-p2wsh step 6</a>).</p>
</div>
<div id="p2sh_p2wsh_step_6" class="imageblock">
<div class="content">
<img src="images/prbc_1325.png" alt="p2sh-p2wsh step 6">
</div>
<div class="title">Figure 41. p2sh-p2wsh step 6</div>
</div>
<div class="paragraph">
<p>At this point, pre-Segwit nodes will mark this input as valid, as they are unaware of the Segwit validation rules.
However, post-Segwit nodes will recognize the special script sequence for p2wsh.
The witness field (<a href="#p2sh_p2wsh_witness">p2sh-p2wsh witness</a>) contains the WitnessScript (<a href="#p2sh_p2wsh_witness_script">p2sh-p2wsh WitnessScript</a>). The sha256 of the WitnessScript is checked against the 32-byte hash, and if they&#8217;re equal the WitnessScript is interpreted as script commands and put into the command set (<a href="#p2sh_p2wsh_step_7">p2sh-p2wsh step 7</a>).</p>
</div>
<div id="p2sh_p2wsh_witness" class="imageblock">
<div class="content">
<img src="images/prbc_1342.png" alt="p2sh-p2wsh witness">
</div>
<div class="title">Figure 42. p2sh-p2wsh witness</div>
</div>
<div id="p2sh_p2wsh_witness_script" class="imageblock">
<div class="content">
<img src="images/prbc_1327.png" alt="p2wsh WitnessScript">
</div>
<div class="title">Figure 43. p2sh-p2wsh WitnessScript</div>
</div>
<div id="p2sh_p2wsh_step_7" class="imageblock">
<div class="content">
<img src="images/prbc_1328.png" alt="p2sh-p2wsh step 7">
</div>
<div class="title">Figure 44. p2sh-p2wsh step 7</div>
</div>
<div class="paragraph">
<p>As you can see, this is a 2-of-3 multisig as in <a href="#chapter_p2sh">[chapter_p2sh]</a>.
If the signatures are valid, we end like <a href="#p2sh_p2wsh_end">p2sh-p2wsh end</a>.</p>
</div>
<div id="p2sh_p2wsh_end" class="imageblock">
<div class="content">
<img src="images/prbc_1330.png" alt="p2sh-p2wsh end">
</div>
<div class="title">Figure 45. p2sh-p2wsh end</div>
</div>
<div class="paragraph">
<p>This makes p2wsh backward compatible, allowing older wallets to send to p2sh ScriptPubKeys that they can handle.</p>
</div>
</div>
<div class="sect2">
<h3 id="_coding_p2wsh_and_p2sh_p2wsh">Coding p2wsh and p2sh-p2wsh</h3>
<div class="paragraph">
<p>The parsing and serialization are exactly the same as before.
The main changes have to do with <code>verify_input</code> in <em>tx.py</em> and <code>evaluate</code> in <em>script.py</em>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-python" data-lang="python">class Tx:
...
    def verify_input(self, input_index):
        tx_in = self.tx_ins[input_index]
        script_pubkey = tx_in.script_pubkey(testnet=self.testnet)
        if script_pubkey.is_p2sh_script_pubkey():
            command = tx_in.script_sig.commands[-1]
            raw_redeem = int_to_little_endian(len(command), 1) + command
            redeem_script = Script.parse(BytesIO(raw_redeem))
            if redeem_script.is_p2wpkh_script_pubkey():
                z = self.sig_hash_bip143(input_index, redeem_script)
                witness = tx_in.witness
            elif redeem_script.is_p2wsh_script_pubkey():  # <b class="conum">(1)</b>
                command = tx_in.witness[-1]
                raw_witness = encode_varint(len(command)) + command
                witness_script = Script.parse(BytesIO(raw_witness))
                z = self.sig_hash_bip143(input_index,
                                         witness_script=witness_script)
                witness = tx_in.witness
            else:
                z = self.sig_hash(input_index, redeem_script)
                witness = None
        else:
            if script_pubkey.is_p2wpkh_script_pubkey():
                z = self.sig_hash_bip143(input_index)
                witness = tx_in.witness
            elif script_pubkey.is_p2wsh_script_pubkey():  # <b class="conum">(2)</b>
                command = tx_in.witness[-1]
                raw_witness = encode_varint(len(command)) + command
                witness_script = Script.parse(BytesIO(raw_witness))
                z = self.sig_hash_bip143(input_index,
                                         witness_script=witness_script)
                witness = tx_in.witness
            else:
                z = self.sig_hash(input_index)
                witness = None
        combined_script = tx_in.script_sig + tx_in.script_pubkey(self.testnet)
        return combined_script.evaluate(z, witness)</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>This takes care of p2sh-p2wsh.</p>
</li>
<li>
<p>This takes care of p2wsh.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Next, we code a way to identify p2wsh in <em>script.py</em>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-python" data-lang="python">def p2wsh_script(h256):
    '''Takes a hash160 and returns the p2wsh ScriptPubKey'''
    return Script([0x00, h256])  # <b class="conum">(1)</b>
...
class Script:
...
    def is_p2wsh_script_pubkey(self):
        return len(self.cmds) == 2 and self.cmds[0] == 0x00 \
            and type(self.cmds[1]) == bytes and len(self.cmds[1]) == 32</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p><code>OP_0</code> <em>&lt;32-byte script&gt;</em> is what we expect.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Last, we handle the special rule for p2wsh:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-python" data-lang="python">class Script:
...
    def evaluate(self, z, witness):
    ...
        while len(commands) &gt; 0:
        ...
	   else:
                stack.append(command)
    	        ...
                if len(stack) == 2 and stack[0] == b'' and len(stack[1]) == 32:
                    s256 = stack.pop()  # <b class="conum">(1)</b>
                    stack.pop()  # <b class="conum">(2)</b>
                    cmds.extend(witness[:-1])  # <b class="conum">(3)</b>
                    witness_script = witness[-1]  # <b class="conum">(4)</b>
                    if s256 != sha256(witness_script):  # <b class="conum">(5)</b>
                        print('bad sha256 {} vs {}'.format
                            (s256.hex(), sha256(witness_script).hex()))
                        return False
                    stream = BytesIO(encode_varint(len(witness_script)) 
                        + witness_script)
                    witness_script_cmds = Script.parse(stream).cmds  # <b class="conum">(6)</b>
                    cmds.extend(witness_script_cmds)</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>The top element is the sha256 hash of the WitnessScript.</p>
</li>
<li>
<p>The second element is the witness version, 0.</p>
</li>
<li>
<p>Everything but the WitnessScript is added to the command set.</p>
</li>
<li>
<p>The WitnessScript is the last item of the witness field.</p>
</li>
<li>
<p>The WitnessScript must hash to the sha256 that was in the stack.</p>
</li>
<li>
<p>We parse the WitnessScript and add it to the command set.</p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_other_improvements">Other Improvements</h3>
<div class="paragraph">
<p>Segwit also fixes the quadratic hashing problem through a different calculation of the signature hash.
A lot of the calculations for the signature hash, <em>z</em>, can be reused instead of requiring a new hash256 hash for each input.
The signature hash calculation is detailed in BIP0143 and can be seen in <em>code-ch13/tx.py</em>.</p>
</div>
<div class="paragraph">
<p>Another improvement is that by policy, uncompressed SEC pubkeys are now forbidden; only compressed SEC pubkeys are used for Segwit, saving space.</p>
</div>
</div>
<div class="sect2">
<h3 id="_conclusion">Conclusion</h3>
<div class="paragraph">
<p>The chapter covered the details of Segwit as a taste of what&#8217;s now possible.
<a href="#chapter_advanced">[chapter_advanced]</a> discusses the next steps that you can take on your Bitcoin developer journey.</p>
</div>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Last updated 2021-11-22 19:07:17 -0600
</div>
</div>
</body>
</html>