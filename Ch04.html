<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.12">
<title>Serialization</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700">
<style>
/* Asciidoctor default stylesheet | MIT License | https://asciidoctor.org */
/* Uncomment @import statement to use as custom stylesheet */
/*@import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700";*/
article,aside,details,figcaption,figure,footer,header,hgroup,main,nav,section{display:block}
audio,video{display:inline-block}
audio:not([controls]){display:none;height:0}
html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}
a{background:none}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
abbr[title]{border-bottom:1px dotted}
b,strong{font-weight:bold}
dfn{font-style:italic}
hr{-moz-box-sizing:content-box;box-sizing:content-box;height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type="button"],input[type="reset"],input[type="submit"]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type="checkbox"],input[type="radio"]{box-sizing:border-box;padding:0}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,*::before,*::after{-moz-box-sizing:border-box;-webkit-box-sizing:border-box;box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;font-weight:400;font-style:normal;line-height:1;position:relative;cursor:auto;tab-size:4;word-wrap:anywhere;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
img,object,svg{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:0}
p{font-family:inherit;font-weight:400;font-size:1em;line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #dddddf;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em;height:0}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{font-size:1em;line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0;font-size:1em}
ul.square li ul,ul.circle li ul,ul.disc li ul{list-style:inherit}
ul.square{list-style-type:square}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
abbr,acronym{text-transform:uppercase;font-size:90%;color:rgba(0,0,0,.8);border-bottom:1px dotted #ddd;cursor:help}
abbr{text-transform:none}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote cite{display:block;font-size:.9375em;color:rgba(0,0,0,.6)}
blockquote cite::before{content:"\2014 \0020"}
blockquote cite a,blockquote cite a:visited{color:rgba(0,0,0,.6)}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}
table{background:#fff;margin-bottom:1.25em;border:solid 1px #dedede;word-wrap:normal}
table thead,table tfoot{background:#f7f8f7}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt{background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{line-height:1.6}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.center{margin-left:auto;margin-right:auto}
.stretch{width:100%}
.clearfix::before,.clearfix::after,.float-group::before,.float-group::after{content:" ";display:table}
.clearfix::after,.float-group::after{clear:both}
:not(pre).nobreak{word-wrap:normal}
:not(pre).nowrap{white-space:nowrap}
:not(pre).pre-wrap{white-space:pre-wrap}
:not(pre):not([class^=L])>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background:#f7f7f8;-webkit-border-radius:4px;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed}
pre{color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;line-height:1.45;text-rendering:optimizeSpeed}
pre code,pre pre{color:inherit;font-size:inherit;line-height:inherit}
pre>code{display:block}
pre.nowrap,pre.nowrap pre{white-space:pre;word-wrap:normal}
em em{font-style:normal}
strong strong{font-weight:400}
.keyseq{color:rgba(51,51,51,.8)}
kbd{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;display:inline-block;color:rgba(0,0,0,.8);font-size:.65em;line-height:1.45;background:#f7f7f7;border:1px solid #ccc;-webkit-border-radius:3px;border-radius:3px;-webkit-box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em white inset;box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em #fff inset;margin:0 .15em;padding:.2em .5em;vertical-align:middle;position:relative;top:-.1em;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menuref{color:#000}
.menuseq b:not(.caret),.menuref{font-weight:inherit}
.menuseq{word-spacing:-.02em}
.menuseq b.caret{font-size:1.25em;line-height:.8}
.menuseq i.caret{font-weight:bold;text-align:center;width:.45em}
b.button::before,b.button::after{position:relative;top:-1px;font-weight:400}
b.button::before{content:"[";padding:0 3px 0 2px}
b.button::after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin-left:auto;margin-right:auto;margin-top:0;margin-bottom:0;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header::before,#header::after,#content::before,#content::after,#footnotes::before,#footnotes::after,#footer::before,#footer::after{content:" ";display:table}
#header::after,#content::after,#footnotes::after,#footer::after{clear:both}
#content{margin-top:1.25em}
#content::before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #dddddf}
#header>h1:only-child,body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #dddddf;padding-bottom:8px}
#header .details{border-bottom:1px solid #dddddf;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:-ms-flexbox;display:-webkit-flex;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span::before{content:"\00a0\2013\00a0"}
#header .details br+span.author::before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark::before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber::after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #dddddf;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #e7e7e9;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc li{line-height:1.3334;margin-top:.3334em}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
#toc.toc2{margin-top:0!important;background:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #e7e7e9;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #e7e7e9;left:auto;right:0}}
@media screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}
#content #toc{border-style:solid;border-width:1px;border-color:#e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;-webkit-border-radius:4px;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:none;background:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:rgba(255,255,255,.8);line-height:1.44}
#content{margin-bottom:.625em}
.sect1{padding-bottom:.625em}
@media screen and (min-width:768px){#content{margin-bottom:1.25em}
.sect1{padding-bottom:1.25em}}
.sect1:last-child{padding-bottom:0}
.sect1+.sect1{border-top:1px solid #e7e7e9}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor::before,h2>a.anchor::before,h3>a.anchor::before,#toctitle>a.anchor::before,.sidebarblock>.content>.title>a.anchor::before,h4>a.anchor::before,h5>a.anchor::before,h6>a.anchor::before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
details,.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
details>summary:first-of-type{cursor:pointer;display:list-item;outline:none;margin-bottom:.75em}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock.fit-content>caption.title{white-space:nowrap;width:0}
.paragraph.lead>p,#preamble>.sectionbody>[class="paragraph"]:first-of-type p{font-size:1.21875em;line-height:1.6;color:rgba(0,0,0,.85)}
table.tableblock #preamble>.sectionbody>[class="paragraph"]:first-of-type p{font-size:inherit}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #dddddf;color:rgba(0,0,0,.6);word-wrap:anywhere}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border-style:solid;border-width:1px;border-color:#e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;-webkit-border-radius:4px;border-radius:4px}
.exampleblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child{margin-bottom:0}
.sidebarblock{border-style:solid;border-width:1px;border-color:#dbdbd6;margin-bottom:1.25em;padding:1.25em;background:#f3f3f2;-webkit-border-radius:4px;border-radius:4px}
.sidebarblock>:first-child{margin-top:0}
.sidebarblock>:last-child{margin-bottom:0}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock>.content>pre{-webkit-border-radius:4px;border-radius:4px;overflow-x:auto;padding:1em;font-size:.8125em}
@media screen and (min-width:768px){.literalblock pre,.listingblock>.content>pre{font-size:.90625em}}
@media screen and (min-width:1280px){.literalblock pre,.listingblock>.content>pre{font-size:1em}}
.literalblock pre,.listingblock>.content>pre:not(.highlight),.listingblock>.content>pre[class="highlight"],.listingblock>.content>pre[class^="highlight "]{background:#f7f7f8}
.literalblock.output pre{color:#f7f7f8;background:rgba(0,0,0,.9)}
.listingblock>.content{position:relative}
.listingblock code[data-lang]::before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:inherit;opacity:.5}
.listingblock:hover code[data-lang]::before{display:block}
.listingblock.terminal pre .command::before{content:attr(data-prompt);padding-right:.5em;color:inherit;opacity:.5}
.listingblock.terminal pre .command:not([data-prompt])::before{content:"$"}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;-webkit-border-radius:4px;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.prettyprint{background:#f7f7f8}
pre.prettyprint .linenums{line-height:1.45;margin-left:2em}
pre.prettyprint li{background:none;list-style-type:inherit;padding-left:0}
pre.prettyprint li code[data-lang]::before{opacity:1}
pre.prettyprint li:not(:first-child) code[data-lang]::before{display:none}
table.linenotable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.linenotable td[class]{color:inherit;vertical-align:top;padding:0;line-height:inherit;white-space:normal}
table.linenotable td.code{padding-left:.75em}
table.linenotable td.linenos{border-right:1px solid currentColor;opacity:.35;padding-right:.5em}
pre.pygments .lineno{border-right:1px solid currentColor;opacity:.35;display:inline-block;margin-right:.75em}
pre.pygments .lineno::before{content:"";margin-right:-.125em}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock:not(.excerpt)>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote::before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.75em;margin-right:.5ex;text-align:right}
.verseblock{margin:0 1em 1.25em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.025em;color:rgba(0,0,0,.6)}
.quoteblock.abstract blockquote::before,.quoteblock.excerpt blockquote::before,.quoteblock .quoteblock blockquote::before{display:none}
.quoteblock.abstract blockquote,.quoteblock.abstract p,.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{line-height:1.6;word-spacing:0}
.quoteblock.abstract{margin:0 1em 1.25em;display:block}
.quoteblock.abstract>.title{margin:0 0 .375em;font-size:1.15em;text-align:center}
.quoteblock.excerpt>blockquote,.quoteblock .quoteblock{padding:0 0 .25em 1em;border-left:.25em solid #dddddf}
.quoteblock.excerpt,.quoteblock .quoteblock{margin-left:0}
.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{color:inherit;font-size:1.0625rem}
.quoteblock.excerpt .attribution,.quoteblock .quoteblock .attribution{color:inherit;text-align:left;margin-right:0}
p.tableblock:last-child{margin-bottom:0}
td.tableblock>.content{margin-bottom:1.25em;word-wrap:anywhere}
td.tableblock>.content>:last-child{margin-bottom:-1.25em}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all>*>tr>*{border-width:1px}
table.grid-cols>*>tr>*{border-width:0 1px}
table.grid-rows>*>tr>*{border-width:1px 0}
table.frame-all{border-width:1px}
table.frame-ends{border-width:1px 0}
table.frame-sides{border-width:0 1px}
table.frame-none>colgroup+*>:first-child>*,table.frame-sides>colgroup+*>:first-child>*{border-top-width:0}
table.frame-none>:last-child>:last-child>*,table.frame-sides>:last-child>:last-child>*{border-bottom-width:0}
table.frame-none>*>tr>:first-child,table.frame-ends>*>tr>:first-child{border-left-width:0}
table.frame-none>*>tr>:last-child,table.frame-ends>*>tr>:last-child{border-right-width:0}
table.stripes-all tr,table.stripes-odd tr:nth-of-type(odd),table.stripes-even tr:nth-of-type(even),table.stripes-hover tr:hover{background:#f8f8f7}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
ol>li p,ul>li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.checklist,ul.none,ol.none,ul.no-bullet,ol.no-bullet,ol.unnumbered,ul.unstyled,ol.unstyled{list-style-type:none}
ul.no-bullet,ol.no-bullet,ol.unnumbered{margin-left:.625em}
ul.unstyled,ol.unstyled{margin-left:0}
ul.checklist{margin-left:.625em}
ul.checklist li>p:first-child>.fa-square-o:first-child,ul.checklist li>p:first-child>.fa-check-square-o:first-child{width:1.25em;font-size:.8em;position:relative;bottom:.125em}
ul.checklist li>p:first-child>input[type="checkbox"]:first-child{margin-right:.25em}
ul.inline{display:-ms-flexbox;display:-webkit-box;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap;list-style:none;margin:0 0 .625em -1.25em}
ul.inline>li{margin-left:1.25em}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1,td.hdlist2{vertical-align:top;padding:0 .625em}
td.hdlist1{font-weight:bold;padding-bottom:1.25em}
td.hdlist2{word-wrap:anywhere}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist td:not([class]):first-child{padding:.4em .75em 0;line-height:1;vertical-align:top}
.colist td:not([class]):first-child img{max-width:none}
.colist td:not([class]):last-child{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:solid 4px #fff;-webkit-box-shadow:0 0 0 1px #ddd;box-shadow:0 0 0 1px #ddd}
.imageblock.left{margin:.25em .625em 1.25em 0}
.imageblock.right{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none;display:inline-block}
a.image object{pointer-events:none}
sup.footnote,sup.footnoteref{font-size:.875em;position:static;vertical-align:super}
sup.footnote a,sup.footnoteref a{text-decoration:none}
sup.footnote a:active,sup.footnoteref a:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em;border-width:1px 0 0}
#footnotes .footnote{padding:0 .375em 0 .225em;line-height:1.3334;font-size:.875em;margin-left:1.2em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none;margin-left:-1.05em}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
.gist .file-data>table{border:0;background:#fff;width:100%;margin-bottom:0}
.gist .file-data>table td.line-data{width:99%}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background:#00fafa}
.black{color:#000}
.black-background{background:#000}
.blue{color:#0000bf}
.blue-background{background:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background:#fa00fa}
.gray{color:#606060}
.gray-background{background:#7d7d7d}
.green{color:#006000}
.green-background{background:#007d00}
.lime{color:#00bf00}
.lime-background{background:#00fa00}
.maroon{color:#600000}
.maroon-background{background:#7d0000}
.navy{color:#000060}
.navy-background{background:#00007d}
.olive{color:#606000}
.olive-background{background:#7d7d00}
.purple{color:#600060}
.purple-background{background:#7d007d}
.red{color:#bf0000}
.red-background{background:#fa0000}
.silver{color:#909090}
.silver-background{background:#bcbcbc}
.teal{color:#006060}
.teal-background{background:#007d7d}
.white{color:#bfbfbf}
.white-background{background:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background:#fafa00}
span.icon>.fa{cursor:default}
a span.icon>.fa{cursor:inherit}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note::before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip::before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning::before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution::before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important::before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background:rgba(0,0,0,.8);-webkit-border-radius:50%;border-radius:50%;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]::after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
dt,th.tableblock,td.content,div.footnote{text-rendering:optimizeLegibility}
h1,h2,p,td.content,span.alt{letter-spacing:-.01em}
p strong,td.content strong,div.footnote strong{letter-spacing:-.005em}
p,blockquote,dt,td.content,span.alt{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background:#fffef7;border-color:#e0e0dc;-webkit-box-shadow:0 1px 4px #e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@page{margin:1.25cm .75cm}
@media print{*{-webkit-box-shadow:none!important;box-shadow:none!important;text-shadow:none!important}
html{font-size:80%}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare)::after,a[href^="https:"]:not(.bare)::after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]::after{content:" (" attr(title) ")"}
pre,blockquote,tr,img,object,svg{page-break-inside:avoid}
thead{display:table-header-group}
svg{max-width:100%}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#header,#content,#footnotes,#footer{max-width:none}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #dddddf!important;padding-bottom:0!important}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span::before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]::before{display:block}
#footer{padding:0 .9375em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
@media print,amzn-kf8{#header>h1:first-child{margin-top:1.25rem}
.sect1{padding:0!important}
.sect1+.sect1{border:0}
#footer{background:none}
#footer-text{color:rgba(0,0,0,.6);font-size:.9em}}
@media amzn-kf8{#header,#content,#footnotes,#footer{padding:0}}
</style>
</head>
<body class="article">
<div id="header">
</div>
<div id="content">
<div class="sect1">
<h2 id="chapter_serialization">Serialization</h2>
<div class="sectionbody">
<div class="paragraph lead">
<p>We&#8217;ve created a lot of classes thus far, including <code>PrivateKey</code>, <code>S256Point</code>, and <code>Signature</code>.
We now need to start thinking about how to transmit these objects to other computers on the network, or even to disk.
This is where serialization comes into play.
We want to communicate or store a <code>S256Point</code> or a <code>Signature</code> or a <code>PrivateKey</code>.
Ideally, we want to do this efficiently, for reasons we&#8217;ll see in <a href="#chapter_networking">[chapter_networking]</a>.</p>
</div>
<div class="sect2">
<h3 id="_uncompressed_sec_format">Uncompressed SEC Format</h3>
<div class="paragraph">
<p>We&#8217;ll start with the <code>S256Point</code> class, which is the public key class.
Recall that the public key in elliptic curve cryptography is really a coordinate in the form of (<em>x</em>,<em>y</em>).
How can we serialize this data?</p>
</div>
<div class="paragraph">
<p>It turns out there&#8217;s already a standard for serializing ECDSA public keys, called <em>Standards for Efficient Cryptography</em> (SEC)—and as the word "Efficient" in the name suggests, it has minimal overhead.
There are two forms of SEC format that we need to be concerned with: uncompressed and compressed. We&#8217;ll begin with the former, and look at the compressed format in the next section.</p>
</div>
<div class="paragraph">
<p>Here is how the uncompressed SEC format for a given point <em>P</em> = (<em>x</em>,<em>y</em>) is generated:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Start with the prefix byte, which is <code>0x04</code>.</p>
</li>
<li>
<p>Next, append the <em>x</em> coordinate in 32 bytes as a big-endian integer.</p>
</li>
<li>
<p>Next, append the <em>y</em> coordinate in 32 bytes as a big-endian integer.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>The uncompressed SEC format is shown in <a href="#uncompressed_sec_format">Uncompressed SEC format</a>.</p>
</div>
<div id="uncompressed_sec_format" class="imageblock">
<div class="content">
<img src="images/prbc_0401.png" alt="Uncompressed SEC format">
</div>
<div class="title">Figure 1. Uncompressed SEC format</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="title">Big- and Little-Endian</div>
<div class="paragraph">
<p>The motivation for big- and little-endian encodings is storing a number on disk.
A number under 256 is easy enough to encode, as a single byte (2<sup>8</sup>) is enough to hold it.
When it&#8217;s bigger than 256, how do we serialize the number to bytes?</p>
</div>
<div class="paragraph">
<p>Arabic numerals are read left to right.
A number like 123 is 100 + 20 + 3 and not 1 + 20 + 300.
This is what we call big-endian, because the "big end" starts first.</p>
</div>
<div class="paragraph">
<p>Computers can sometimes be more efficient using the opposite order, or little-endian—that is, starting with the little end first.</p>
</div>
<div class="paragraph">
<p>Since computers work in bytes, which have 8 bits, we have to think in base 256.
This means that a number like 500 looks like <code>01f4</code> in big-endian—that is, 500 = 1 &#xd7; 256 + 244 (<code>f4</code> in hexadecimal).
The same number looks like <code>f401</code> in little-endian.</p>
</div>
<div class="paragraph">
<p>Unfortunately, some serializations in Bitcoin (like the SEC format <em>x</em> and <em>y</em> coordinates) are big-endian, while others (like the transaction version number in <a href="#chapter_tx_parsing">[chapter_tx_parsing]</a>) are little-endian.
This book will let you know which ones are big- versus little-endian.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Creating the uncompressed SEC format serialization is pretty straightforward.
The trickiest part is converting a 256-bit number into 32 bytes, big-endian.
Here&#8217;s how this is done in code:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-python" data-lang="python">class S256Point(Point):
...
    def sec(self):
        '''returns the binary version of the SEC format'''
	return b'\x04' + self.x.num.to_bytes(32, 'big') \
            + self.y.num.to_bytes(32, 'big')  # <b class="conum">(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>In Python 3, you can convert a number to bytes using the <code>to_bytes</code> method.
The first argument is how many bytes it should take up and the second argument is the endianness (see the preceding note).</p>
</li>
</ol>
</div>
<div class="sect3">
<h4 id="_exercise_1">Exercise 1</h4>
<div class="paragraph">
<p>Find the uncompressed SEC format for the public key where the private key secrets are:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>5,000</p>
</li>
<li>
<p>2,018<sup>5</sup></p>
</li>
<li>
<p>0xdeadbeef12345</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_compressed_sec_format">Compressed SEC Format</h3>
<div class="paragraph">
<p>Recall that for any <em>x</em> coordinate, there are at most two <em>y</em> coordinates due to the <em>y</em><sup>2</sup> term in the elliptic curve equation (<a href="#the_two_possible_values_for_y_are_where_this_vertical_line_intersects_the_curve">The two possible values for y are where this vertical line intersects the curve</a>).</p>
</div>
<div id="the_two_possible_values_for_y_are_where_this_vertical_line_intersects_the_curve" class="imageblock width-90">
<div class="content">
<img src="images/prbc_0212.png" alt="Elliptic Curve Vertical Line">
</div>
<div class="title">Figure 2. The two possible values for y are where this vertical line intersects the curve</div>
</div>
<div class="paragraph">
<p>It turns out that even over a finite field, we have the same symmetry.</p>
</div>
<div class="paragraph">
<p>This is because for any (<em>x</em>,<em>y</em>) that satisfies <em>y</em><sup>2</sup> = <em>x</em><sup>3</sup> + <em>ax</em> + <em>b</em>, (<em>x</em>,–<em>y</em>) also satisfies the equation.
Furthermore, in a finite field, –<em>y</em> % <em>p</em> = (<em>p</em> – <em>y</em>) % <em>p</em>.
Or, more accurately, if (<em>x</em>,<em>y</em>) satisfies the elliptic curve equation, (<em>x</em>,<em>p</em> – <em>y</em>) also satisfies the equation.
These are the only two solutions for a given <em>x</em>, as shown, so if we know <em>x</em>, we know the <em>y</em> coordinate has to be either <em>y</em> or <em>p</em> – <em>y</em>.</p>
</div>
<div class="paragraph">
<p>Since <em>p</em> is a prime number greater than 2, we know that <em>p</em> is odd.
Thus, if <em>y</em> is even, <span class="keep-together"><em>p</em> – <em>y</em></span> (odd minus even) will be odd.
If <em>y</em> is odd, <em>p</em> – <em>y</em> will be even.
In other words, between <em>y</em> and <em>p</em> – <em>y</em>, exactly one will be even and one will be odd.
This is something we can use to our advantage to shorten the uncompressed SEC format: we can provide the <em>x</em> coordinate and the evenness of the <em>y</em> coordinate.
We call this the <em>compressed SEC format</em> because of how the <em>y</em> coordinate is compressed into a single byte (namely, whether it&#8217;s even or odd).</p>
</div>
<div class="paragraph">
<p>Here is the serialization of the compressed SEC format for a given point <em>P</em> = (<em>x</em>,<em>y</em>):</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Start with the prefix byte.
If <em>y</em> is even, it&#8217;s <code>0x02</code>; otherwise, it&#8217;s <code>0x03</code>.</p>
</li>
<li>
<p>Next, append the <em>x</em> coordinate in 32 bytes as a big-endian integer.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>The compressed SEC format is shown in <a href="#compressed_sec_format">Compressed SEC format</a>.</p>
</div>
<div id="compressed_sec_format" class="imageblock">
<div class="content">
<img src="images/prbc_0403.png" alt="Compressed SEC format">
</div>
<div class="title">Figure 3. Compressed SEC format</div>
</div>
<div class="paragraph">
<p>Again, the procedure is pretty straightforward.
We can update the <code>sec</code> method to handle compressed SEC keys:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-python" data-lang="python">class S256Point(Point):
...
    def sec(self, compressed=True):
        '''returns the binary version of the SEC format'''
        if compressed:
            if self.y.num % 2 == 0:
                return b'\x02' + self.x.num.to_bytes(32, 'big')
            else:
                return b'\x03' + self.x.num.to_bytes(32, 'big')
        else:
            return b'\x04' + self.x.num.to_bytes(32, 'big') + \
                self.y.num.to_bytes(32, 'big')</code></pre>
</div>
</div>
<div class="paragraph">
<p>The big advantage of the compressed SEC format is that it only takes up 33 bytes instead of 65 bytes.
This is a big savings when amortized over millions of transactions.</p>
</div>
<div class="paragraph">
<p>At this point, you may be wondering how you can analytically calculate <em>y</em> given the <em>x</em> coordinate.
This requires us to calculate a square root in a finite field.</p>
</div>
<div class="paragraph">
<p>Stated mathematically:</p>
</div>
<ul class="simplelist">
<li>Find <em>w</em> such that <em>w</em><sup>2</sup> = <em>v</em> when we know <em>v</em>.</li>
</ul>
<div class="paragraph">
<p>It turns out that if the finite field prime <em>p</em> % 4 = 3, we can do this rather easily.
Here&#8217;s how.</p>
</div>
<div class="paragraph">
<p>First, we know:</p>
</div>
<ul class="simplelist">
<li><em>p</em> % 4 = 3</li>
</ul>
<div class="paragraph">
<p>which implies:</p>
</div>
<ul class="simplelist">
<li>(<em>p</em> + 1) % 4 = 0</li>
</ul>
<div class="paragraph">
<p>That is, (<em>p</em> + 1)/4 is an integer.</p>
</div>
<div class="paragraph">
<p>By definition:</p>
</div>
<ul class="simplelist">
<li><em>w</em><sup>2</sup> = <em>v</em></li>
</ul>
<div class="paragraph">
<p>We are looking for a formula to calculate <em>w</em>.
From Fermat&#8217;s little theorem:</p>
</div>
<ul class="simplelist">
<li><em>w</em><sup><em>p</em>–1</sup> % <em>p</em> = 1</li>
</ul>
<div class="paragraph">
<p>which means:</p>
</div>
<ul class="simplelist">
<li><em>w</em><sup>2</sup> = <em>w</em><sup>2</sup> ⋅ 1 = <em>w</em><sup>2</sup> ⋅ <em>w</em><sup><em>p</em>–1</sup> = <em>w</em><sup>(<em>p</em>+1)</sup></li>
</ul>
<div class="paragraph">
<p>Since <em>p</em> is odd (recall <em>p</em> is prime), we know we can divide (<em>p</em>+1) by 2 and still get an integer, implying:</p>
</div>
<ul class="simplelist">
<li><em>w</em> = <em>w</em><sup>(<em>p</em>+1)/2</sup></li>
</ul>
<div class="paragraph">
<p>Now we can use (<em>p</em>+1)/4 being an integer this way:</p>
</div>
<ul class="simplelist">
<li><em>w</em> = <em>w</em><sup>(<em>p</em>+1)/2</sup> = <em>w</em><sup>2(<em>p</em>+1)/4</sup> = (<em>w</em><sup>2</sup>)<sup>(<em>p</em>+1)/4</sup> = <em>v</em><sup>(<em>p</em>+1)/4</sup></li>
</ul>
<div class="paragraph">
<p>So our formula for finding the square root becomes:</p>
</div>
<ul class="simplelist">
<li>if <em>w</em><sup>2</sup> = <em>v</em> and <em>p</em> % 4 = 3, <em>w</em> = <em>v</em><sup>(<em>p</em>+1)/4</sup></li>
</ul>
<div class="paragraph">
<p>It turns out that the <em>p</em> used in secp256k1 is such that <em>p</em> % 4 == 3, so we can use this formula:</p>
</div>
<ul class="simplelist">
<li><em>w</em><sup>2</sup> = <em>v</em></li>
<li><em>w</em> = <em>v</em><sup>(<em>p</em>+1)/4</sup></li>
</ul>
<div class="paragraph">
<p>That will be one of the two possible <em>w</em>'s; the other will be <em>p</em> – <em>w</em>.
This is due to taking the square root means that both the positive and negative will work.</p>
</div>
<div class="paragraph">
<p>We can add this as a general method in the S256Field class:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-python" data-lang="python">class S256Field(FieldElement):
...
    def sqrt(self):
        return self**((P + 1) // 4)</code></pre>
</div>
</div>
<div class="paragraph">
<p>When we get a serialized SEC pubkey, we can write a <code>parse</code> method to figure out which <em>y</em> we need:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-python" data-lang="python">class S256Point:
...
    @classmethod
    def parse(self, sec_bin):
        '''returns a Point object from a SEC binary (not hex)'''
        if sec_bin[0] == 4:  # <b class="conum">(1)</b>
            x = int.from_bytes(sec_bin[1:33], 'big')
            y = int.from_bytes(sec_bin[33:65], 'big')
            return S256Point(x=x, y=y)
        is_even = sec_bin[0] == 2  # <b class="conum">(2)</b>
        x = S256Field(int.from_bytes(sec_bin[1:], 'big'))
        # right side of the equation y^2 = x^3 + 7
        alpha = x**3 + S256Field(B)
        # solve for left side
        beta = alpha.sqrt()  # <b class="conum">(3)</b>
        if beta.num % 2 == 0:  # <b class="conum">(4)</b>
            even_beta = beta
            odd_beta = S256Field(P - beta.num)
        else:
            even_beta = S256Field(P - beta.num)
            odd_beta = beta
        if is_even:
            return S256Point(x, even_beta)
        else:
            return S256Point(x, odd_beta)</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>The uncompressed SEC format is pretty straightforward.</p>
</li>
<li>
<p>The evenness of the <em>y</em> coordinate is given in the first byte.</p>
</li>
<li>
<p>We take the square root of the right side of the elliptic curve equation to get <em>y</em>.</p>
</li>
<li>
<p>We determine evenness and return the correct point.</p>
</li>
</ol>
</div>
<div class="sect3">
<h4 id="_exercise_2">Exercise 2</h4>
<div class="paragraph">
<p>Find the compressed SEC format for the public key where the private key secrets are:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>5,001</p>
</li>
<li>
<p>2,019<sup>5</sup></p>
</li>
<li>
<p>0xdeadbeef54321</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_der_signatures">DER Signatures</h3>
<div class="paragraph">
<p>Another class that we need to learn to serialize is <code>Signature</code>.
Much like the SEC format, it needs to encode two different numbers, <code>r</code> and <code>s</code>.
Unfortunately, unlike <code>S256Point</code>, <code>Signature</code> cannot be compressed as <code>s</code> cannot be derived solely from <code>r</code>.</p>
</div>
<div class="paragraph">
<p>The standard for serializing signatures (and lots of other things, for that matter) is called Distinguished Encoding Rules (DER) format. DER format was used by Satoshi to serialize signatures.
This was most likely because the standard was already defined in 2008, was supported in the OpenSSL library (used in Bitcoin at the time), and was easy enough to adopt, rather than creating a new standard.</p>
</div>
<div class="paragraph">
<p>DER signature format is defined like this:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Start with the <code>0x30</code> byte.</p>
</li>
<li>
<p>Encode the length of the rest of the signature (usually <code>0x44</code> or <code>0x45</code>) and append.</p>
</li>
<li>
<p>Append the marker byte, <code>0x02</code>.</p>
</li>
<li>
<p>Encode <code>r</code> as a big-endian integer, but prepend it with the <code>0x00</code> byte if <code>r&#8217;s first byte &ge; `0x80</code>.
Prepend the resulting length to <code>r</code>.
Add this to the result.</p>
</li>
<li>
<p>Append the marker byte, <code>0x02</code>.</p>
</li>
<li>
<p>Encode <code>s</code> as a big-endian integer, but prepend with the <code>0x00</code> byte if <code>s&#8217;s first byte &ge; `0x80</code>.
Prepend the resulting length to <code>s</code>.
Add this to the result.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>The rules for #4 and #6 with the first byte starting with something greater than or equal to <code>0x80</code> are because DER is a general encoding and allows for negative numbers to be encoded.
The first bit being 1 means that the number is negative.
All numbers in an ECDSA signature are positive, so we have to prepend with <code>0x00</code> if the first bit is 1, which is equivalent to first byte &ge; <code>0x80</code>.</p>
</div>
<div class="paragraph">
<p>The DER format is shown in <a href="#der_format">DER format</a>.</p>
</div>
<div id="der_format" class="imageblock">
<div class="content">
<img src="images/prbc_0404.png" alt="DER format">
</div>
<div class="title">Figure 4. DER format</div>
</div>
<div class="paragraph">
<p>Because we know <code>r</code> is a 256-bit integer, <code>r</code> will be at most 32 bytes expressed as big-endian.
It&#8217;s also possible the first byte could be &ge; 0x80, so #4 can be at most 33 bytes.
However, if <code>r</code> is a relatively small number, it could be less than 32 bytes.
The same goes for <code>s</code> and #6.</p>
</div>
<div class="paragraph">
<p>Here&#8217;s how this is coded in Python:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-python" data-lang="python">class Signature:
...
    def der(self):
        rbin = self.r.to_bytes(32, byteorder='big')
        # remove all null bytes at the beginning
        rbin = rbin.lstrip(b'\x00')
        # if rbin has a high bit, add a \x00
        if rbin[0] &amp; 0x80:
            rbin = b'\x00' + rbin
        result = bytes([2, len(rbin)]) + rbin  # <b class="conum">(1)</b>
        sbin = self.s.to_bytes(32, byteorder='big')
        # remove all null bytes at the beginning
        sbin = sbin.lstrip(b'\x00')
        # if sbin has a high bit, add a \x00
        if sbin[0] &amp; 0x80:
            sbin = b'\x00' + sbin
        result += bytes([2, len(sbin)]) + sbin
        return bytes([0x30, len(result)]) + result</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>In Python 3, you can convert a list of numbers to the byte equivalents using <code>bytes([some_integer1, some_integer2])</code>.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Overall, this is an inefficient way to encode <code>r</code> and <code>s</code> as there are at least 6 bytes that aren&#8217;t strictly necessary.</p>
</div>
<div class="sect3">
<h4 id="_exercise_3">Exercise 3</h4>
<div class="paragraph">
<p>Find the DER format for a signature whose <code>r</code> and <code>s</code> values are:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>r = 0x37206a0610995c58074999cb9767b87af4c4978db68c06e8e6e81d282047a7c6

s = 0x8ca63759c1157ebeaec0d03cecca119fc9a75bf8e6d0fa65c841c8e2738cdaec</pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_base58">Base58</h3>
<div class="paragraph">
<p>In the early days of Bitcoin, bitcoins were assigned to public keys specified in SEC format (uncompressed) and then were redeemed using DER signatures.
For reasons we&#8217;ll get to in <a href="#chapter_script">[chapter_script]</a>, using this particular very simple script turned out to be both wasteful for storing unspent transaction outputs (UTXOs) and a little less secure than the scripts in more prominent use now.
For now, we&#8217;ll go through what addresses are and how they are encoded.</p>
</div>
<div class="sect3">
<h4 id="_transmitting_your_public_key">Transmitting Your Public Key</h4>
<div class="paragraph">
<p>In order for Alice to pay Bob, she has to know where to send the money.
This is true not just in Bitcoin, but for any method of payment.
Since Bitcoin is a digital bearer instrument, the address can be something like a public key in a public key cryptography scheme.
Unfortunately, SEC format, especially uncompressed, is a bit long (65 or 33 bytes).
Furthermore, the 65 or 33 bytes are in binary format—not something that&#8217;s easy to read, at least raw.</p>
</div>
<div class="paragraph">
<p>There are three major considerations.
The first is that the public key be readable (easy to hand-write and not too difficult to mistake, say, over the phone).
The second is that it&#8217;s short (not so long that it&#8217;s cumbersome).
The third is that it&#8217;s secure (so it&#8217;s harder to make mistakes).</p>
</div>
<div class="paragraph">
<p>So how do we get readability, compression, and security?
If we express the SEC format in hexadecimal (4 bits per character), it&#8217;s double the length (130 or 66 characters).
Can we do better?</p>
</div>
<div class="paragraph">
<p>We can use something like Base64, which can express 6 bits per character. This results in 87 characters for uncompressed SEC and 44 characters for compressed SEC.
Unfortunately, Base64 is prone to mistakes, as a lot of letters and numbers look similar (<code>0</code> and <code>O</code>, <code>l</code> and <code>I</code>, <code>-</code> and <code>_</code>).
If we remove these characters, we can achieve a result that has good readability and decent compression (around 5.86 bits per character).
Lastly, we can add a checksum at the end to ensure that mistakes are easy to detect.</p>
</div>
<div class="paragraph">
<p>This construction is called <em>Base58</em>.
Instead of hexadecimal (base 16) or Base64, we&#8217;re encoding numbers in Base58.</p>
</div>
<div class="paragraph">
<p>The actual mechanics of doing the Base58 encoding are as follows.</p>
</div>
<div class="paragraph">
<p>All numbers, uppercase letters, and lowercase letters are utilized, except for the aforementioned <code>0/O</code> and <code>l/I</code>.
That leaves us with 10 + 26 + 26 – 4 = 58.
Each of these characters represents a digit in Base58.
We can encode with a function that does exactly this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-python" data-lang="python">BASE58_ALPHABET = '123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz'
...
def encode_base58(s):
    count = 0
    for c in s:  # <b class="conum">(1)</b>
        if c == 0:
            count += 1
        else:
            break
    num = int.from_bytes(s, 'big')
    prefix = '1' * count
    result = ''
    while num &gt; 0:  # <b class="conum">(2)</b>
        num, mod = divmod(num, 58)
        result = BASE58_ALPHABET[mod] + result
    return prefix + result  # <b class="conum">(3)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>The purpose of this loop is to determine how many of the bytes at the front are 0 bytes.
We want to add them back at the end.</p>
</li>
<li>
<p>This is the loop that figures out what Base58 digit to use.</p>
</li>
<li>
<p>Finally, we prepend all the zeros that we counted at the front, because otherwise they wouldn&#8217;t show up as prefixed ones.
This annoyingly happens with pay-to-pubkey-hash (p2pkh); more on that in <a href="#chapter_script">[chapter_script]</a>.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>This function will take any bytes in Python 3 and convert them to Base58.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="title">Why Base58 Is on the Way Out</div>
<div class="paragraph">
<p>Base58 has been used for a long time, and while it does make it somewhat easier than something like Base64 to communicate, it&#8217;s not really that convenient.
Most people prefer to copy and paste the addresses, and if you&#8217;ve ever tried to communicate a Base58 address vocally, you know it can be a nightmare.</p>
</div>
<div class="paragraph">
<p>What&#8217;s much better is the new Bech32 standard, which is defined in BIP0173.
Bech32 uses a 32-character alphabet that&#8217;s just numbers and lowercase letters, except <code>1</code>, <code>b</code>, <code>i</code>, and <code>o</code>.
Thus far, it&#8217;s only used for Segwit (<a href="#chapter_segwit">[chapter_segwit]</a>).</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3 pagebreak-before">
<h4 id="_exercise_4">Exercise 4</h4>
<div class="paragraph">
<p>Convert the following hex values to binary and then to Base58:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>7c076ff316692a3d7eb3c3bb0f8b1488cf72e1afcd929e29307032997a838a3d</code></p>
</li>
<li>
<p><code>eff69ef2b1bd93a66ed5219add4fb51e11a840f404876325a1e8ffe0529a2c</code></p>
</li>
<li>
<p><code>c7207fee197d27c618aea621406f6bf5ef6fca38681d82b2f06fddbdce6feab6</code></p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_address_format">Address Format</h4>
<div class="paragraph">
<p>The 264 bits from compressed SEC format are still a bit too long, not to mention a bit less secure (see <a href="#chapter_script">[chapter_script]</a>).
To both shorten the address and increase security, we can use the ripemd160 hash.</p>
</div>
<div class="paragraph">
<p>By not using the SEC format directly, we can go from 33 bytes to 20 bytes, shortening the address significantly.
Here is how a Bitcoin address is created:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>For mainnet addresses, start with the prefix <code>0x00</code>, for testnet <code>0x6f</code>.</p>
</li>
<li>
<p>Take the SEC format (compressed or uncompressed) and do a sha256 operation followed by the ripemd160 hash operation, the combination of which is called a hash160 operation.</p>
</li>
<li>
<p>Combine the prefix from #1 and resulting hash from #2.</p>
</li>
<li>
<p>Do a hash256 of the result from #3 and get the first 4 bytes.</p>
</li>
<li>
<p>Take the combination of #3 and #4 and encode it in Base58.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>The result of step 4 of this process is called the <em>checksum</em>.
We can do steps 4 and 5 in one go this way:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-python" data-lang="python">def encode_base58_checksum(b):
    return encode_base58(b + hash256(b)[:4])</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="title">What Is Testnet?</div>
<div class="paragraph">
<p>Testnet is a parallel Bitcoin network that&#8217;s meant to be used by developers.
The coins on there are not worth anything and the proof-of-work required to find a block is relatively easy.
The mainnet chain as of this writing has around 550,000 blocks, while testnet has significantly more (around 1,450,000 blocks).</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>We can implement the hash160 operation in <em>helper.py</em>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-python" data-lang="python">def hash160(s):
    '''sha256 followed by ripemd160'''
    return hashlib.new('ripemd160', hashlib.sha256(s).digest()).digest()  # <b class="conum">(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Note that <code>hashlib.sha256(s).digest</code> does the sha256 and the wrapper around it does the ripemd160.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>We can also update <code>S256Point</code> with <code>hash160</code> and <code>address</code> methods:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-python" data-lang="python">class S256Point:
...
    def hash160(self, compressed=True):
        return hash160(self.sec(compressed))

    def address(self, compressed=True, testnet=False):
        '''Returns the address string'''
        h160 = self.hash160(compressed)
        if testnet:
            prefix = b'\x6f'
        else:
            prefix = b'\x00'
        return encode_base58_checksum(prefix + h160)</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_exercise_5">Exercise 5</h4>
<div class="paragraph">
<p>Find the addresses corresponding to the public keys whose private key secrets are:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>5002 (use uncompressed SEC on testnet)</p>
</li>
<li>
<p>2020<sup>5</sup> (use compressed SEC on testnet)</p>
</li>
<li>
<p>0x12345deadbeef (use compressed SEC on mainnet)</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_wif_format">WIF Format</h4>
<div class="paragraph">
<p>The private key in our case is a 256-bit number.
Generally, we are not going to need to serialize our secret that often, as it doesn&#8217;t get broadcast (that would be a bad idea!).
That said, there are instances where you may want to transfer your private key from one wallet to another—for example, from a paper wallet to a software wallet.</p>
</div>
<div class="paragraph">
<p>For this purpose, you can use Wallet Import Format (WIF).
WIF is a serialization of the private key that&#8217;s meant to be human-readable.
WIF uses the same Base58 encoding that addresses use.</p>
</div>
<div class="paragraph">
<p>Here is how the WIF format is created:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>For mainnet private keys, start with the prefix <code>0x80</code>, for testnet <code>0xef</code>.</p>
</li>
<li>
<p>Encode the secret in 32-byte big-endian.</p>
</li>
<li>
<p>If the SEC format used for the public key address was compressed, add a suffix of <code>0x01</code>.</p>
</li>
<li>
<p>Combine the prefix from #1, serialized secret from #2, and suffix from #3.</p>
</li>
<li>
<p>Do a hash256 of the result from #4 and get the first 4 bytes.</p>
</li>
<li>
<p>Take the combination of #4 and #5 and encode it in Base58.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>We can now create the <code>wif</code> method on the <code>PrivateKey</code> class:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-python" data-lang="python">class PrivateKey
...
    def wif(self, compressed=True, testnet=False):
        secret_bytes = self.secret.to_bytes(32, 'big')
        if testnet:
            prefix = b'\xef'
        else:
            prefix = b'\x80'
        if compressed:
            suffix = b'\x01'
        else:
            suffix = b''
        return encode_base58_checksum(prefix + secret_bytes + suffix)</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_exercise_6">Exercise 6</h4>
<div class="paragraph">
<p>Find the WIF for the private key whose secrets are:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>5003 (compressed, testnet)</p>
</li>
<li>
<p>2021<sup>5</sup> (uncompressed, testnet)</p>
</li>
<li>
<p>0x54321deadbeef (compressed, mainnet)</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_big_and_little_endian_redux">Big- and Little-Endian Redux</h3>
<div class="paragraph">
<p>It will be very useful to know how big- and little-endian are done in Python, as the next few chapters will be parsing and serializing numbers to and from big-/little-endian quite a bit.
In particular, Satoshi used a lot of little-endian for Bitcoin and unfortunately, there&#8217;s no easy-to-learn rule for where little-endian is used and where big-endian is used.
Recall that SEC format uses big-endian encoding, as do addresses and WIF.
From <a href="#chapter_tx_parsing">[chapter_tx_parsing]</a> onward, we will use little-endian encoding a lot more.
For this reason, we turn to the next two exercises.
The last exercise of this section is to create a testnet address for yourself.</p>
</div>
<div class="sect3">
<h4 id="_exercise_7">Exercise 7</h4>
<div class="paragraph">
<p>Write a function <code>little_endian_to_int</code> that takes Python bytes, interprets those bytes in little-endian, and returns the number.</p>
</div>
</div>
<div class="sect3">
<h4 id="_exercise_8">Exercise 8</h4>
<div class="paragraph">
<p>Write a function <code>int_to_little_endian</code> that does the reverse of the last exercise.</p>
</div>
</div>
<div class="sect3">
<h4 id="_exercise_9">Exercise 9</h4>
<div class="paragraph">
<p>Create a testnet address for yourself using a long secret that only you know. This is important as there are bots on testnet trying to steal testnet coins. Make sure you write this secret down somewhere! You will be using it later to sign transactions.</p>
</div>
<div class="paragraph">
<p>Go to a <a href="https://faucet.programmingbitcoin.com">testnet faucet</a> and send some testnet coins to that address (it should start with <code>m</code> or <code>n</code>, or else something is wrong).
If you succeeded, congrats!
You&#8217;re now the proud owner of some testnet coins!</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_conclusion">Conclusion</h3>
<div class="paragraph">
<p>In this chapter we learned how to serialize a lot of different structures that we created in the previous chapters.
We now turn to parsing and understanding transactions.</p>
</div>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Last updated 2021-11-22 19:07:17 -0600
</div>
</div>
</body>
</html>